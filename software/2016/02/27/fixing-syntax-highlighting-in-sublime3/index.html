<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fixing syntax highlighting issues in Sublime Text 3 &#8211; Mariano Gappa's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A straightforward guide to fixing syntax highlighting issues in Sublime Text 3 based on an actual issue I found.">
    <meta name="author" content="Mariano Gappa">
    <meta name="keywords" content="software">
    <link rel="canonical" href="https://marianogappa.github.io/software/2016/02/27/fixing-syntax-highlighting-in-sublime3/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Mariano Gappa's Blog" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202006071543" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Verifications -->
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Fixing syntax highlighting issues in Sublime Text 3">
    <meta property="og:description" content="Blog about Software Engineering and Music Production.">
    <meta property="og:url" content="https://marianogappa.github.io/software/2016/02/27/fixing-syntax-highlighting-in-sublime3/">
    <meta property="og:site_name" content="Mariano Gappa's Blog">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@MarianoGappa" />
    
    <meta name="twitter:title" content="Fixing syntax highlighting issues in Sublime Text 3" />
    <meta name="twitter:description" content="A straightforward guide to fixing syntax highlighting issues in Sublime Text 3 based on an actual issue I found." />
    <meta name="twitter:url" content="https://marianogappa.github.io/software/2016/02/27/fixing-syntax-highlighting-in-sublime3/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    <!-- Added by Mariano for syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58930438-4', 'auto');
  ga('send', 'pageview');

    </script>
</head>

<body class="site animated fade-in-down">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://marianogappa.github.io" class="site-title">Mariano Gappa's Blog</a>
      <nav class="site-nav">
        <!-- <a href="/cv/">CV</a> -->
<!-- <a href="/cv/cv.pdf">CV (pdf)</a> -->
<a href="/about/">About</a>
<!-- <a href="http://www.gappamixing.com">Mixing</a> -->

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/MarianoGappa"></a>
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/MarianoGappa"></a>
    
    
    
      <a class="fa fa-envelope" href="mailto:mariano.gappa@gmail.com"></a>
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Fixing syntax highlighting issues in Sublime Text 3</h1>
  
  <span class="post-meta">Feb 27, 2016</span><br>
  
  <span class="post-meta small">
  
    3 minute read
  
  </span>
</div>

<article class="post-content">
  <h2 id="introduction">Introduction</h2>

<p>My two main IDEs nowadays are <a href="https://www.jetbrains.com/idea/">Intellij Idea</a> and <a href="http://www.sublimetext.com/3">Sublime Text</a>. I basically like to use IDEA for strongly-typed languages and Sublime for weakly-typed languages. However, not long ago I found a bug on Sublime!</p>

<p>In version 5.4 of PHP, they <a href="http://php.net/manual/en/migration54.new-features.php">introduced a new syntax for arrays</a> that is reminiscent of the JSON notation:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="c1">// Old PHP Array syntax</span>
<span class="nv">$primes</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

<span class="c1">// New PHP Array syntax</span>
<span class="nv">$primes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">];</span>
</code></pre></div></div>

<p>Even though support for this new syntax within the Sublime codebase seems to be limited, oddly enough the colouring seems to be working properly. But I’ve found a case where it’s not. This case was probably not discovered because PHP people don’t like type-hinting!</p>

<p><img src="https://marianogappa.github.io/images/sublime-highlighting-before.png" alt="Highlighting Issue - Before" /></p>

<h2 id="now-heres-how-to-fix-it">Now, here’s how to fix it</h2>

<h3 id="context">Context</h3>

<ul>
  <li>
    <p>Ever wondered how Sublime does the syntax highlighting magic? The answer is: lots and lots of regexes. <a href="https://github.com/sublimehq/Packages/blob/master/PHP/PHP%20Source.sublime-syntax">This is the Language file for PHP</a>.</p>
  </li>
  <li>
    <p>The syntax highlighting feature uses the <a href="https://en.wikipedia.org/wiki/Oniguruma">Oniguruma regular expression library</a>.</p>
  </li>
  <li>
    <p>I recommend <a href="https://duckduckgo.com/?q=regex%20cheat%20sheet&amp;ia=cheatsheet&amp;iax=1">this DuckDuckGo regex cheatsheet</a> if you need a quick reference; it’s very good!</p>
  </li>
  <li>
    <p>Also, I recommend using <a href="http://rubular.com/">this online regex parser</a> when you get into the regex hacking part. It’s not my favourite one but it’s Ruby-based.</p>
  </li>
  <li>
    <p>Before we begin, you should skim through <a href="http://www.sublimetext.com/docs/3/syntax.html">this syntax guide</a> to familiarise yourself with the code we’ll be editing.</p>
  </li>
  <li>
    <p>Optionally, you might want to read <a href="http://stackoverflow.com/questions/25184605/cloning-a-sublime-text-3-highlighting-syntax-definition">this StackOverflow question</a>, as it was very insightful to understand the process.</p>
  </li>
</ul>

<h3 id="opening-the-language-file">Opening the language file</h3>

<p>The first thing we need to do is to open the Language package (in this case the PHP one). For this, we need to <a href="https://packagecontrol.io/packages/PackageResourceViewer">install the PackageResourceViewer plugin</a>.</p>

<p>Within Sublime’s Command Palette, type:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PackageResouceViewer: Open Resource
</code></pre></div></div>

<p>Then select the <code class="highlighter-rouge">PHP</code> resource and then finally <code class="highlighter-rouge">PHP.tmLanguage</code>.</p>

<p>You’ll find a very scary xml file. This is the annoying part. The guides recommend that you use <a href="https://packagecontrol.io/packages/AAAPackageDev">the AAAPackageDev package</a> to convert this xml to yaml, thus making it an order of magnitude easier to work with it. Unfortunately, it also says that it doesn’t convert perfectly, and this defeats the purpose of using it! I did something different.</p>

<h3 id="editing-the-language-file">Editing the language file</h3>

<p>This is the good news: you can edit this xml freely (please keep a copy of the original!), and the changes become instantly applied on PHP-syntax-enabled files upon save!</p>

<p>To make sense of the xml monster, just look up <a href="https://github.com/sublimehq/Packages/blob/master/PHP/PHP%20Source.sublime-syntax">the yaml file on the Github repository</a>. Make sure your Sublime and the GH code are for the same version; otherwise you’re not actually looking at the same code. Having the latest version of Sublime installed should be enough.
Looking at the yaml file makes it much easier to spot the place where you need to make the regex change.</p>

<p>After about half an hour of tinkering with regexes, I finally found a modification that worked for all cases I could think of. The problem that held me up was that I was trying to match either 2 groups (<code class="highlighter-rouge">array</code> and <code class="highlighter-rouge">(</code>) or 1 group (<code class="highlighter-rouge">[</code>), so I needed a wrapping group with two cases (i.e. <code class="highlighter-rouge">(a|b)</code>) that wasn’t actually capturing anything per se. The solution to this was <code class="highlighter-rouge">Passive (non-capturing) groups</code> (i.e. <code class="highlighter-rouge">(?:...)</code>). I mention this because you might need it; when you see how the classes are picked you’ll understand why.</p>

<p><img src="https://marianogappa.github.io/images/sublime-highlighting-after.png" alt="Highlighting Issue - Before" /></p>

<h2 id="fun-fact">Fun fact</h2>

<p>Before I came up with the idea of passive capturing groups I naturally thought of lookbehind assertions (i.e. <code class="highlighter-rouge">?&lt;=</code>). When it didn’t work I facepalmed: “of course! it’s xml; I have to escape it (i.e. <code class="highlighter-rouge">&amp;lt;</code>)”. When it didn’t work again I started googling. It seems the guys gave up on lookbehinds altogether for this reason so they just didn’t implement it, even though Oniguruma supports it :) Good idea though; lookbehinds are slow and not universally supported (<a href="http://stackoverflow.com/questions/24093540/why-doesnt-javascript-have-lookbehinds">Javascript</a>, <a href="http://stackoverflow.com/questions/7605615/regex-negative-lookbehind-in-ruby-doesnt-seem-to-work?rq=1">Ruby &lt; 1.9</a>).</p>

<h2 id="lastly">Lastly</h2>

<p>Once you are done and you’re sure it works properly, share your contribution to the World!
<a href="https://github.com/sublimehq/Packages/issues/98">This</a> was my Github issue for the PHP syntax fix.</p>

<p>Happy open sourcing!</p>


</article>


  <div class="share-page">
  

  <div class="share-links">
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Fixing syntax highlighting issues in Sublime Text 3&url=https://marianogappa.github.io/software/2016/02/27/fixing-syntax-highlighting-in-sublime3/" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    

    

    

    

    
      <a class="fa fa-reddit" href="http://reddit.com/submit?url=https://marianogappa.github.io/software/2016/02/27/fixing-syntax-highlighting-in-sublime3/&title=Fixing syntax highlighting issues in Sublime Text 3" rel="nofollow" target="_blank" title="Share on Reddit"></a>
    

    

    
      <a class = "fa fa-hacker-news" onclick="parent.postMessage('submit','*')" href="https://news.ycombinator.com/submitlink?u=https://marianogappa.github.io/software/2016/02/27/fixing-syntax-highlighting-in-sublime3/&t=Fixing syntax highlighting issues in Sublime Text 3" rel="nofollow" target="_blank" title="Share on Hacker News"></a>
    


  </div>
</div>






  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname  = 'marianogappasblog';
    var disqus_identifier = '/software/2016/02/27/fixing-syntax-highlighting-in-sublime3';
    var disqus_title      = '';

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




      </div>
    </div>
  </div>

  
</body>
</html>
