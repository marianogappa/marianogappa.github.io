<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mariano Gappa's Blog</title>
<link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/chroma.css><link rel=icon href=/favicon.ico></head><body><header class=header-flex><div class=site-title><a href=/>Mariano Gappa's Blog</a></div><nav><ul><li><a href=/about/>About</a></li></ul></nav></header><main class=container><article class=post><h1 class=post-title>10 Gotchas for building a universal crypto candlestick iterator in Go</h1><div class=post-meta><span class=post-date>Jul 27, 2022</span>
<a href=https://golangweekly.com/issues/422 target=_blank class=pill-link><div class=pill><img src=/images/icons/golang_weekly.png alt=icon class=pill-icon>Golang Weekly
422</div></a></div><div class=post-image><img src=/images/posts/candlesticks-background.jpg alt="10 Gotchas for building a universal crypto candlestick iterator in Go" class=featured-image></div><div class=post-content><h2 id=tldr>TL;DR</h2><p>I&rsquo;ve recently open sourced a universal crypto candlestick iterator library in Go called crypto-candles:</p><p><a href=https://github.com/marianogappa/crypto-candles>https://github.com/marianogappa/crypto-candles</a></p><p>It&rsquo;s being used to power the <strong><a href=https://twitter.com/crypto_preds>Crypto Predictions Tracker</a></strong>: the only unbiased, automated accountability watchdog for crypto predictions on the Internet.</p><p>There is no Go library alternative I&rsquo;ve found, or I would have used it. There are some exchange SDKs, though.</p><p>In this blogpost, I share all the interesting challenges I found while building this library over the past few months.</p><h2 id=what-is-a-candlestick>What is a candlestick?</h2><p><a href=https://www.investopedia.com/terms/c/candlestick.asp>Candlesticks</a>, also known as OHLC (i.e. Open, High, Low, Close), Klines and Bucketed Trades, are a way to display the high, low, open, and closing prices of crypto market pairs (and traditional securities) for a specific period.</p><p><img src="https://www.investopedia.com/thmb/F9Gcg7_Is-0Pj7jILEMe9IIscm0=/660x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/CandlestickDefinition3-a768ecdaadc2440db427fe8207491819.png" alt=Candlestick></p><p><a href="https://www.tradingview.com/chart/QVMg9Xmj/?symbol=BINANCE%3ABTCUSDT">Candlestick charts</a> are a common sight for crypto investors, and they are used to make buy/sell decisions, either manually or via bots or some other automated mechanisms.</p><p>Crypto exchanges like <a href=https://www.binance.com>Binance</a> or <a href=https://www.coinbase.com/>Coinbase</a> expose APIs with market information for all their supported market pairs (e.g. BTC/USDT) and allow you to consume them for free within fair-use limits.</p><p><img src=/images/posts/candlesticks.png alt="Candlestick chart"></p><h2 id=what-is-a-crypto-candlestick-iterator>What is a crypto candlestick iterator?</h2><p>A Crypto Candlestick Iterator is an <a href=https://en.wikipedia.org/wiki/Iterator_pattern>iterator</a> that you construct for:</p><ul><li>a given provider (e.g. Binance, Coinbase)</li><li>a given market pair (e.g. BTC/USDT)</li><li>a given starting timestamp (e.g. &ldquo;2020-07-04T01:02:03Z&rdquo;, here represented in ISO8601 format)</li><li>and a given candlestick interval (e.g. minutely, hourly, daily).</li></ul><p>Example in crypto-candles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>candles</span>.<span style=color:#a6e22e>NewMarket</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>iter</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Iterator</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>MarketSource</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>COIN</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Provider</span>: <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>BINANCE</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>BaseAsset</span>: <span style=color:#e6db74>&#34;BTC&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>QuoteAsset</span>: <span style=color:#e6db74>&#34;USDT&#34;</span>
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>12</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>), <span style=color:#75715e>// Start time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#ae81ff>1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>,                   <span style=color:#75715e>// Candlestick interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span></code></pre></div><p>Once constructed, calling <code>.Next()</code> on it returns either the next available candlestick in your specified interval, or an error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#a6e22e>candlestick</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Next</span>()
</span></span></code></pre></div><p>A candlestick looks like this when marshalled to JSON:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;t&#34;</span>:<span style=color:#ae81ff>1641096000</span>,<span style=color:#f92672>&#34;o&#34;</span>:<span style=color:#ae81ff>47329.47</span>,<span style=color:#f92672>&#34;c&#34;</span>:<span style=color:#ae81ff>46910.3</span>,<span style=color:#f92672>&#34;l&#34;</span>:<span style=color:#ae81ff>46770.23</span>,<span style=color:#f92672>&#34;h&#34;</span>:<span style=color:#ae81ff>47415.73</span>}
</span></span></code></pre></div><p>Where:</p><ul><li><code>o</code>: Open price</li><li><code>c</code>: Close price</li><li><code>l</code>: Low price</li><li><code>h</code>: High price</li></ul><p>&mldr;of the <code>BTC/USDT</code> market pair</p><p>&mldr;on <code>BINANCE</code></p><p>&mldr;at the hour spanning from the timestamp <code>t</code> and up to <code>t + candlestickInterval</code>.</p><h2 id=what-does-universal-candlestick-iterator-mean>What does &ldquo;universal&rdquo; candlestick iterator mean?</h2><p>It means that it supports all major exchanges.</p><p>Usually, you use the API or SDK of the exchange you want to use. If you need to use more than one, it gets tricky.</p><h2 id=whats-the-use-case-for-a-universal-candlestick-iterator>What&rsquo;s the use case for a universal candlestick iterator?</h2><ol><li><p>Data for plotting candlestick charts. If you need 2+ exchanges.</p></li><li><p>Data for backtesting trading strategies. If you need 2+ exchanges.</p></li><li><p>Data for being a watchdog for influencing statements <a href=https://twitter.com/rovercrc/status/1539710164697227267>like this one</a>.</p></li></ol><p>And with crypto-candles, you get caching, retrying on errors, patching of data gaps and concurrency-safety for free.</p><h2 id=the-meaty-part-gotchas>The meaty part: gotchas!</h2><p>Building this library through the months has been a big challenge, and in this section I&rsquo;ll list all of the important gotchas I&rsquo;ve found during this process.</p><h3 id=gotcha-1-not-all-exchanges-provide-historical-candlesticks>Gotcha 1: Not all exchanges provide historical candlesticks</h3><p>They all provide current prices. Not all provide historicals. Some do in very tricky ways.</p><p><strong>FTX</strong> does:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#34;https://ftx.com/api/markets/BTC/USDT/candles?resolution=60&amp;start_time=&#34;</span><span style=color:#66d9ef>$(</span>date -j -f <span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-04-07 00:00:00&#34;</span> <span style=color:#e6db74>&#34;+%s&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;&amp;end_time=&#34;</span><span style=color:#66d9ef>$(</span>date -j -f <span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-04-07 00:02:00&#34;</span> <span style=color:#e6db74>&#34;+%s&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;&#34;</span> | jq <span style=color:#e6db74>&#39;.result | .[]&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;startTime&#34;</span>: <span style=color:#e6db74>&#34;2020-04-06T23:00:00+00:00&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>: 1586214000000,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;open&#34;</span>: 7274,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;high&#34;</span>: 7281.5,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;low&#34;</span>: 7272,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;close&#34;</span>: 7281.5,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;volume&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;startTime&#34;</span>: <span style=color:#e6db74>&#34;2020-04-06T23:01:00+00:00&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>: 1586214060000,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;open&#34;</span>: 7281.5,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;high&#34;</span>: 7281.5,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;low&#34;</span>: 7277,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;close&#34;</span>: 7280,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;volume&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;startTime&#34;</span>: <span style=color:#e6db74>&#34;2020-04-06T23:02:00+00:00&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>: 1586214120000,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;open&#34;</span>: 7280,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;high&#34;</span>: 7280,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;low&#34;</span>: 7271.5,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;close&#34;</span>: 7274,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;volume&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>But on <strong>Huobi</strong>, <a href=https://huobiapi.github.io/docs/spot/v1/en/#get-klines-candles>the docs</a> say:</p><blockquote><p>This API doesn&rsquo;t support customized period, refer to Websocket K line API to get the emurated period value.</p></blockquote><p>Not sure what that means, but I don&rsquo;t think Websockets do either.</p><p><strong>Kraken</strong> says they do, but they silently ignore their &ldquo;since&rdquo; parameter if you go over a very short threshold to the past. Details in <a href=https://stackoverflow.com/a/48618456/965724>this Stack Overflow answer</a>.</p><p>You can still get them, if you calculate them yourself, by getting all trades and bucketing them yourself. It&rsquo;s linear time. But you have no control on what <em>n</em> is, so don&rsquo;t.</p><p><strong>Phemex</strong> has only a <a href=https://github.com/phemex/phemex-api-docs/blob/master/Public-Spot-API-en.md#subscribe-kline>websocket-based &ldquo;subscribe kline&rdquo; endpoint</a>, but only gets you up to 1000 candlesticks to the past. Then you&rsquo;re stuck with Kraken-style <a href=https://github.com/phemex/phemex-api-docs/blob/master/Public-Spot-API-en.md#query-trades-history>Query Trades History endpoint</a>.</p><h3 id=gotcha-2-rate-limiting>Gotcha 2: Rate limiting</h3><p>All exchanges must have a rate-limiting strategy to prevent malicious or buggy clients from <a href=https://en.wikipedia.org/wiki/Denial-of-service_attack>DDoSing</a> their APIs. Otherwise you&rsquo;d kill them!</p><p>In general (not always!), they give you an <a href=https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#429>HTTP 429 status code</a> when they want you to enhance your calm. If you don&rsquo;t, <strong>they IP-ban</strong> you temporarily.</p><p>In general, candlestick endpoints are &ldquo;public market data&rdquo; and don&rsquo;t require an API Key. But if you get one, they might be more tolerant with rate-limiting.</p><p>On <strong>Binance</strong>, <a href=https://binance-docs.github.io/apidocs/spot/en/#general-api-information>the docs</a> say that if you ignore the 429s, you get IP banned for 2 minutes, and up to 3 days for repeat offenders. They send a <code>Retry-After</code> header on the 429s with how many seconds you should sleep.</p><p>On <strong>Coinbase</strong>, <a href=https://docs.cloud.coinbase.com/sign-in-with-coinbase/docs/rate-limiting>the docs here</a> and <a href=https://help.coinbase.com/en/pro/other-topics/api/faq-on-api>here</a> say they allow ~3-6 requests per second.</p><p><strong>FTX</strong> <a href=https://help.ftx.com/hc/en-us/articles/360052595091-2020-11-20-Ratelimit-Updates>docs</a> make no sense. Don&rsquo;t worry, you&rsquo;re fine.</p><p>On <strong>Kucoin</strong>, the docs lie, so you don&rsquo;t need a link. You&rsquo;re gonna get 429&rsquo;d no matter what you do. Just back-off.</p><p>The other ones are fine, more on that later.</p><p>Ideally, don&rsquo;t make them 429 you. Do this:</p><ul><li>Calculate the truncated current minute of your request: <code>time.Now().Add(-1 * time.Minute).Truncate(time.Minute)</code></li><li>Keep track of the last requested minute, and a counter</li><li>If the current minute of your request equals the last, increment the counter (and reset it if not)</li><li>If the counter exceeds the exchange&rsquo;s limits, sleep!</li></ul><p><strong>Don&rsquo;t use concurrency</strong> unless:</p><ol><li>Every goroutine talks to a different exchange</li><li>You have a pool of IPs and a proxy, and every goroutine talks to a separate (exchange, IP) tuple</li><li>You&rsquo;re willing to mutex the hell out of your code</li></ol><h3 id=gotcha-3-some-exchanges-dont-respect-their-rate-limit-documentation>Gotcha 3: Some exchanges don&rsquo;t respect their rate limit documentation</h3><p>You&rsquo;re following the rules? The rules are wrong.</p><p>On <strong>Kucoin</strong>, <a href=https://docs.kucoin.com/#request-rate-limit>the docs</a> say that they allow an IP to make 10 requests per second. They don&rsquo;t. There are <a href=https://www.reddit.com/r/kucoin/comments/q5blef/api_ratelimits_problems/>many</a>, <a href=https://www.reddit.com/r/kucoin/comments/q40ode/whats_the_request_rate_limit/>Reddit</a>, <a href=https://www.reddit.com/r/kucoin/comments/lmdld9/kucoin_api_limits/>links</a> out there with people fuming about their aggressive undocumented rate limiting practices.</p><p>On <strong>Bitfinex</strong>, <a href=https://docs.bitfinex.com/docs/requirements-and-limitations>the docs</a> say they allow 10-90 requests per minute, but I ran this script that made ~140 requests per minute for many minutes and I cannot get it to rate limit me:</p><pre tabindex=0><code>while [ TRUE ]; do echo $(curl &#34;https://api-pub.bitfinex.com/v2/candles/trade:1m:tBTCUSD/hist?limit=3&amp;sort=1&amp;start=1564774820000&#34; | jq .); done
</code></pre><h3 id=gotcha-4-candlestick-data-may-be-incomplete>Gotcha 4: Candlestick data may be incomplete</h3><p><a href=https://docs.cloud.coinbase.com/exchange/reference/exchangerestapi_getproductcandles>Coinbase docs</a> explicitly say there are gaps in the data. And it&rsquo;s true. More often in the 1 minute interval.</p><p>Problems it causes:</p><ol><li><p>You&rsquo;re plotting a chart. Is it ok to leave a gap in it?</p></li><li><p>You&rsquo;re sending candlesticks to something. The receiving end hardcodes the timestamp to <code>startTimestamp + i * interval</code>. Bug.</p></li><li><p>You&rsquo;re backtesting a strategy. Your bot receives a candlestick with price 0 (or a gap) and freaks out. Bug.</p></li></ol><p>Possible solution: fill gaps by cloning previously known prices. Doesn&rsquo;t work if the gap is at the start.</p><h3 id=gotcha-5-you-wont-get-the-starting-candlestick-time-you-asked-for>Gotcha 5: You won&rsquo;t get the starting candlestick time you asked for</h3><p>The final boss! Trickiest gotcha.</p><p>You request candlesticks starting at <code>2020-07-04T01:02:03Z</code>. But you won&rsquo;t get that starting timestamp.</p><p>Exchanges snap your starting time to the data they have, and they <em>mostly</em> do the same. <em>Mostly</em>.</p><ul><li>For 1m interval: they will mostly start at <code>2020-07-04T01:03:00Z</code> (i.e. the next minute).</li><li>For 1h interval: they will mostly start at <code>2020-07-04T02:00:00Z</code> (i.e. the next hour).</li><li>For 1d interval: they will mostly start at <code>2020-07-05T00:00:00Z</code> (i.e. the next day).</li></ul><p>You get the point. Do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#a6e22e>snapTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>startTime</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>interval</span>).<span style=color:#a6e22e>Truncate</span>(<span style=color:#a6e22e>interval</span>)
</span></span></code></pre></div><p><strong>FTX</strong> for minutely candlesticks:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#34;https://ftx.com/api/markets/BTC/USDT/candles?resolution=60&amp;start_time=&#34;</span><span style=color:#66d9ef>$(</span>TZ<span style=color:#f92672>=</span>UTC date -j -f <span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-07-04 00:00:33&#34;</span> <span style=color:#e6db74>&#34;+%s&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;&amp;end_time=&#34;</span><span style=color:#66d9ef>$(</span>TZ<span style=color:#f92672>=</span>UTC date -j -f <span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-07-04 00:03:33&#34;</span> <span style=color:#e6db74>&#34;+%s&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;&#34;</span> | jq <span style=color:#e6db74>&#39;.result | .[] | .startTime&#39;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-04T00:01:00+00:00&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-04T00:02:00+00:00&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-04T00:03:00+00:00&#34;</span>
</span></span></code></pre></div><p><strong>Bitstamp</strong> is the only one that snaps to the past, here on minutely:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#34;https://www.bitstamp.net/api/v2/ohlc/btcusd/?limit=3&amp;step=60&amp;start=&#34;</span><span style=color:#66d9ef>$(</span>TZ<span style=color:#f92672>=</span>UTC date -j -f <span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-07-04 00:00:33&#34;</span> <span style=color:#e6db74>&#34;+%s&#34;</span><span style=color:#66d9ef>)</span> | jq <span style=color:#e6db74>&#39;.data.ohlc | .[] | .timestamp | tonumber | todate&#39;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-04T00:00:00Z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-04T00:01:00Z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-04T00:02:00Z&#34;</span>
</span></span></code></pre></div><p>What about intervals that are not divisors of 24-hour, e.g. 5-hour? They don&rsquo;t support them!</p><p>And don&rsquo;t get me started on weekly. Some support weekly. It&rsquo;s important.</p><p><strong>Binance</strong> & <strong>Bitfinex</strong> work with the same truncation strategy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#a6e22e>tm</span>, <span style=color:#a6e22e>_</span>    <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>RFC3339</span>, <span style=color:#e6db74>&#34;2020-07-04T01:02:03Z&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>interval</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>snap</span>     <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tm</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>interval</span>).<span style=color:#a6e22e>Truncate</span>(<span style=color:#a6e22e>interval</span>)
</span></span></code></pre></div><p>Which produces: <code>2020-07-06T00:00:00Z</code>. Let&rsquo;s see if it&rsquo;s true:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#39;https://api.binance.com/api/v3/klines?symbol=BTCUSDT&amp;interval=1w&amp;limit=3&amp;startTime=&#39;</span><span style=color:#66d9ef>$(</span>TZ<span style=color:#f92672>=</span>UTC date -j -f<span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-07-04 01:02:03&#34;</span> <span style=color:#e6db74>&#34;+%s000&#34;</span><span style=color:#66d9ef>)</span>| jq <span style=color:#e6db74>&#39;.[] | .[0] | . / 1000 | todate&#39;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-06T00:00:00Z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-13T00:00:00Z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-20T00:00:00Z&#34;</span>
</span></span></code></pre></div><p><strong>Kucoin</strong> snaps to Thursdays, and don&rsquo;t ask me why!</p><p><strong>FTX</strong> is a unique case. They support 1-day, 2-day, &mldr;, 30-day. On these, they snap your timestamp to next day (or same if it&rsquo;s already start of day), and then give you multiples starting on that day. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#34;https://ftx.com/api/markets/BTC/USDT/candles?resolution=259200&amp;start_time=&#34;</span><span style=color:#66d9ef>$(</span>TZ<span style=color:#f92672>=</span>UTC date -j -f <span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-07-04 01:02:03&#34;</span> <span style=color:#e6db74>&#34;+%s&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;&amp;end_time=&#34;</span><span style=color:#66d9ef>$(</span>TZ<span style=color:#f92672>=</span>UTC date -j -f <span style=color:#e6db74>&#34;%Y-%m-%d %H:%M:%S&#34;</span> <span style=color:#e6db74>&#34;2020-07-10 00:00:00&#34;</span> <span style=color:#e6db74>&#34;+%s&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;&#34;</span> | jq <span style=color:#e6db74>&#39;.result | .[] | .startTime&#39;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-05T00:00:00+00:00&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-07T00:00:00+00:00&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;2020-07-10T00:00:00+00:00&#34;</span>
</span></span></code></pre></div><h3 id=gotcha-6-order-of-returned-candlesticks-varies-across-exchanges>Gotcha 6: Order of returned candlesticks varies across exchanges</h3><p>Most exchanges return <em>ascending</em> order candlesticks. <strong>Coinbase</strong> and <strong>Kucoin</strong> return <em>descending</em>. <strong>Bitfinex</strong> returns <em>descending</em> by default, but can be changed.</p><p>Just reverse them. <code>O(n)</code> time, <code>O(1)</code> space:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>candles</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>j</span>; <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> = <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>j</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>candles</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>candles</span>[<span style=color:#a6e22e>j</span>] = <span style=color:#a6e22e>candles</span>[<span style=color:#a6e22e>j</span>], <span style=color:#a6e22e>candles</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=gotcha-7-exchanges-silently-ignoring-arguments>Gotcha 7: Exchanges silently ignoring arguments</h3><p>From Gotcha #1: <strong>Kraken</strong> ignores the &ldquo;since&rdquo; parameter.</p><p><strong>FTX</strong> is dangerous. In <a href=https://docs.ftx.com/#get-historical-prices>the FTX request</a>, you provide a <code>start_time</code> and an <code>end_time</code> for historical prices.</p><ul><li>if <code>end_time</code> is not specified, <code>start_time</code> is ignored silently and recent data is returned.</li><li>if the range between <code>start_time</code> & <code>end_time</code> is too broad, <code>start_time</code> will be pushed forward until the range spans 1500 candlesticks.</li></ul><h3 id=gotcha-8-invalid-market-pairs>Gotcha 8: Invalid market pairs</h3><p>You can&rsquo;t request candlesticks for <code>INVALID/USDT</code>. But all exchanges tell you this differently.</p><p>HTTP status codes:</p><ul><li><strong>Bitstamp</strong>: <code>404</code></li><li><strong>Kucoin</strong>: <code>200</code></li><li><strong>Binance</strong>: <code>400</code></li><li><strong>FTX</strong>: <code>404</code></li><li><strong>Coinbase</strong>: <code>404</code></li><li><strong>Bitfinex</strong>: <code>200</code></li></ul><p>HTTP Payloads:</p><ul><li><strong>Bitstamp</strong>: no payload</li><li><strong>Kucoin</strong>: <code>{"code": "400100", "msg": "This pair is not provided at present."}</code></li><li><strong>Binance</strong>: <code>{"code": -1121, "msg": "Invalid symbol."}</code></li><li><strong>FTX</strong>: <code>{"success": false, "error": "No such market: INVALID/USDT "}</code></li><li><strong>Coinbase</strong>: <code>{"message": "NotFound"}</code></li><li><strong>Bitfinex</strong>: no payload</li></ul><p><strong>Bitfinex</strong> is the worst. It&rsquo;s hard to tell it&rsquo;s an invalid market pair. It could be that there are no new candlesticks, because your starting time is too recent.</p><h3 id=gotcha-9-requesting-the-most-recent-candlesticks>Gotcha 9: Requesting the most recent candlesticks</h3><p>Be careful! Exchanges mostly don&rsquo;t care if you ask for non-historical starting times.</p><p>Here&rsquo;s <strong>Binance</strong> returning <code>200 OK</code> with the 3-minute <code>BTC/USDT</code> candlesticks for the year <strong>2286</strong>!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#34;https://api.binance.com/api/v3/klines?symbol=BTCUSDT&amp;interval=3m&amp;limit=60&amp;startTime=9999999999000&#34;</span> | jq <span style=color:#e6db74>&#39;.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[]</span>
</span></span></code></pre></div><p>Note that if you ask for <code>time.Now().Add(-1*time.Hour)</code>, but for daily candlesticks, your day is not over yet!</p><p>Even if it&rsquo;s over, how over is it? Race condition! Your exchange hasn&rsquo;t finalised bucketing the day yet!</p><p>If you plan to cache results, danger zone! Recent candlesticks will change.</p><p>I ran experiments to see in practical terms how much to &ldquo;lag&rdquo; to current candlesticks, and put that &ldquo;patience configuration&rdquo; in the library.</p><h3 id=gotcha-10-caching-results>Gotcha 10: Caching results</h3><p>An iterator has a buffer of results that came from the latest request. That&rsquo;s all it needs.</p><p>But real-world applications will create multiple iterators. A cache is probably needed there. <a href=https://en.wikipedia.org/wiki/Pareto_principle>The 80/20 rule</a> suggests 80% of created iterators will be for 20% of the options. You can imagine <strong>Binance</strong>&rsquo;s <code>BTC/USDT</code> recent hourly candlesticks being popular.</p><p><a href=https://martinfowler.com/bliki/TwoHardThings.html>Caching is hard</a>, but in this case it&rsquo;s a very sensible architectural choice:</p><ul><li>Historical candlesticks should not change (meh, except for Gotcha #9)</li><li>Each cache hit saves up to ~100 milliseconds in HTTP requests</li><li>Not making requests minimises rate-limiting issues</li></ul><p>What about storing cache on filesystem?</p><p>Some exchanges even provide all of their historical data <a href="https://data.binance.vision/?prefix=data/spot/daily/klines/">as files</a>. Great, ~0 requests! But:</p><ul><li>Only a few exchanges provide it</li><li>Cron to download new files, which will break</li><li>Parsing different file formats for different exchanges</li><li>Maybe 4-fallback level architecure (i.e. iterator buffer, in-memory cache, filesystem, HTTP request)</li><li>New challenges (e.g. out-of-disk, permissions, rotating, wholes in data)</li></ul><p>How about just an in-memory <a href=https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)>LRU cache</a>?</p><ul><li>LRU plays well with 80/20 request distribution</li><li>Has fixed-size memory (configurable)</li><li>Inefficient if you restart the process, but a non-invalidating cache scares me; let&rsquo;s refresh it on restarts</li></ul><h2 id=conclusion>Conclusion</h2><p>I started tinkering with the idea of building this more than a year ago in <a href=https://github.com/marianogappa/signal-checker/commit/ce6d9faddee7ff6e672d734b6eeb86abb63a5bd3>this commit</a> of a different repo, and I still feel like I don&rsquo;t fully get it.</p><p>Building this has been hard, but very fun too, and rewarding. It&rsquo;s <a href=https://en.wikipedia.org/wiki/MIT_License>MIT licensed</a> so feel free to use it, profit from it, lose money with my bugs, file issues, contribute improvements, etc. <a href=https://pkg.go.dev/github.com/marianogappa/crypto-candles>Docs are here</a>, but go to the <code>candles</code> folder to see most of it.</p><p>I also hope that the <strong><a href=https://twitter.com/crypto_preds>Crypto Predictions Tracker</a></strong> becomes popular, so that influencers get some accountability for their predictions. This is good: it will keep them honest, and improve their reputation.</p><p><a href=https://en.wikipedia.org/wiki/KISS_principle>K.I.S.S.</a>!</p></div></article></main></body></html>