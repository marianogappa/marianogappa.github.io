<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mariano Gappa's Blog</title>
<link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/chroma.css><link rel=icon href=/favicon.ico></head><body><header class=header-flex><div class=site-title><a href=/>Mariano Gappa's Blog</a></div><nav><ul><li><a href=/about/>About</a></li></ul></nav></header><main class=container><article class=post><h1 class=post-title>Running Golang on the browser with WebAssembly and TinyGo</h1><div class=post-meta><span class=post-date>Apr 1, 2020</span>
<a href=http://golangweekly.com/issues/306 target=_blank class=pill-link><div class=pill><img src=/images/icons/golang_weekly.png alt=icon class=pill-icon>Golang Weekly
306</div></a></div><div class=post-content><h2 id=tldr>TL;DR</h2><p>This is the story of how I managed to expose my Golang chess API project <a href=https://github.com/marianogappa/cheesse>cheesse</a> as a <a href=https://webassembly.org/>WebAssembly</a> binary, compiled using <a href=https://tinygo.org/>TinyGo</a>, so JavaScript could use it without needing a server.</p><p>The blogpost is optimised for helping others going through a similar exercise, rather than for readability, so expect a little too much of &ldquo;if this, do this&rdquo;. Sorry.</p><h2 id=what-are-all-those-technologies>What are all those technologies?</h2><p><strong>WebAssembly</strong></p><p>Assembly language of the Web, apparently. All major browsers support it, and the Go compiler supports js/wasm as an OS/ARCH target, so one can write Go code that runs on a webpage, rather than on a server.</p><p><strong>TinyGo</strong></p><p>It&rsquo;s a Go compiler optimised for the WebAssembly target (and also for microcontrollers). The key advantage over the official Go compiler is that it generates <em>tiny</em> binaries. <a href=https://github.com/golang/go/wiki/WebAssembly#reducing-the-size-of-wasm-files>Even the Go wiki</a> recommends using TinyGo.</p><p><strong>Cheesse</strong></p><p>Chess API that tells you, e.g.:</p><ul><li>given chess board: what are the possible moves?</li><li>given a chess board and an action: what does the game look like after?</li><li>given a chess match in some notation: how does the chess board evolve?</li></ul><h2 id=whats-the-goal>What&rsquo;s the goal?</h2><ul><li>The <em>cheesse</em> API compiles to a wasm binary, exposing the API to JavaScript without needing a server.</li><li>It is not necessary to maintain a separate version of the code to compile to this target.</li><li>The generated wasm binary has a reasonable size for use on the Web.</li></ul><h2 id=exposing-api-to-javascript>Exposing API to JavaScript</h2><p>Consider one of <em>cheesse</em>&rsquo;s basic endpoints:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ParseGame</span>(<span style=color:#a6e22e>game</span> <span style=color:#a6e22e>InputGame</span>) (<span style=color:#a6e22e>OutputGame</span>, <span style=color:#66d9ef>error</span>)
</span></span></code></pre></div><p>You give it a chess game and it spits out all relevant info about it, or an error if input is wrong.</p><p>This is how you expose a function onto the JavaScript global scope:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// This should be in a &#34;main_js.go&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Global</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;ParseGame&#34;</span>, <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>FuncOf</span>(<span style=color:#a6e22e>ParseGame</span>))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> {} <span style=color:#75715e>// Code must not finish
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>If you don&rsquo;t do that <code>select{}</code>, or something to that effect, you&rsquo;ll find this error in the Developer console of your browser:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Error: Go program has already exited
</span></span></code></pre></div><h2 id=mapping-values-from-js-to-go-and-vice-versa>Mapping values from JS to Go and vice-versa</h2><p>This is the implementation of the <code>ParseGame</code> function defined above:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ParseGame</span>(<span style=color:#a6e22e>this</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>args</span> []<span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Value</span>) <span style=color:#66d9ef>interface</span>{} {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>og</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>ParseGame</span>(<span style=color:#a6e22e>convertToInputGame</span>(<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;outputGame&#34;</span>: <span style=color:#a6e22e>convertOutputGame</span>(<span style=color:#a6e22e>og</span>),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>convertError</span>(<span style=color:#a6e22e>err</span>),
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Basically just mapping the API&rsquo;s inputs and outputs to <code>js/syscall</code>&rsquo;s interfaces.</p><p><code>ParseGame</code> follows <a href=https://golang.org/pkg/syscall/js/#FuncOf>js.FuncOf()</a>&rsquo;s interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>(<span style=color:#a6e22e>this</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>args</span> []<span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Value</span>) <span style=color:#66d9ef>interface</span>{}
</span></span></code></pre></div><p>Where <code>args</code> are the arguments supplied to <code>ParseGame</code> from JavaScript.</p><p>Here&rsquo;s a simplified implementation of <code>convertToInputGame</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>convertToInputGame</span>(<span style=color:#a6e22e>v</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Value</span>) <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>InputGame</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>InputGame</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DefaultGame</span>: <span style=color:#a6e22e>jsBool</span>(<span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;defaultGame&#34;</span>)),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FENString</span>: <span style=color:#a6e22e>jsString</span>(<span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;fenString&#34;</span>)),
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span>  <span style=color:#a6e22e>jsBool</span>(<span style=color:#a6e22e>j</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Value</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>IsUndefined</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>IsNull</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>  <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>Bool</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span>  <span style=color:#a6e22e>jsString</span>(<span style=color:#a6e22e>j</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Value</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>IsUndefined</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>IsNull</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>  <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For <code>convertOutputGame</code>, it&rsquo;s trickier. Here&rsquo;s a very simplified <code>OutputGame</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>OutputGame</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FENString</span> <span style=color:#66d9ef>string</span>         <span style=color:#e6db74>`json:&#34;fenString&#34;`</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Actions</span>   []<span style=color:#a6e22e>OutputAction</span> <span style=color:#e6db74>`json:&#34;actions&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>OutputAction</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FromSquare</span>      <span style=color:#66d9ef>string</span>  <span style=color:#e6db74>`json:&#34;fromSquare&#34;`</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ToSquare</span>        <span style=color:#66d9ef>string</span>  <span style=color:#e6db74>`json:&#34;toSquare&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>How do we map a struct with a slice of structs to something that <code>js.ValueOf</code> can receive? For this, first review <a href=https://golang.org/pkg/syscall/js/#ValueOf>the docs</a>:</p><pre tabindex=0><code>func ValueOf(x interface{}) Value

ValueOf returns x as a JavaScript value:

Go                    | JavaScript 
----------------------| -----------
js.Value              | [its value]
js.Func               | function   
nil                   | null       
bool                  | boolean    
integers and floats   | number     
string                | string     
[]interface{}         | new array  
map[string]interface{}| new object 

Panics if x is not one of the expected types.
</code></pre><p>Go struct => JS object, so top-layer we must send a <code>map[string]interface{}</code>.</p><p>The trick is: the map&rsquo;s values (i.e. the <code>interface{}</code> part) follow the same rules from those docs. That&rsquo;s how we achieve the nesting.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>convertOutputGame</span>(<span style=color:#a6e22e>og</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>OutputGame</span>) <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{} {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fenString&#34;</span>: <span style=color:#a6e22e>og</span>.<span style=color:#a6e22e>FENString</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;actions&#34;</span>: <span style=color:#a6e22e>convertOutputActions</span>(<span style=color:#a6e22e>og</span>.<span style=color:#a6e22e>Actions</span>),
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>convertOutputActions</span>(<span style=color:#a6e22e>as</span> []<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>OutputAction</span>) []<span style=color:#66d9ef>interface</span>{} {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>is</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>interface</span>{}, len(<span style=color:#a6e22e>as</span>))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>as</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>is</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>convertOutputAction</span>(<span style=color:#a6e22e>as</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>is</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>convertOutputAction</span>(<span style=color:#a6e22e>a</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>OutputAction</span>) <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{} {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fromSquare&#34;</span>: <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>FromPieceSquare</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;toSquare&#34;</span>: <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>ToSquare</span>,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ok-compile-time>Ok, compile time!</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>✔ $ GOOS<span style=color:#f92672>=</span>js GOARCH<span style=color:#f92672>=</span>wasm go build -o poc/main.wasm
</span></span><span style=display:flex><span><span style=color:#75715e># github.com/marianogappa/cheesse</span>
</span></span><span style=display:flex><span>./main_js.go:39:6: main redeclared in this block
</span></span><span style=display:flex><span>	previous declaration at ./main.go:17:6
</span></span></code></pre></div><p>Oh, right. We have two <code>main()</code>. We can use build constraints.</p><p>Put this on the first line of <code>main.go</code>:</p><pre tabindex=0><code>// +build !js

package main
</code></pre><p>And this on the first line of <code>main_js.go</code>:</p><pre tabindex=0><code>// +build js,wasm

package main
</code></pre><p>Don&rsquo;t forget to leave a <strong>newline</strong> between the <code>//</code> and <code>package main</code>. That&rsquo;s <a href=https://golang.org/pkg/go/build/#hdr-Build_Constraints>not optional</a> and fails silently.</p><p>Also, don&rsquo;t do <code>+build !js,wasm</code>. That doesn&rsquo;t work either. There&rsquo;s only <code>wasm</code> anyway, right?</p><h2 id=ok-compile-time-2>Ok, compile time! #2</h2><pre tabindex=0><code>✔ $ GOOS=js GOARCH=wasm go build -o poc/main.wasm
✔ $
</code></pre><p>🎉</p><p>Follow <a href=https://github.com/golang/go/wiki/WebAssembly#getting-started>these instructions</a> on how to load the <code>main.wasm</code> into an <code>index.html</code> file.</p><p>If you try to open the <code>index.html</code> directly on your browser you&rsquo;ll get this error on the browser&rsquo;s Developer Console:</p><pre tabindex=0><code>Fetch API cannot load file:///.../poc/main.wasm.
URL scheme must be &#34;http&#34; or &#34;https&#34; for CORS request.
</code></pre><p>You need to serve the files.</p><h2 id=serving-the-files>Serving the files</h2><p>Your favourite one-liner server (is it Python&rsquo;s <code>SimpleHTTPServer</code> for all of us?), might give you this error:</p><pre tabindex=0><code>TypeError: Response has unsupported MIME type
</code></pre><p>You need a server that knows about WebAssembly&rsquo;s MIME type.</p><p>The easy way:</p><pre tabindex=0><code># install goexec: go get -u github.com/shurcooL/goexec
$ goexec &#39;http.ListenAndServe(`:8080`, http.FileServer(http.Dir(`.`)))&#39;
</code></pre><p>If you really want to use <code>SimpleHTTPServer</code> there&rsquo;s a solution that I validated to work <a href=https://curiousprog.com/2018/10/08/serving-webassembly-files-with-a-development-web-server/>here</a>.</p><h2 id=did-it-work>Did it work?</h2><p>Yes! 🎉</p><p><img src=/images/posts/webassembly-tinygo-cheesse.gif alt="Working Proof of Concept"></p><p>But there&rsquo;s a catch:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ll -h main.wasm
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> marianol  staff   7.6M <span style=color:#ae81ff>28</span> Mar 20:45 main.wasm
</span></span></code></pre></div><p>I know the Web is bloated, but 7.6MB is not gonna fly.</p><h2 id=enter-tinygo>Enter TinyGo</h2><p>Drop-in replacement for the Go compiler, right?</p><pre tabindex=0><code>$ tinygo build -o poc/main.wasm -target wasm .
error: requires go version 1.11, 1.12, or 1.13, got go1.14
</code></pre><p>Ok, that&rsquo;s not that bad. Go 1.14 is gonna be supported <a href=https://github.com/tinygo-org/tinygo/pull/901>soon</a>, but for now we&rsquo;ll have to downgrade:</p><pre tabindex=0><code>$ brew install go@1.13
...
$ echo &#39;export PATH=&#34;/usr/local/opt/go@1.13/bin:$PATH&#34;&#39; &gt;&gt; ~/.bash_profile
...
$ go version
go version go1.13.9 darwin/amd64
</code></pre><h2 id=tinygo-round-2>TinyGo, Round 2!</h2><p>Drop-in replacement for the Go compiler, right?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tinygo build -o poc/main.wasm -target wasm .
</span></span><span style=display:flex><span><span style=color:#75715e># encoding/asn1</span>
</span></span><span style=display:flex><span>usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:537:47: v.Type<span style=color:#f92672>()</span>.NumMethod undefined <span style=color:#f92672>(</span>type reflect.Type has no field or method NumMethod<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:549:14: DeepEqual not declared by package reflect
</span></span><span style=display:flex><span>usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:558:14: DeepEqual not declared by package reflect
</span></span><span style=display:flex><span>usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:479:93: t.Field<span style=color:#f92672>(</span>startingField<span style=color:#f92672>)</span>.Tag.Get undefined <span style=color:#f92672>(</span>type string has no field or method Get<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:483:103: t.Field<span style=color:#f92672>(</span>i + startingField<span style=color:#f92672>)</span>.Tag.Get undefined <span style=color:#f92672>(</span>type string has no field or method Get<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Oh, God, what&rsquo;s all this?</p><p>Ok, the thing with TinyGo is that there are many stdlib packages that are not yet supported, so if you must use them then you can&rsquo;t use TinyGo, unfortunately.</p><p><a href=https://tinygo.org/lang-support/stdlib/>https://tinygo.org/lang-support/stdlib/</a></p><p>Some key unsupported packages: <code>encoding/json</code> & <code>net/http</code> (I assume <code>encoding/asn1</code> is a dependency of <code>net/http</code>).</p><p>I was using both. Since I don&rsquo;t need them for the JS part, the solution is to use a TinyGo-specific build constraint instead of <code>// +build !js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// +build !tinygo
</span></span></span></code></pre></div><p>And vice-versa for <code>main_js.go</code>.</p><h2 id=tinygo-round-3>TinyGo, Round 3!</h2><pre tabindex=0><code>$ tinygo build -o poc/main.wasm -target wasm .
# github.com/marianogappa/cheesse
main_js.go:102:7: j.IsUndefined undefined (type js.Value has no field or method IsUndefined)
main_js.go:102:26: j.IsNull undefined (type js.Value has no field or method IsNull)
main_js.go:95:7: j.IsUndefined undefined (type js.Value has no field or method IsUndefined)
...
</code></pre><p>Unsupported <code>js/syscall</code> methods?</p><p>Nah, this one is not on TinyGo. We&rsquo;ve downgraded Go to 1.13.9, so those methods don&rsquo;t exist anymore.</p><p>Replace all:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>IsUndefined</span>()
</span></span></code></pre></div><p>With:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>j</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>Undefined</span>()
</span></span></code></pre></div><h2 id=tinygo-round-4>TinyGo, Round 4!</h2><pre tabindex=0><code>$ tinygo build -o poc/main.wasm -target wasm .
# github.com/marianogappa/cheesse/api
/usr/local/Cellar/tinygo/0.12.0/src/sync/pool.go:14:14 unsupported instruction during init evaluation:
  %23 = inttoptr i32 %22 to %runtime._interface (i8*, i8*)*, !dbg !1864
</code></pre><p>Huh?</p><p>Ok, that&rsquo;s confusing, but it&rsquo;s something to do with an instruction that runs during an <code>init()</code> that indirectly ends up in <code>sync/pool</code>, that must be unsupported or something.</p><p>I don&rsquo;t use <code>init()</code>, and <a href=https://github.com/leighmcculloch/gochecknoinits>neither should you</a>. But if you have a <code>var</code> in the global scope (i.e. a global variable) that calls something, then the Go compiler will put that in an <code>init()</code>.</p><p>You shouldn&rsquo;t have globals either, but we make some exceptions, and in my case it was like a million error literals like this one:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errBlackCastle</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;impossible for black to castle since king has moved&#34;</span>)
</span></span></code></pre></div><p>It turns out <code>fmt.Errorf</code> ends up calling <code>sync/pool</code>. A brilliant workaround for this one is to replace <code>fmt.Errorf</code> with <code>errors.New</code>. This only works if you have nothing to interpolate, but since it&rsquo;s a global, you probably don&rsquo;t.</p><p>If you have other globals that call things, keep the <code>var</code>, but initialise the value in your <code>main()</code>.</p><h2 id=tinygo-round-5>TinyGo: Round 5!</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tinygo build -o poc/main.wasm -target wasm .
</span></span><span style=display:flex><span>inlinable <span style=color:#66d9ef>function</span> call in a <span style=color:#66d9ef>function</span> with debug info must have a !dbg location
</span></span><span style=display:flex><span>  call void @runtime.nilPanic<span style=color:#f92672>(</span>i8* undef, i8* null<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>inlinable <span style=color:#66d9ef>function</span> call in a <span style=color:#66d9ef>function</span> with debug info must have a !dbg location
</span></span><span style=display:flex><span>  %352 <span style=color:#f92672>=</span> call fastcc i1 @<span style=color:#e6db74>&#34;github.com/marianogappa/cheesse/api.boolMatcher</span>$1<span style=color:#e6db74>&#34;</span><span style=color:#f92672>(</span>i32 %351, i8* %pack.int217, i8* %341, i8* undef<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>inlinable <span style=color:#66d9ef>function</span> call in a <span style=color:#66d9ef>function</span> with debug info must have a !dbg location
</span></span><span style=display:flex><span>  %353 <span style=color:#f92672>=</span> call fastcc i1 @<span style=color:#e6db74>&#34;github.com/marianogappa/cheesse/api.intMatcher</span>$1<span style=color:#e6db74>&#34;</span><span style=color:#f92672>(</span>i32 %351, i8* %pack.int217, i8* %341, i8* undef<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>inlinable <span style=color:#66d9ef>function</span> call in a <span style=color:#66d9ef>function</span> with debug info must have a !dbg location
</span></span><span style=display:flex><span>  %354 <span style=color:#f92672>=</span> call fastcc i1 @<span style=color:#e6db74>&#34;github.com/marianogappa/cheesse/api.pieceTypeMatcher</span>$1<span style=color:#e6db74>&#34;</span><span style=color:#f92672>(</span>i32 %351, i8* %pack.int217, i8* %341, i8* undef<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>error: optimizations caused a verification failure
</span></span></code></pre></div><p>WAT.
Ok, I don&rsquo;t know. But if you get this, the workaround is to add the <code>-no-debug</code> flag to the compile line.</p><h2 id=tinygo-round-6>TinyGo, Round 6!</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tinygo build -o poc/main.wasm -no-debug -target wasm .
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>OMG, YES! 🎉🎉🎉 Did it work???</p><p>Nope. If you get an error in the Developer Console on your browser, perhaps this one:</p><pre tabindex=0><code>TypeError: import object field &#39;wasi_unstable&#39; is not an Object
</code></pre><p>You need to take into account that every compiler you use, and every version of that compiler might have a different companion <code>wasm_exec.js</code>. For TinyGo, do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp <span style=color:#66d9ef>$(</span>tinygo env TINYGOROOT<span style=color:#66d9ef>)</span>/targets/wasm_exec.js .
</span></span></code></pre></div><h2 id=tinygo-round-7>TinyGo, Round 7!</h2><p>You might do absolutely everything right, get it compiled and then go to your browser&rsquo;s Developer Console and see this:</p><pre tabindex=0><code>panic: syscall/js: Value.Call: property _makeFuncWrapper is not a function, got undefined [wasm_exec.js:201:19](http://localhost:8000/wasm_exec.js)
</code></pre><p>That one is this issue:
<a href=https://github.com/tinygo-org/tinygo/issues/716>https://github.com/tinygo-org/tinygo/issues/716</a></p><p>It might be solved by the time you read this, but the workaround at the time of this writing is to switch to the <code>dev</code> version of TinyGo, which is pretty bleeding edge but seems to work well.</p><p>Follow the <a href=https://tinygo.org/getting-started/macos/>Source Install instructions</a> and change branch before installing.</p><p>Something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ brew install llvm
</span></span><span style=display:flex><span>$ cd /tmp
</span></span><span style=display:flex><span>$ export GO111MODULE<span style=color:#f92672>=</span>on
</span></span><span style=display:flex><span>$ go get -d -u github.com/tinygo-org/tinygo
</span></span><span style=display:flex><span>$ cd $GOPATH/src/github.com/tinygo-org/tinygo
</span></span><span style=display:flex><span>$ git checkout dev
</span></span><span style=display:flex><span>$ go install
</span></span></code></pre></div><h2 id=tinygo-round-8>TinyGo, Round 8!</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tinygo build -o poc/main.wasm -no-debug -target wasm .
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>Before testing on the browser, remember that you&rsquo;ve changed the version of TinyGo, so you must copy <code>wasm_exec.js</code> again, only this time the file is in a different place because you&rsquo;ve built from source:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp $GOPATH/src/github.com/tinygo-org/tinygo/targets/wasm_exec.js .
</span></span></code></pre></div><p>Did it work???</p><p><img src=/images/posts/webassembly-tinygo-cheesse.gif alt="Working Proof of Concept"></p><p>OMG, YES! 🎉🎉🎉</p><h2 id=one-last-check>One last check</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ll -h main.wasm
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> marianol  staff   392K <span style=color:#ae81ff>29</span> Mar 00:21 main.wasm
</span></span></code></pre></div><p>392 KB! That&rsquo;s an amazing improvement from 7.6MB! 🎉🎉🎉</p><h2 id=conclusion>Conclusion</h2><p>Writing Go code for the browser is a reality today. But it&rsquo;s no picnic. Ideally, we&rsquo;d write whatever we want, run the Go compiler and get a 1kb npm package or something, right? Well, we&rsquo;ll get there. Still a better love story than writing JavaScript, aye.</p><p><a href=https://marianogappa.github.io/cheesse-examples/>auto-play proof of concept</a></p><p><a href=https://github.com/marianogappa/cheesse>cheesse open source project</a></p><h2 id=acknowledgements>Acknowledgements</h2><p>I didn&rsquo;t come up with most of the solutions to the issues outlined in this blogpost. This was only possible thanks to the kind and patient help I received from TinyGo&rsquo;s author <a href=https://twitter.com/aykevl>Ayke van Laethem</a> and contributors <a href=https://twitter.com/jaddr2line>Jaden Weiss</a> and <a href=https://twitter.com/JohanBrandhorst>Johan Brandhorst</a> for hours on end at the #tinygo channel on <a href=https://invite.slack.golangbridge.org/>GopherSlack</a>.
Also, thanks to <a href=https://twitter.com/_myitcv>Paul Jolly</a> for pointing me in the right direction while getting started with WebAssembly.</p></div></article></main></body></html>