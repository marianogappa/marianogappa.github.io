<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mariano Gappa's Blog</title>
<link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/chroma.css><link rel=icon href=/favicon.ico></head><body><header><div class=container><h1 class=site-title><a href=/>Mariano Gappa's Blog</a></h1><nav><ul><li><a href=/about/>About</a></li><li><a href=/projects/>Projects</a></li></ul></nav></div></header><main class=container><article class=post><div class=post-meta><span class=post-date>May 15, 2025</span>
<span class=pill><img src=/images/icons/clickhouse.svg alt=icon class=pill-icon>
<a href=https://clickhouse.com/newsletter target=_blank>ClickHouse Newsletter</a></span></div><h1 class=post-title>How We Handle Billion-Row ClickHouse Inserts With UUID Range Bucketing</h1><div class=post-content><p>In this post, we describe how we solved OOM issues in ClickHouse using a simple UUID-range bucketing algorithm called <code>InsertSplitter</code>.</p><p><img src=/images/posts/clickhouse-buckets.png alt="ClickHouse Buckets"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// InsertSplitter splits inserts into UUID buckets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>InsertSplitter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BucketCount</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InsertSplitter</span>) <span style=color:#a6e22e>Bucket</span>(<span style=color:#a6e22e>uuid</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Simple hash for demonstration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>uuid</span>[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>%</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>BucketCount</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article></main></body></html>