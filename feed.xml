<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Mariano Gappa&apos;s Blog</title>
    <description>Blog about Software Engineering and Music Production.</description>
    <link>https://marianogappa.github.io/</link>
    <atom:link href="https://marianogappa.github.io/feed.xml" rel="self" type="application/rss+xml" />
    
      <item>
        <title>How I fully automated my prediction tracking system using Generative AI</title>
        <description>&lt;h2 id=&quot;tldr&quot;&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;Two years ago, I delved into the cryptocurrency scene as an investor and encountered a frustrating lack of reliable investment advice. I detailed this issue in &lt;a href=&quot;https://marianogappa.github.io/software/2022/08/25/cryptocurrency-influencers-are-preying-on-millennials-who-found-salvation-in-crypto/&quot;&gt;this blogpost&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Last year, I worked on a Go-based project aiming to automate the tracking of cryptocurrency predictions on social networks, as discussed in &lt;a href=&quot;https://marianogappa.github.io/software/2023/06/07/building-crypto-predictions/&quot;&gt;this blogpost&lt;/a&gt;. While the system was mostly automated, a manual step of inputting predictions remained.&lt;/p&gt;

&lt;p&gt;Recently, the emergence of LLMs based on generative AI provided an opportunity to fully automate it. This blog post outlines the implementation of this automation.&lt;/p&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;For a detailed understanding of the system, please refer to &lt;a href=&quot;https://marianogappa.github.io/software/2023/06/07/building-crypto-predictions/&quot;&gt;this blogpost&lt;/a&gt;. Here’s a simplified explanation:&lt;/p&gt;

&lt;p&gt;A prediction on a social network, like the example below, typically includes a date, an owner, and mostly uneditable content:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto_social_post.png&quot; alt=&quot;Social Network Posts&quot; /&gt;&lt;/p&gt;

&lt;p&gt;At a high level, automating prediction tracking involves three main steps:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-system-diagram.png&quot; alt=&quot;Crypto Predictions System Diagram&quot; /&gt;&lt;/p&gt;

&lt;p&gt;How can we automate the manual step of inputing predictions?&lt;/p&gt;

&lt;h2 id=&quot;automating-input&quot;&gt;Automating input&lt;/h2&gt;

&lt;p&gt;Automating the input part comprises three distinct parts:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Finding predictions&lt;/li&gt;
  &lt;li&gt;Transforming prediction content into a structured form&lt;/li&gt;
  &lt;li&gt;Inputting the structured prediction into the system&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;finding-predictions&quot;&gt;Finding predictions&lt;/h2&gt;

&lt;p&gt;The manual process involves compiling a clever list of search terms on Twitter, running each one, analyzing resulting tweets, and inputting trackable predictions. Can this analysis be automated using, for instance, ChatGPT?&lt;/p&gt;

&lt;p&gt;Examining &lt;a href=&quot;https://twitter.com/LoboRonin7/status/1746680040203452855&quot;&gt;this example tweet&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/automating-predictions-example-tweet.png&quot; alt=&quot;Example Tweet&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A well-iterated prompt seems effective:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/automating-predictions-prompt-1.png&quot; alt=&quot;Prompt 1&quot; /&gt;
&lt;img src=&quot;https://marianogappa.github.io/images/automating-predictions-prompt-2.png&quot; alt=&quot;Prompt 2&quot; /&gt;
&lt;img src=&quot;https://marianogappa.github.io/images/automating-predictions-prompt-3.png&quot; alt=&quot;Prompt 3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Ok, that works!&lt;/p&gt;

&lt;p&gt;If we can do it for one tweet, we can certainly repeat it for a million of them. The only thing we need is a script that:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Keeps sniffing Tweets on the Internet&lt;/li&gt;
  &lt;li&gt;Dedupes&lt;/li&gt;
  &lt;li&gt;Feeds each unique tweet to this prompt on ChatGPT4’s API&lt;/li&gt;
  &lt;li&gt;Sends the candidates to step 2 (transforming into structured prediction)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The only issue is that &lt;a href=&quot;https://developer.twitter.com/en/docs/twitter-api/getting-started/about-twitter-api&quot;&gt;Elon started charging $100/month&lt;/a&gt; to use their read API. The only solution I’ve found is to get a Twitter login, and then build a puppeteer script that logs in, runs the searches and extracts the tweets. Sorry, Elon, but this is unreasonable for a PoC; I’m not gonna DDoS your platform.&lt;/p&gt;

&lt;h2 id=&quot;transforming-tweets-into-structured-predictions&quot;&gt;Transforming tweets into structured predictions&lt;/h2&gt;

&lt;p&gt;Before LLMs, automating this step was impossible. The prompt for transforming tweets looks promising. Let’s try it on an example:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/automating-predictions-prompt-4.png&quot; alt=&quot;Prompt 4&quot; /&gt;
&lt;img src=&quot;https://marianogappa.github.io/images/automating-predictions-prompt-5.png&quot; alt=&quot;Prompt 5&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Perfect!&lt;/p&gt;

&lt;h2 id=&quot;inputting-predictions-into-the-system&quot;&gt;Inputting predictions into the system&lt;/h2&gt;

&lt;p&gt;This step should be trivial, since &lt;a href=&quot;https://github.com/marianogappa/crypto-predictions/blob/main/api/api.go&quot;&gt;I separated the API from the BackOffice&lt;/a&gt; anticipating other integration use cases.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;The practical applications of Generative AI have surpassed my initial expectations, opening doors to use cases I once deemed impossible. While I may not proclaim absolute trust in the system’s full automation capabilities at this point, it has reached a stage where I can comfortably perform a daily one-minute check, allowing me to efficiently review automated predictions.&lt;/p&gt;

&lt;p&gt;The success of this project has ignited a sense of enthusiasm within me. I feel like integrating LLMs into all my future projects.&lt;/p&gt;
</description>
        <pubDate>Mon, 15 Jan 2024 00:00:00 +0000</pubDate>
        <link>https://marianogappa.github.io/software/2024/01/15/automate-predictions-with-generative-ai/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2024/01/15/automate-predictions-with-generative-ai/</guid>
      </item>
    
      <item>
        <title>On being parasitical</title>
        <description>&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;“Parasitical” is a derogatory term and it means “habitually relying on exploiting others”. The incentive for being parasitical is to gain personal wealth, power or otherwise, but this comes at the expense of others’ rights, well-being and such.&lt;/p&gt;

&lt;p&gt;Unlike biological parasites, humans (generally) possess &lt;a href=&quot;https://en.wikipedia.org/wiki/Moral_agency&quot;&gt;moral agency&lt;/a&gt;, enabling them to understand the consequences of their actions.&lt;/p&gt;

&lt;p&gt;Examples:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Piracy&lt;/strong&gt;: Enjoying a movie without paying for it.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Workplace Slacking&lt;/strong&gt;: Avoiding effort while still receiving payment.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Political Budget Abuse&lt;/strong&gt;: Profiting at the expense of constituents.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;An important observation is that &lt;strong&gt;as parasites multiply, the system breaks down&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;If everyone pirates movies, the film industry collapses.&lt;/li&gt;
  &lt;li&gt;If every employee slacks off, companies go bankrupt.&lt;/li&gt;
  &lt;li&gt;If every politician abuses budgets, governmental dysfunction ensues.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;However, a system with no parasites at all is not ideal; &lt;a href=&quot;https://en.wikipedia.org/wiki/Antifragility&quot;&gt;antifragile&lt;/a&gt; systems thrive on stressors.&lt;/p&gt;

&lt;h2 id=&quot;population-size&quot;&gt;Population size&lt;/h2&gt;

&lt;p&gt;The population size of the environment influences the sustainability of parasitical behavior:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;In a large corporation, one can slack off undetected, but this is less feasible in a small startup.&lt;/li&gt;
  &lt;li&gt;A skilled corrupt politician can take a very small cut on a large budget for an entire state, but in a small town the same volume of fraud is more likely to be noticed.&lt;/li&gt;
  &lt;li&gt;Anonymity in a large city facilitates the abuse of public services; this would be noticeable in a small town.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It’s no surprise that founders and engaged managers often &lt;a href=&quot;https://world.hey.com/dhh/need-it-take-7-500-people-to-run-twitter-a8cb36a6&quot;&gt;prefer small teams&lt;/a&gt;, and well-managed states tend to have smaller populations.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Parasites hide in numbers&lt;/strong&gt;. &lt;em&gt;Smart&lt;/em&gt; parasites navigate the immune response of systems, allowing them to persist.&lt;/p&gt;

&lt;h2 id=&quot;morality&quot;&gt;Morality&lt;/h2&gt;

&lt;p&gt;While parasitical behavior seems inherently immoral, the reality is that &lt;strong&gt;we are all parasitical in various ways&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Animal cruelty for taste preferences.&lt;/li&gt;
  &lt;li&gt;Child labor for cheaper goods.&lt;/li&gt;
  &lt;li&gt;Ignoring systemic issues (e.g. inequality, climate collapse) for personal comfort.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Being indirectly parasitical is not morally superior&lt;/strong&gt;; it exploits others equally for the same gain. The question is, &lt;strong&gt;where do we draw the line&lt;/strong&gt; on acceptable parasitical behavior?&lt;/p&gt;

&lt;p&gt;Finally, institutionalized parasitical behavior, like exploitative professions and businesses, seem to amplify the immorality.&lt;/p&gt;

&lt;h2 id=&quot;being-less-parasitical&quot;&gt;Being less parasitical&lt;/h2&gt;

&lt;p&gt;Can societies become less parasitical? Individuals may reject parasitical behavior due to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Altruism&lt;/li&gt;
  &lt;li&gt;Feeling of being independent&lt;/li&gt;
  &lt;li&gt;Reputation concerns&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For those ingrained in parasitical societies, change is challenging.&lt;/p&gt;

&lt;p&gt;It seems that &lt;strong&gt;less parasitical societies are fragile and must be protected&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;To foster less parasitical behavior:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Improve well-being: give people bandwidth to care about others.&lt;/li&gt;
  &lt;li&gt;Keep communities small for visibility.&lt;/li&gt;
  &lt;li&gt;Leverage technology for oversight.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;cognitive-dissonance--rationalisation&quot;&gt;Cognitive dissonance &amp;amp; rationalisation&lt;/h2&gt;

&lt;p&gt;If people desire less parasitical surroundings but still engage in parasitical behavior, cognitive dissonance or rationalization may be at play.&lt;/p&gt;

&lt;p&gt;Rationalization branches into two types:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Prideful Parasites&lt;/strong&gt;: Those who enjoy exploiting others without seeing it as “bad”.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Necessity Parasites&lt;/strong&gt;: Those who believe it’s wrong but justify it for achieving personal goals, which needn’t be selfish nor extravagant.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The latter group often views the system as broken, making parasitical behavior necessary. At the same time, they will often be hard-working and just as loving as your closest family member.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In conclusion, we all exhibit parasitical behaviors to varying degrees. Considering where to draw the line for acceptable parasitical behavior prompts introspection.&lt;/p&gt;

&lt;p&gt;Where do you draw the line?&lt;/p&gt;
</description>
        <pubDate>Thu, 28 Dec 2023 00:00:00 +0000</pubDate>
        <link>https://marianogappa.github.io/ethics/2023/12/28/on-being-parasitical/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/ethics/2023/12/28/on-being-parasitical/</guid>
      </item>
    
      <item>
        <title>Real life indirection is the root of all evil, and AI agents can fix it!</title>
        <description>&lt;h2 id=&quot;tldr&quot;&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;This blogpost introduces the idea that there’s a concept called “indirection in the real World”, derived from a programming concept, which is good in principle, but also hides behind all evil. It then explores how the latest developments in AI might present an opportunity to challenge some of the adverse effects of it.&lt;/p&gt;

&lt;h2 id=&quot;what-was-indirection&quot;&gt;What was indirection?&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Indirection&quot;&gt;Indirection&lt;/a&gt;, for the uninitiated, is a computer programming principle.&lt;/p&gt;

&lt;p&gt;Examples:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;A &lt;a href=&quot;https://en.wikipedia.org/wiki/Pointer_(computer_programming)#Formal_description&quot;&gt;pointer&lt;/a&gt; to a value indirectly references a value.&lt;/li&gt;
  &lt;li&gt;An &lt;a href=&quot;https://en.wikipedia.org/wiki/Interface_(computing)&quot;&gt;interface&lt;/a&gt; indirects the implementation details of some function from its consumers.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/High-level_programming_language&quot;&gt;Higher-level languages&lt;/a&gt; like Python or Swift indirect memory management, nested call stacks and other low-level details.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Indirection is not inherently bad and it’s necessary to implement good &lt;a href=&quot;https://en.wikipedia.org/wiki/Abstraction_principle_(computer_programming)&quot;&gt;abstractions&lt;/a&gt;: we don’t want to go back to &lt;a href=&quot;https://en.wikipedia.org/wiki/Assembly_language&quot;&gt;Assembly&lt;/a&gt; 😱!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-assembly.png&quot; alt=&quot;Assembly&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The popular negative connotation around indirection comes from the difficulty of reading through code when there are too many nested “jump to definition” hops (indirection hops!) to get to some relevant section, as opposed to a linear sequence of actions.&lt;/p&gt;

&lt;p&gt;Often, one can draw a parallel between a codebase and a tricky book. But when there’s too much indirection, it feels more like reading an over-engineered &lt;a href=&quot;https://en.wikipedia.org/wiki/Choose_Your_Own_Adventure&quot;&gt;Choose your own adventure&lt;/a&gt; gamebook, where you have to switch pages every 5 words!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-choose-your-own-adventure.jpeg&quot; alt=&quot;Choose your own adventure&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;what-does-indirection-in-the-real-world-look-like&quot;&gt;What does “Indirection in the real World” look like?&lt;/h2&gt;

&lt;p&gt;For the most part, we no longer do anything end-to-end by ourselves.&lt;/p&gt;

&lt;p&gt;There was a time when humans didn’t &lt;em&gt;indirectly&lt;/em&gt; depend on other humans for:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Food&lt;/strong&gt;: we don’t plant it, grow it, harvest it, package it. We don’t even know &lt;em&gt;how to&lt;/em&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Shelter&lt;/strong&gt;: perhaps thousands of people involved in building a house, keeping it warm, lit, having a sewage system.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Safety&lt;/strong&gt;: an emergency service a call away that deploys police, firefighters or ambulances to your location in minutes!&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-cavemen.png&quot; alt=&quot;Cavemen&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We live in a much better World now, thanks to this gargantuan spider web of indirection we’ve built. Indirection is good!&lt;/p&gt;

&lt;p&gt;But sometimes it’s bad. Have you ever heard of these?&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;“responsibility can never be delegated”&lt;/li&gt;
  &lt;li&gt;“if you want something done right, do it yourself”&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Those are common proverbs for “indirection is bad”.&lt;/p&gt;

&lt;h2 id=&quot;where-did-indirection-go-so-wrong&quot;&gt;Where did indirection go so wrong?&lt;/h2&gt;

&lt;p&gt;If you make a list of the top things that are wrong with the World, you can find indirection creeping in:&lt;/p&gt;

&lt;h3 id=&quot;war&quot;&gt;War&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;The American people wouldn’t on their own decide to invade Irak&lt;/li&gt;
  &lt;li&gt;The Russian people wouldn’t on their own decide to invade Ukraine&lt;/li&gt;
  &lt;li&gt;…and the same goes for all others&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;War is only possible due to indirection.&lt;/p&gt;

&lt;p&gt;The governments &amp;amp; powerful elites:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Make the decisions leveraging the indirection in &lt;strong&gt;representative democracy&lt;/strong&gt;.&lt;/li&gt;
  &lt;li&gt;Persuade people that it’s the right decision leveraging the indirection in &lt;strong&gt;the media’s depictions of news &amp;amp; facts&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;extreme-social-inequality&quot;&gt;Extreme social inequality&lt;/h3&gt;
&lt;p&gt;Extreme inequality is actually a fragile state and it leads to &lt;a href=&quot;https://en.wikipedia.org/wiki/French_Revolution#Causes&quot;&gt;guillotines&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To maintain order, diverse mechanisms of indirection are applied.&lt;/p&gt;

&lt;p&gt;A very simple one is &lt;strong&gt;distance&lt;/strong&gt;: Michael Moore, despite whatever feelings you might have about him, puts it very eloquently &lt;a href=&quot;https://youtu.be/XQ_agxK6fLs?t=327&quot;&gt;in this excerpt&lt;/a&gt;, when discussing how all schools in Finland are the same, so the rich parents have to make sure the public schools are great, and given that rich kids go to school with the rest and become friends, they have to think twice before they screw them over as wealthy adults.&lt;/p&gt;

&lt;p&gt;Ever wondered why you can hardly ever see or speak to rich, powerful people? The “thing” separating them from you is called indirection.&lt;/p&gt;

&lt;h3 id=&quot;obesity-epidemic&quot;&gt;Obesity epidemic&lt;/h3&gt;
&lt;p&gt;It’s great that we don’t have to plant, harvest, package and transport all our food by ourselves now. But those who do that for us have different priorities:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;They add loads of preservatives and chemicals to the products so they last longer in the shelves, regardless of possible adverse effects.&lt;/li&gt;
  &lt;li&gt;They deliberately make unhealthy products incredibly tasty and market them to kids, then lie about the health effects, to make a profit.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-happy-meal.png&quot; alt=&quot;Happy Meal&quot; /&gt;&lt;/p&gt;

&lt;p&gt;You can clearly see how the hugely beneficial effects of delegation are unfortunately subverted by leveraging the indirection when objectives are not aligned.&lt;/p&gt;

&lt;p&gt;Often, well-off people opt to:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;shop products that closely &amp;amp; explicitly showcase the food origin &amp;amp; process&lt;/li&gt;
  &lt;li&gt;shop direct from local farmers&lt;/li&gt;
  &lt;li&gt;grow food themselves&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;What is this, effectively? 🤔 Removing/minimising indirection!&lt;/p&gt;

&lt;h3 id=&quot;political-corruption&quot;&gt;Political corruption&lt;/h3&gt;
&lt;p&gt;There’s a legit point to representative democracy! It would be really hard to have a debate with your whole city on every little aspect of government (and the &lt;a href=&quot;https://en.wikipedia.org/wiki/Landsgemeinde&quot;&gt;Landsgemeinde&lt;/a&gt; doesn’t count).&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-landsgemeinde.png&quot; alt=&quot;Landsgemeinde&quot; /&gt;&lt;/p&gt;

&lt;p&gt;But representative democracy introduces indirection, and it gets out of hand quickly.&lt;/p&gt;

&lt;p&gt;Your elected officials:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Don’t know you&lt;/li&gt;
  &lt;li&gt;Largely don’t benefit from helping you&lt;/li&gt;
  &lt;li&gt;Often come from a different background or ethnicity, which comes with different values &amp;amp; culture&lt;/li&gt;
  &lt;li&gt;Their priorities are very different from yours!&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;An abyss of indirection separate you.&lt;/p&gt;

&lt;p&gt;All you get is a paper vote every few years, and you can protest on the street and argue online.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Indirection is the real reason why politics don’t scale.&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;what-have-we-done-so-far-to-mitigate-these-evils&quot;&gt;What have we done so far to mitigate these evils?&lt;/h2&gt;

&lt;p&gt;The word &lt;strong&gt;“transparency”&lt;/strong&gt; comes up every time 🤔. Surprised?&lt;/p&gt;

&lt;p&gt;It’s not surprising:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;The problem: indirection clouding the evil, making it opaque.&lt;/li&gt;
  &lt;li&gt;The solution: remove the indirection, revealing the evil.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Examples are everywhere:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The &lt;em&gt;indirect&lt;/em&gt; links between tobacco &amp;amp; foods high in added sugar and adverse health effects like &lt;a href=&quot;https://nida.nih.gov/publications/drugfacts/cigarettes-other-tobacco-products&quot;&gt;lung cancer&lt;/a&gt;, &lt;a href=&quot;https://www.nhs.uk/live-well/eat-well/food-types/how-does-sugar-in-our-diet-affect-our-health/&quot;&gt;obesity &amp;amp; diabetes&lt;/a&gt; have been widely established and agreed upon after decades of systematic attempts to deny and hide them (I say “indirect” because the effects take years to materialise). What do governments decide to do? Put health warnings in the packaging, thus removing the indirection.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-tobacco-warning.jpg&quot; alt=&quot;Tobacco Warning&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Panama_Papers&quot;&gt;The Panama Papers&lt;/a&gt;, &lt;a href=&quot;https://en.wikipedia.org/wiki/Paradise_Papers&quot;&gt;The Paradise Papers&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://en.wikipedia.org/wiki/Swiss_Leaks&quot;&gt;The Swiss Leaks&lt;/a&gt; are just a few examples of the long list of whistleblowing efforts to remove the indirection mechanisms allowing the filthy rich from evading taxes and hiding their wealth.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Vegans argue that animal farming is evil. If you agree, this is another good example. In order to increase efficiency, producers need to resort to and &lt;strong&gt;hide&lt;/strong&gt; farms like this one 😱:&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-chicken-farm.png&quot; alt=&quot;Chicken Farm&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;brainstorming-can-we-do-better&quot;&gt;Brainstorming: can we do better?&lt;/h2&gt;

&lt;p&gt;We can steal some ideas from great thinkers.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-the-open-source-everything-manifesto.png&quot; alt=&quot;The Open Source Everything Manifesto&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Robert_David_Steele&quot;&gt;Robert David Steele&lt;/a&gt;, although later quite a controversial figure, was an American CIA officer who wrote a book called &lt;a href=&quot;https://www.goodreads.com/en/book/show/12998524-the-open-source-everything-manifesto&quot;&gt;The Open-Source Everything Manifesto&lt;/a&gt;. In it, he advocates for the transition from top-down secret command and control to a world of bottom-up, consensual, collective decision-making as a means to solve the major crises facing our world today.&lt;/p&gt;

&lt;p&gt;I read this book in 2014, and this idea resonated with me, because I interpreted it as “removing indirection from information-based decision-making”, and letting everyone collaboratively “audit” the World.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-yuval-harari.png&quot; alt=&quot;Yuval Harari&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Very recently, historian &lt;a href=&quot;https://en.wikipedia.org/wiki/Yuval_Noah_Harari&quot;&gt;Yuval Harari&lt;/a&gt; echoed a thought from a &lt;a href=&quot;https://archive.org/details/yuval-noah-harari-at-the-world-economic-forum-in-davos-2020-the-rise-of-digital-&quot;&gt;2020 talk he made at Davos&lt;/a&gt; in a short &lt;a href=&quot;https://www.youtube.com/watch?v=JV9tzdYT5FU&amp;amp;pp=ygUVeXV2YWwgZGljdGF0b3JzaGlwIGFp&quot;&gt;interview with Piers Morgan&lt;/a&gt;, along the lines of: “Alongside inequality, the other major danger we face is the rise of digital dictatorships, that will monitor everyone all the time”.&lt;/p&gt;

&lt;p&gt;This idea of having a self-replicating &lt;a href=&quot;https://en.wikipedia.org/wiki/Agent_Smith&quot;&gt;Agent Smith&lt;/a&gt; keeping every human under control resonated with me as well: if we can use these agents for mind control, can we use them to keep them free from these evils too?&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-cypherpunk.png&quot; alt=&quot;Cypherpunk&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://en.wikipedia.org/wiki/Cypherpunk&quot;&gt;Cypherpunk&lt;/a&gt; movement was a loosely coupled group of computer scientist activists originated in San Francisco in the mid 80s who advocated the use of cryptography and privacy-enhancing technologies to challenge state surveillance and censorship and promote social and political change. Bitcoin and cryptocurrencies came from this movement, or so &lt;a href=&quot;https://en.wikipedia.org/wiki/Arvind_Narayanan&quot;&gt;Arvind Narayanan&lt;/a&gt; taught me in his &lt;a href=&quot;https://www.coursera.org/learn/cryptocurrency&quot;&gt;Bitcoin and Cryptocurrency Technologies&lt;/a&gt; MOOC.&lt;/p&gt;

&lt;p&gt;What a fantastic dream (for a software engineer at least), that a few nerds can team up and have a realistic shot at fixing the World 😍!&lt;/p&gt;

&lt;p&gt;But we need bolder tools 🤔.&lt;/p&gt;

&lt;h2 id=&quot;how-about-leveraging-ai-agents&quot;&gt;How about leveraging &lt;a href=&quot;https://en.wikipedia.org/wiki/Intelligent_agent&quot;&gt;AI agents&lt;/a&gt;?&lt;/h2&gt;

&lt;p&gt;Every day I wake up to a brand new &lt;a href=&quot;https://news.ycombinator.com/&quot;&gt;Hacker News&lt;/a&gt; front page looking for these new activists, these AI-Powered Transparency Warriors.&lt;/p&gt;

&lt;p&gt;How about having a swarm of anonymous AI agents hidden in all corners of the Internet, auditing the World, looking for wrongs to right?&lt;/p&gt;

&lt;p&gt;Sounding much like a &lt;a href=&quot;https://en.wikipedia.org/wiki/The_Terminator&quot;&gt;Terminator&lt;/a&gt;-style dystopia?&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/ai-terminator-dystopia.png&quot; alt=&quot;Terminator Dystopia&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Only that these agents could be open source and community-maintained, and their collaborators could remain anonymous if necessary, much like &lt;a href=&quot;https://en.wikipedia.org/wiki/Satoshi_Nakamoto&quot;&gt;Satoshi Nakamoto&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Not quite viable today, but I’d argue it’s &lt;strong&gt;unavoidable in the long term anyway&lt;/strong&gt;, in one form or another.&lt;/p&gt;

&lt;p&gt;Anybody can sue, publicly denounce or file a complaint against anyone else if they have a good case, so why can’t computers do it? They’ll be better than us at it 🤷‍♂️.&lt;/p&gt;

&lt;p&gt;Since it’s well-studied that &lt;a href=&quot;https://www.imf.org/EXTERNAL/PUBS/FT/ISSUES6/INDEX.HTM&quot;&gt;corruption affects a country’s economic output&lt;/a&gt; and thus, long-term, everyone (unintuitively including the rich) benefits when there’s less corruption, wouldn’t it be in the best interest of governments to deploy these AI auditors?&lt;/p&gt;

&lt;h2 id=&quot;cancel-culture-put-to-good-use&quot;&gt;Cancel culture put to good use&lt;/h2&gt;

&lt;p&gt;The recent &lt;a href=&quot;https://en.wikipedia.org/wiki/Cancel_culture&quot;&gt;Cancel Culture&lt;/a&gt; phenomenon has been widely criticised and with good reasons, but it did bring something new to the table that I hadn’t seen before: &lt;strong&gt;the rich &amp;amp; powerful held accountable and brought down&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Call it &lt;em&gt;vigilante justice&lt;/em&gt;, I don’t care: even if there are false positives, the idea that no army of lawyers nor unlimited bribery resources can save you if you do bad deeds is a deterrent &lt;strong&gt;we all wish existed&lt;/strong&gt;, no?&lt;/p&gt;

&lt;p&gt;This dream is within reach now. I dream of AI Agents keeping the &lt;a href=&quot;https://en.wikipedia.org/wiki/Animal_Farm#Pigs&quot;&gt;Animal Farm pigs&lt;/a&gt; honest.&lt;/p&gt;

&lt;p&gt;How about the Supreme Court judges? The billionaire class? The people who wield tremendous power over others should be held at a higher standard, and if they don’t like it, then they shouldn’t hold it.&lt;/p&gt;

&lt;p&gt;I’d argue that an AI Agent monitoring, discovering &amp;amp; exposing the &lt;a href=&quot;https://en.wikipedia.org/wiki/Enron_scandal&quot;&gt;Enron scandal&lt;/a&gt;, could potentially be just as life-saving as &lt;a href=&quot;https://www.youtube.com/watch?v=bUhFfunT2ds&quot;&gt;FSD&lt;/a&gt;, both at scale.&lt;/p&gt;

&lt;p&gt;Of course, like all else, how do we ensure it doesn’t target a specific agenda?&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;The future I imagine in this post sounds very much like an unrealistic sci-fi musing. But is it, though?&lt;/p&gt;

&lt;p&gt;We can at least all agree that AI will have a growing presence in our daily lives, both at the individual and the societal level.&lt;/p&gt;

&lt;p&gt;I believe that some of our mightiest inventions have served the purpose of enhancing our ability to collaborate as a civilization:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Towns, city-states &amp;amp; kingdoms&lt;/strong&gt;, uniting us under a common flag.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Religion&lt;/strong&gt;, uniting us across regions, under the same beliefs.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Capitalism, globalisation &amp;amp; telecommunications&lt;/strong&gt;, bringing us closer together and making us so dependent on each other that wars became bad business.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;The Internet&lt;/strong&gt;, making all our collective knowledge available to everyone instantly.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Throughout these stages, the “distance” to one another has steadily decreased, but we’re not quite there yet. I argue that the elusive enemy we must defeat is called indirection, and AI agents can be the next stage in our human journey.&lt;/p&gt;

&lt;p&gt;If I had to guess, I’d say the pioneering applications will more likely come from the private sector or from clandestinity. But I don’t know when, or what the form will be. I’m sure it’s coming, though. Soon.&lt;/p&gt;
</description>
        <pubDate>Fri, 28 Jul 2023 00:00:00 +0100</pubDate>
        <link>https://marianogappa.github.io/software/2023/07/28/real-life-indirection-is-the-root-of-all-evil-and-ai-agents-can-fix-it-copy/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2023/07/28/real-life-indirection-is-the-root-of-all-evil-and-ai-agents-can-fix-it-copy/</guid>
      </item>
    
      <item>
        <title>Building Crypto Predictions Tracker: architecture and challenges</title>
        <description>&lt;h2 id=&quot;tldr&quot;&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;During the past year I’ve gotten exposure to the cryptocurrency scene from an investment perspective. A key frustrating aspect of it is that there’s no reliable source of investment advice. I describe this problem in detail on my previous blogpost: &lt;a href=&quot;https://marianogappa.github.io/software/2022/08/25/cryptocurrency-influencers-are-preying-on-millennials-who-found-salvation-in-crypto/&quot;&gt;Cryptocurrency influencers are preying on millennials who found salvation in crypto&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’ve been working on a Go-based project to automatically track cryptocurrency predictions made on social networks like &lt;a href=&quot;https://twitter.com/CryptoKaleo/status/1558313838877057025&quot;&gt;this one&lt;/a&gt; for the last 6 months, as a tool for accountability and influencer reputation. I think the resulting system ended up being pretty neat and it might interest you if you’re a backend engineer. In this blogpost, I’ll define this system and describe its architecture.&lt;/p&gt;

&lt;p&gt;The backend system is available here: &lt;a href=&quot;https://github.com/marianogappa/crypto-predictions&quot;&gt;Crypto Predictions Tracker&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;A frontend to this project is this Twitter account: &lt;a href=&quot;https://twitter.com/crypto_preds&quot;&gt;Crypto Predictions Tracker&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;A key component of building this project was to consume cryptocurrency market data provided by exchanges. I’ve open sourced a library that facilitates this task in a simple and efficient manner. The crypto-candles library is available &lt;a href=&quot;https://github.com/marianogappa/crypto-candles&quot;&gt;on Github&lt;/a&gt; and its construction and features are described on my blogpost: &lt;a href=&quot;https://marianogappa.github.io/software/2022/07/27/10-gotchas-for-building-a-universal-crypto-candlestick-iterator-in-go/&quot;&gt;10 Gotchas for building a universal crypto candlestick iterator in Go&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;

&lt;p&gt;A fundamental problem of available cryptocurrency-related investment advice on the Internet is that there is no track-record anywhere. Consider other businesses:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Before making a hotel or restaurant booking, we can check their rating online on our phones.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Before making a decision on a rental flat or buying a house, we can compare neighbourhood prices and do inspections.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Before choosing an investment fund, we can check &lt;a href=&quot;https://am.jpmorgan.com/us/en/asset-management/adv/tools/portfolio-tools/investment-comparison/&quot;&gt;comparison studies&lt;/a&gt; as well as the historical ROI of the chosen fund itself.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now consider examples of advice given by cryptocurrency influencers, like this one:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-tweet-example-0.png&quot; alt=&quot;Example Tweet&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I’m hoping most of you reading this right now will be thinking: “why would anyone in their right mind follow the investment advice of some dude on the Internet?”. I think so too. However, some of these influencers have more than a million followers! I think it’s fair to assume that advice is being followed galore. For a more exhaustive read of this problem, please read my blogpost: &lt;a href=&quot;https://marianogappa.github.io/software/2022/08/25/cryptocurrency-influencers-are-preying-on-millennials-who-found-salvation-in-crypto/&quot;&gt;Cryptocurrency influencers are preying on millennials who found salvation in crypto&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I don’t think all advice is malintentioned, and even if it was, I don’t think it should be banned or made illegal, the same way that I don’t think smoking, drinking and drugs should be illegal either. However, some form of warning should be available for them, the same way that there are warnings on cigarette packs and ratings on restaurants and hotels. Then, influencers would have a track-record that keeps them honest, and individuals can make informed decisions. But is that possible?&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-tobacco-warning.jpg&quot; alt=&quot;Social Network Posts&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;key-insights-on-feasibility&quot;&gt;Key Insights on feasibility&lt;/h2&gt;

&lt;p&gt;Note how social network posts are particularly well-suited for keeping a track record:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto_social_post.png&quot; alt=&quot;Social Network Posts&quot; /&gt;&lt;/p&gt;

&lt;p&gt;They have:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;a date&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;an owner&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;mostly reasonably un-editable content&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Provided that the content is specific enough, as in the above example, then one could manually go to the exchange’s website every now and then and check the market pair’s last value against the prediction. In most cases, it’s important that the prediction has some deadline: otherwise either we could be checking forever, and besides there’s little value on a prediction that can only become true eventually, but never times out and becomes false.&lt;/p&gt;

&lt;p&gt;If this can be done manually, can it be automated?&lt;/p&gt;

&lt;p&gt;Yes! All exchanges (mostly) provide free APIs to consume current and historical market pair data. Social networks also &lt;del&gt;have free APIs to consume public post metadata&lt;/del&gt; (thank you &lt;a href=&quot;https://techcrunch.com/2023/02/01/twitter-to-end-free-access-to-its-api/&quot;&gt;Twitter&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://techcrunch.com/2023/04/18/reddit-will-begin-charging-for-access-to-its-api/&quot;&gt;Reddit&lt;/a&gt;).&lt;/p&gt;

&lt;h2 id=&quot;automating-the-system&quot;&gt;Automating the system&lt;/h2&gt;

&lt;p&gt;At a high level, automating tracking for one prediction looks like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-system-diagram.png&quot; alt=&quot;Crypto Predictions System Diagram&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Manually input the prediction metadata (e.g. who predicts, which market pair, by when, prediction condition) as an object/struct in memory.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Every minute or so, ask the exchange for the current last price of the market pair.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Upon receiving the new price, check if the prediction condition was met.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If condition met, prediction became true!&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If condition stays false until deadline, prediction became false!&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;a-million-caveats&quot;&gt;A million caveats&lt;/h2&gt;

&lt;p&gt;While the above looks very simple, every bullet point is trickier than it looks, even before introducing architectural considerations.&lt;/p&gt;

&lt;p&gt;Here are some illustrative examples:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;A prediction should ideally specify which exchange it is for. There is no one value for a given market pair, that is, the last price of Bitcoin against Tether can differ between the Binance exchange and the Coinbase exchange at the same timestamp, because the last price is defined by the order book, and different exchanges have different order books! This causes two problems: (1) this system must implement ALL exchange APIs, and (2) predictions that don’t specify exchange cannot really be tracked accurately, although in practice some assumptions are reasonable.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Social networks don’t reveal the timezone of post authors, authors don’t specify which timezones they make their predictions for, and cryptocurrency influencers typically travel around a lot, so prediction deadlines are imprecise. The closer the deadline, the least precise is the tracking of the prediction.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;In practice, &amp;gt;80% of predictions are surprisingly homogeneous and simple in structure, in the form: “Coin against Stablecoin will reach Value by Deadline”. But for some outliers, the discussed algorithm of a prediction being false until it becomes true or times out doesn’t work. For example, consider this one: “Ethereum won’t reach 3000 until December”.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;It would be very lucky if the system would always catch fresh predictions made just now, but in practice the system will input predictions made some time in the past, so old predictions have to “catch up to the present” by checking the evolution of price since the start of the prediction timestamp, to now. The API endpoints for historical prices and current prices are separate.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The last price for a market pair changes with every filled order. On an exchange with a very high volume of transactions, several hundreds of orders could be filled every second. Checking the condition for every order would be the most accurate way to evaluate the prediction, because in theory there could be a very short period of very high price volatility in which the prediction briefly becomes true, and we might miss this fact in an averaged bucket of orders. In practice, this would be unfeasible, especially if we’re planning to do it for more than a single prediction.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;architectural-building-blocks&quot;&gt;Architectural building blocks&lt;/h2&gt;

&lt;p&gt;At a minimum, these components are going to be required:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions -diagram-blogpost-1.png&quot; alt=&quot;Architecture&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Database: each prediction contains some metadata (e.g. who, what, when) and some state (e.g. last recorded price and when, status of prediction). This data should survive restarts and evolve in atomic steps.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Market requester: predictions evolve upon evaluating market data, so the system needs a component that knows how to talk to all Exchange APIs.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Social Network requester: predictions are created upon consuming social network post metadata (e.g. who, what, when), so the system needs a component that can request post metadata from e.g. Twitter.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Back Office: a minimal frontend to &lt;a href=&quot;https://en.wikipedia.org/wiki/Create,_read,_update_and_delete&quot;&gt;CRUD&lt;/a&gt; predictions, and to see what happens to them.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Cron: a process that will evolve active predictions at regular intervals, with the newest market data.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If we want the system to be useful to a larger population than just its creator, two extra components become relevant:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Frontend: some UI to display the information created, like a website. It could also be some report export function.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;API: since now there are three components reading data (Cron, Back Office and Frontend), and potentially the Frontend could be consumed by untrusted clients, it becomes important to have a unified interface for managing access to that data.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;architectural-challenges&quot;&gt;Architectural challenges&lt;/h2&gt;

&lt;h4 id=&quot;implementing-support-for-arbitrary-predictions&quot;&gt;Implementing support for arbitrary predictions&lt;/h4&gt;

&lt;p&gt;A prediction post can be as simple as “Bitcoin will be worth 100K in 2022!” which can be normalized (with some assumptions) to: “BTC against USDT (Tether) in the Binance exchange (spot market as opposed to some other derivatives market) will be greater than or equal to $100,000 within the post’s timestamp and the first second of Jan 1st, 2023”. That prediction cannot become false before end of year.&lt;/p&gt;

&lt;p&gt;As it turns out, 80% or more of the predictions are as simple as that example. Considering the most popular cryptocurrency influencers, there are mostly only a few prediction patterns in total.&lt;/p&gt;

&lt;p&gt;Sometimes, an influencer will make their “next run predictions” like so:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-tweet-example-1.png&quot; alt=&quot;Example Tweet&quot; /&gt;&lt;/p&gt;

&lt;p&gt;If we want to support that, we need to add boolean operator support over the initial implementation.&lt;/p&gt;

&lt;p&gt;It’s quite common to see a pattern of “If a cryptocurrency falls below X, it will go all the way down to Y”. For example:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-tweet-example-2.png&quot; alt=&quot;Example Tweet&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This prediction has two steps: a “prerequisite” which “enables” the prediction, and the prediction itself. If the “prerequisite” is not met, then the prediction is not false but “annulled”. Often, these predictions cannot be input because they lack specific deadlines.&lt;/p&gt;

&lt;p&gt;Finally, some predictions become true if a condition is true until a deadline, like this one:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto-predictions-tweet-example-3.png&quot; alt=&quot;Example Tweet&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This prediction breaks the model in which a prediction is false unless it becomes true before some deadline.&lt;/p&gt;

&lt;p&gt;There are more edge cases, but they are less common, so I won’t mention them here. I’ve implemented support for many of these patterns and others, and in my experience the problem is not at all the coding &amp;amp; testing involved: the real issue is the UI for inputting and for showing the status of predictions. Rather than providing so much flexibility, it works a lot better to offer a few pre-baked templates, and enable UI support for those.&lt;/p&gt;

&lt;h4 id=&quot;requesting-market-data&quot;&gt;Requesting market data&lt;/h4&gt;

&lt;p&gt;Predictions posted online tend to follow market trends, so the most popular cryptocurrencies get the most predictions, somewhat following the &lt;a href=&quot;https://en.wikipedia.org/wiki/Pareto_principle&quot;&gt;80/20 Pareto principle&lt;/a&gt;. This means that, if we have 100 predictions and we evolve them every minute, we’re gonna be making a lot of identical requests to the exchange’s APIs. This is not just very inefficient but also unlikely to last long, because as the number of predictions grow, very soon the exchange’s APIs will ban our IPs and ask us to enhance our calm.&lt;/p&gt;

&lt;p&gt;The simplest solution to this problem is to cache market responses. In theory, this makes perfect sense, since one wouldn’t expect historical market data to change. In practice, this is almost true, but one should be careful to consider some received data point “final”, since very recent data might be “still getting aggregated”, and exchanges do not clarify if a data point is final or not. A mitigation is to not consume very recent data points.&lt;/p&gt;

&lt;p&gt;Note that the caching component is very valuable, but in a very small window of time. It’s not common to need to request old data, because most predictions are about future deadlines. Thus, it’s not necessary to build a full-fledged solution for caching.&lt;/p&gt;

&lt;h4 id=&quot;storing-predictions-and-evolving-them&quot;&gt;Storing predictions and evolving them&lt;/h4&gt;

&lt;p&gt;Predictions are esentially state machines, and they have two parts: metadata (e.g. author, deadline, conditions), and state (e.g. last timestamp requested for each market pair, status of condition(s) that compose the prediction).&lt;/p&gt;

&lt;p&gt;Only the state part evolves over time. On each evolution step, one needs to request the latest data points for the involved market pairs, re-evaluate the prediction condition(s) and possibly change the status of it to “correct”/”incorrect”.&lt;/p&gt;

&lt;p&gt;Further, out of the database of predictions, only a subset evolves: the active predictions. However, the state part of all active predictions must be updated every time. This write pattern suggests using some in-memory layer before reaching the durable store to alleviate disk pressure and latency, although then if someone kicks the power cable progress is lost.&lt;/p&gt;

&lt;p&gt;Of course, for a small project that is just starting up and where cost is a major concern, a batch update statement on a small Postgres instance is more than enough. In order to set up the project for growth, we can just hide the storage layer implementation details behind a simple interface.&lt;/p&gt;

&lt;h4 id=&quot;predictions-tend-to-have-a-common-deadline&quot;&gt;Predictions tend to have a common deadline&lt;/h4&gt;

&lt;p&gt;End of year, end of month, or whenever a big event will take place (e.g. whenever the &lt;a href=&quot;https://www.investopedia.com/terms/c/consumerpriceindex.asp&quot;&gt;CPI&lt;/a&gt; is going to be announced, whenever &lt;a href=&quot;https://www.investopedia.com/bitcoin-halving-4843769&quot;&gt;the halving&lt;/a&gt; happens) are very common instants for predictions. This is absolutely fine in terms of evolving the predictions, but if one plans to trigger some actions like sending out notifications, instant hotspots could be problematic.&lt;/p&gt;

&lt;p&gt;Possible mitigations are to buffer and aggregate notifications, or to cap the amount of notifications that can be sent in a given time period.&lt;/p&gt;

&lt;h2 id=&quot;takeaways-from-tracking-predictions-for-the-last-few-months&quot;&gt;Takeaways from tracking predictions for the last few months&lt;/h2&gt;

&lt;p&gt;A key criticism for this project is that it is pointless to track what influencers say, because no one in their right mind should take their advice when they make their investment decisions. If you share this point of view (like me!), wouldn’t it be useful to be able to answer how often predictions become correct?&lt;/p&gt;

&lt;h4 id=&quot;how-often-do-predictions-become-correct&quot;&gt;How often do predictions become correct?&lt;/h4&gt;

&lt;p&gt;Well, thanks to this project, I can answer that! Results have caveats (e.g. some influencers make more specific predictions than others, averaging results compares apples &amp;amp; oranges because some predictions are bolder than others), but they are definitely not meaningless. Insights will be vague, because the sample is less than a thousand predictions, and it simply hasn’t been that long since I started tracking them.&lt;/p&gt;

&lt;p&gt;Here are the takeaways:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Predictions become correct reliably about 25% of the time.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Deadline matters: prediction correctness drops to 20% when deadline is 4 days or less in the future or more than a month, sweet spot being about two weeks.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;80% of all predictions are made for a deadline earlier than or equal to a month in the future.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Some influencers are definitely more reliable than others.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I don’t want to be thought of as endorsing influencers and I also don’t want to talk without sufficient data, but I can say preliminarly that you should probably ignore specific predictions given by:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;rovercrc&lt;/li&gt;
  &lt;li&gt;trader1sz&lt;/li&gt;
  &lt;li&gt;profit8lue&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And you could listen to (but don’t delegate your financial decisions!!!) specific predictions given by:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;CryptoCapo_&lt;/li&gt;
  &lt;li&gt;IncomeSharks&lt;/li&gt;
  &lt;li&gt;CredibleCrypto&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There are plenty of others, but either they make vague predictions or don’t make enough to make statistically significant conclusions (in a 6 month timeframe).&lt;/p&gt;

&lt;h2 id=&quot;is-there-any-more-value-out-of-this-project&quot;&gt;Is there any more value out of this project?&lt;/h2&gt;

&lt;p&gt;Evidently, the current state of this project is of little relevance to people. Otherwise, the Twitter account would have more followers and my blogs about it would generate more buzz. Personally, I think anyone following a crypto influencer with the intention of following their advice can only benefit from an impartial, automated track-record for them, but this thought-process makes the assumption that human decisions always makes sense. This has been refuted, and it is really confusing to me.&lt;/p&gt;

&lt;p&gt;However, in order to take this project to production I had to build many components that could be used or adapted for other interesting uses.&lt;/p&gt;

&lt;h4 id=&quot;evaluating-paid-subscriptions-that-offer-cryptocurrency-signals&quot;&gt;Evaluating paid subscriptions that offer “cryptocurrency signals”&lt;/h4&gt;

&lt;p&gt;Many individuals or anonymous companies offer a monthly subscription of “cryptocurrency signals”, which are esentially specific predictions. Those services routinely claim that 80%+ of their signals are profitable.&lt;/p&gt;

&lt;p&gt;The only difference between signals and predictions is that signals are not “boolean”, in that they are not “Correct” or “Incorrect”, but instead they have a Profit Margin Ratio, that is, if you action them, you earn or lose a percentage of your investment.&lt;/p&gt;

&lt;p&gt;Nobody has ever done a reliable, transparent evaluation of a Cryptocurrency Signal site. It would be too tricky to build the infrastructure necessary to run it. With the tools I’ve built, it would be very simple to do this.&lt;/p&gt;

&lt;h4 id=&quot;building-datasets-for-data-science-experiments&quot;&gt;Building datasets for data science experiments&lt;/h4&gt;

&lt;p&gt;If you’ve ever reviewed any articles that do research based on market data, you’ll quickly realise that it’s very rare to see any research aggregating data from different exchanges. There is &lt;a href=&quot;https://messari.io/&quot;&gt;Messari&lt;/a&gt;, but I initially implemented it and ended up scrapping it, as I couldn’t get reliable results.&lt;/p&gt;

&lt;p&gt;The library I open sourced for reading market data, &lt;a href=&quot;https://github.com/marianogappa/crypto-candles&quot;&gt;crypto-candles&lt;/a&gt;, is very efficient and has a very simple interface (it builds iterators), so I think it would be ideal for getting data for experiments.&lt;/p&gt;

&lt;p&gt;In general, while there are very good freemium UIs for cryptocurrency data, most notably &lt;a href=&quot;tradingview.com&quot;&gt;TradingView&lt;/a&gt;, there isn’t any good free API for getting market data across exchanges. crypto-candles solves this issue as a library you can import, or a CLI you can call.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;I think that &lt;a href=&quot;https://twitter.com/crypto_preds&quot;&gt;Crypto Predictions Tracker&lt;/a&gt; was a useful, free warning service for people thinking about following the advice of cryptocurrency influencers. But even if it’s not, I really enjoyed building &lt;a href=&quot;https://github.com/marianogappa/crypto-predictions&quot;&gt;its backend&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Unfortunately, &lt;a href=&quot;https://help.heroku.com/RSBRUH58/removal-of-heroku-free-product-plans-faq&quot;&gt;Heroku shut down the dynos&lt;/a&gt; I was using to power the cron and the API (switched to Render which &lt;a href=&quot;https://render.com/pricing&quot;&gt;has a free plan with DB &amp;amp; Cron&lt;/a&gt;), and &lt;a href=&quot;https://techcrunch.com/2023/02/01/twitter-to-end-free-access-to-its-api/&quot;&gt;Twitter restricted their API access&lt;/a&gt;, so it got too cumbersome to support it. I think there’s value that can be repurposed in an eventual iteration.&lt;/p&gt;

&lt;p&gt;Thanks for reading, and I hope you can benefit from the tools and services I created. Good luck!&lt;/p&gt;
</description>
        <pubDate>Sat, 17 Jun 2023 00:00:00 +0100</pubDate>
        <link>https://marianogappa.github.io/software/2023/06/17/building-crypto-predictions/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2023/06/17/building-crypto-predictions/</guid>
      </item>
    
      <item>
        <title>Cryptocurrency influencers are preying on millennials who found salvation in crypto</title>
        <description>&lt;h2 id=&quot;tldr&quot;&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;Wisely investing our savings has always been important, but in the recent inflationary environment it is a must: &lt;strong&gt;if we don’t grow our savings, we lose them&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;In this blog post, I briefly summarise the past &amp;amp; present of investing and then focus on a problem with the recent trend of cryptocurrency investments: the &lt;strong&gt;difficulty of finding reputable advice&lt;/strong&gt; on how to invest.&lt;/p&gt;

&lt;p&gt;Finally, I present an engine I created to keep a track record for cryptocurrency influencers and beyond, starting with a Twitter account called &lt;a href=&quot;https://twitter.com/crypto_preds&quot;&gt;Crypto Predictions Tracker&lt;/a&gt;. Please note that this is a completely-free project I created on my personal time, not a paid service I’m advertising.&lt;/p&gt;

&lt;p&gt;Even if you’re not interested in the tool, I hope this blog post can give you a good summary of the opportunities and dangers of cryptocurrency investments.&lt;/p&gt;

&lt;h2 id=&quot;investing-10-years-ago&quot;&gt;Investing, 10 years ago&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://www.investopedia.com/terms/r/retailinvestor.asp&quot;&gt;Retail investors&lt;/a&gt;, that is, regular people who make investment decisions to grow their savings, traditionally used to have options like:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.investopedia.com/terms/t/termdeposit.asp&quot;&gt;&lt;strong&gt;Term deposits&lt;/strong&gt;&lt;/a&gt;, where they give money to their bank and let them keep it for a term, after which they are guaranteed to receive a little more than they put in.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.investopedia.com/terms/r/realestate.asp&quot;&gt;&lt;strong&gt;Real estate&lt;/strong&gt;&lt;/a&gt;, where they buy a house or a flat and rent it out for some extra income, or they don’t but the property value and/or land value sometimes appreciates over time.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.investopedia.com/terms/i/investment-fund.asp&quot;&gt;&lt;strong&gt;Investment funds&lt;/strong&gt;&lt;/a&gt;, where they make monthly contributions or lump sum contributions to a large pool of money actively managed by an investment firm, with capital at risk but higher rewards than a term deposit. Sometimes, the fund is not actively managed but instead tracks an index. Traditionally, joining an investment fund required an initial capital investment that was too high for the average Joe.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.investopedia.com/articles/basics/09/precious-metals-gold-silver-platinum.asp&quot;&gt;&lt;strong&gt;Buying gold/silver&lt;/strong&gt;&lt;/a&gt; and keeping it in a safe, because historically these appreciate over time.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;Note: I’m ignoring other investment options like starting a small business, to focus on the more passive investment schemes, because I’m talking about retail investors’ savings investment strategy, not entrepreneurs and wealthier people.&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;investing-nowadays&quot;&gt;Investing nowadays&lt;/h2&gt;

&lt;p&gt;In the past few years, though, things have changed dramatically:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Financial institutions started offering no-minimum-investment (or very small) funds, e.g. &lt;a href=&quot;https://www.fidelity.com/mutual-funds/investing-ideas/index-funds&quot;&gt;Fidelity&lt;/a&gt;, &lt;a href=&quot;https://investor.vanguard.com/investment-products/etfs/etf-fees&quot;&gt;Vanguard&lt;/a&gt;, &lt;a href=&quot;https://www.moneyfarm.com/uk/ppc-see-more/?gclid=Cj0KCQjwuuKXBhCRARIsAC-gM0jJa3e6SH-kUP2DCV0maQtHgQfL3zofqWerKiwv9FE7_AC9-sKU_RQaArTwEALw_wcB&quot;&gt;MoneyFarm&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Platforms that allow anyone to directly invest in things like stocks and currency exchange (forex) without a broker have become widespread, e.g. &lt;a href=&quot;https://www.etoro.com&quot;&gt;eToro&lt;/a&gt;, &lt;a href=&quot;https://www.plus500.com&quot;&gt;Plus500&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Cryptocurrencies&lt;/strong&gt;, as speculative assets, also became a thing that anybody can invest in, with only a few clicks on your phone, e.g. &lt;a href=&quot;https://www.binance.com&quot;&gt;Binance&lt;/a&gt;, &lt;a href=&quot;https://www.coinbase.com&quot;&gt;Coinbase&lt;/a&gt;, &lt;a href=&quot;https://crypto.com/&quot;&gt;Crypto.com&lt;/a&gt; and probably even your bank’s phone app.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;cryptocurrencies-as-an-investment-option&quot;&gt;Cryptocurrencies as an investment option&lt;/h2&gt;

&lt;p&gt;Cryptocurrencies like &lt;a href=&quot;https://en.wikipedia.org/wiki/Bitcoin&quot;&gt;Bitcoin&lt;/a&gt;, &lt;a href=&quot;https://en.wikipedia.org/wiki/Ethereum&quot;&gt;Ethereum&lt;/a&gt; and a few others are &lt;strong&gt;particularly attractive as speculative assets&lt;/strong&gt; because:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;In terms of &lt;strong&gt;long-term yield&lt;/strong&gt;: they have consistently appreciated at a ridiculously high rate, dwarfing other options.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;In terms of &lt;strong&gt;taxation&lt;/strong&gt;: there are still plenty of ways to avoid paying any tax when “cashing out”, whereas taxation is a big concern in all other investment options.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;In terms of &lt;strong&gt;accessibility&lt;/strong&gt;: investing in cryptocurrencies is quicker and easier than any other method; just install an app or sign up to a website, give them money, choose what you want to buy and you’re done. Selling, transferring and withdrawing are quick and easy too.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;In terms of &lt;strong&gt;economic outlook&lt;/strong&gt;: a wide range of established institutional leaders agree that cryptocurrency is not “just” a &lt;a href=&quot;https://en.wikipedia.org/wiki/Ponzi_scheme&quot;&gt;Ponzi scheme&lt;/a&gt; and it’s not going away very soon, although it is heavily disputed where does it go from what it is now.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;However, there are also important risks&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Unregulated, uninsured!&lt;/strong&gt;: traditional finance has insurance schemes like &lt;a href=&quot;https://www.fdic.gov/&quot;&gt;FDIC&lt;/a&gt;, and regulates financial institutions, establishing harsh penalties as deterrents against fraud. In the cryptocurrency economy none of this exists, so your “bank” can potentially run away with your money unscathed.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Unprecedented volatility&lt;/strong&gt;: The value fluctuation of even the most established cryptocurrencies is concerningly volatile in the short term. Bitcoin has lost more than &lt;a href=&quot;https://www.cnbc.com/2018/11/26/bitcoin-nears-its-worst-ever-bear-market-down-more-than-80percent-from-the-high.html&quot;&gt;80% of its value from its previous highs&lt;/a&gt; in a relatively short term more than once, including a &lt;a href=&quot;https://www.cnbc.com/2022/06/30/bitcoin-just-had-its-worst-month-in-more-than-a-year.html&quot;&gt;massive downturn recently&lt;/a&gt;. This is unnerving, and something unheard of in traditional finance, for the most part.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Risk of ruin&lt;/strong&gt;: With cryptocurrencies, there is a very real risk of losing everything for more than one reason:&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;The company you rely on to keep your “money” &lt;a href=&quot;https://www.investopedia.com/terms/m/mt-gox.asp&quot;&gt;could be hacked and the funds stolen&lt;/a&gt;, no matter how established.&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;Even if you keep your own wallet, you could be hacked too. Why wouldn’t I hack you? I likely won’t go to jail.&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;You could make poor investment decisions into higher-risk/higher-yield currencies &lt;a href=&quot;https://www.forbes.com/sites/jonmarkman/2022/05/16/cryptos-luna-catastrophe-threatens-conventional-assets/?sh=1ba77d3043cb&quot;&gt;that go all the way from market top #10 to ZERO&lt;/a&gt;.&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;Governments can decide one day that &lt;a href=&quot;https://www.investopedia.com/articles/forex/042015/why-governments-are-afraid-bitcoin.asp&quot;&gt;cryptocurrencies are dangerous and they should outlaw them&lt;/a&gt;, leading to a collapse of the whole ecosystem.&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;millennials--gen-z-choose-cryptocurrency-investments&quot;&gt;Millennials &amp;amp; Gen Z choose cryptocurrency investments&lt;/h2&gt;

&lt;p&gt;If you ask the new generation to weigh the pros and cons stated above, most people will invest in cryptocurrencies.&lt;/p&gt;

&lt;p&gt;Even the least reckless people can see the potential to get on this boat:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Keep to the most reputable platforms&lt;/strong&gt; (and diversify by having 1/3 of the assets on the top 3 platforms)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Buy only the safest currencies&lt;/strong&gt; (and diversify by having 1/3 of the assets on the top 3 currencies)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Keep them for a very long term&lt;/strong&gt; (5+ years) and they should multiplicate their value &lt;a href=&quot;https://www.nasdaq.com/articles/bitcoin-vastly-outperformed-gold-and-sp-500-over-the-past-decade&quot;&gt;by a very large factor&lt;/a&gt;, maybe even 100 times!&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Read the news, and &lt;strong&gt;make minimal adjustments&lt;/strong&gt; necessary as the outlook for platforms &amp;amp; currencies change over time&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Keep some money in the traditional system&lt;/strong&gt;, because there’s always the danger of losing everything&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto_bitcoin_vs_gold_vs_sp500.png&quot; alt=&quot;Bitcoin vs Gold vs S&amp;amp;P500&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;What is the alternative&lt;/strong&gt; here? Work until you’re 65-70 and by the end you &lt;em&gt;might&lt;/em&gt; own a house or a flat, and hope it’s in a decent neighbourhood, although nowadays it’s more likely than not that either the next economic collapse or a climate catastrophe will &lt;a href=&quot;https://www.theguardian.com/money/2022/jul/04/retirement-on-hold-for-uks-over-60s-as-cost-of-living-crisis-bites&quot;&gt;wash those dreams away&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;choosing-an-investment-strategy&quot;&gt;Choosing an investment strategy&lt;/h2&gt;

&lt;p&gt;So, let’s say we’re one of these people. What do we buy? When do we sell? Who’s a good advisor here? Definitely not us. We don’t know anything about cryptocurrencies!&lt;/p&gt;

&lt;p&gt;Disregarding the more reckless or ignorant, most reasonable people would either:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Research a lot, choose an investment strategy and stick with it&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Accept they won’t know better and trusts someone else to make the decisions for them&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Combine both&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;But &lt;strong&gt;finding someone you can trust in the crypto community is a very challenging task&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;In crypto, people can easily profit by giving you advice, which presents a &lt;strong&gt;conflict of interest&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Managed crypto funds are unregulated, so if you don’t choose a reputable one, more likely than not they’re gonna &lt;a href=&quot;https://www.cnbc.com/2022/07/12/founders-of-bankrupt-crypto-hedge-fund-three-arrows-go-missing.html&quot;&gt;disappear with your money&lt;/a&gt;. Sometimes, you can lose most of your money even if they don’t steal it!&lt;/p&gt;

&lt;h2 id=&quot;enter-the-cryptocurrency-influencer&quot;&gt;Enter the “Cryptocurrency Influencer”&lt;/h2&gt;

&lt;p&gt;Recently, social networks have enabled some popular individuals (i.e. “influencers”) to become trusted sources of cryptocurrency advice. Here are some example accounts:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://twitter.com/scottmelker&quot;&gt;Scott Melker&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://twitter.com/Nicholas_Merten&quot;&gt;Nicholas Merten&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://twitter.com/rovercrc&quot;&gt;Crypto Rover&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://twitter.com/TheMoonCarl&quot;&gt;The Moon&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://twitter.com/BigCheds&quot;&gt;Big Cheds&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;These individuals provide frequent and timely news and advice on cryptocurrency investment that you can action immediately, and they are often correct.&lt;/p&gt;

&lt;p&gt;Going deeper into the rabbit hole, there are monthly subscription services offered out there that go from giving you “professional, premium” advice for a fee, or even going as specific as giving you trading “signals”, promising &amp;gt;80% success rate.&lt;/p&gt;

&lt;p&gt;Here are some, but I won’t link you to them for your own good:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Blockchain Whispers premium signals site&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Walsh Wealth Group&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Elite Crypto Signals&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;how-to-distinguish-good-advice-from-bad-advice&quot;&gt;How to distinguish good advice from bad advice?&lt;/h2&gt;

&lt;p&gt;It’s very common for fraudsters to &lt;a href=&quot;https://twitter.com/zachxbt/status/1516129830873583617&quot;&gt;pay influencers to promote their schemes&lt;/a&gt;, and sometimes influencers can even &lt;a href=&quot;https://twitter.com/zachxbt/status/1443583283648872464&quot;&gt;be the fraudsters themselves&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;But not all actors are out there to harm you, and I’m not saying that the ones I mentioned are. There are a few reasons against harming you:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;If an influencer consistently gives poor advice, you’d expect them to lose influence.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If an influencer is exposed in a scam, they could get in trouble. Note that many influencers &lt;a href=&quot;https://twitter.com/BigCheds/status/1557865015411081219&quot;&gt;are anonymous&lt;/a&gt;: this is a red flag.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Morals, ethics, the desire to help people and wanting to keep a reputation do exist: some people, believe it or not, genuinely feel good by helping others and feel bad when hurting others, and they’d rather not be insanely rich if it means giving you bad advice.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So how do we tell a decent influencer from a scammy one?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Research for a few years until you’re so deep in the rabbit hole that you know better?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Trust what your friends follow?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Try them all and see which one is right most of the time?&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In traditional finance, there are &lt;a href=&quot;https://www.imf.org/external/np/leg/amlcft/eng/aml1.htm&quot;&gt;watchdogs&lt;/a&gt;, &lt;a href=&quot;https://am.jpmorgan.com/us/en/asset-management/adv/tools/portfolio-tools/investment-comparison/&quot;&gt;comparison studies&lt;/a&gt;, plenty of &lt;a href=&quot;https://www.investopedia.com/articles/07/ben_graham.asp&quot;&gt;books&lt;/a&gt;, articles and government-regulated advisors that can legally give you financial advice. So far, in the Cryptocurrency World, none of this exists.&lt;/p&gt;

&lt;p&gt;There’s no answer to this section’s title question at the moment, but this needs to be resolved. And, to a degree, it can be.&lt;/p&gt;

&lt;h2 id=&quot;i-propose-a-simple-strategy-a-track-record&quot;&gt;I propose a simple strategy: a track record!&lt;/h2&gt;

&lt;p&gt;Influencers make predictions all the time, and some of these predictions are well-defined and specific enough that they are trackable, only no one is tracking them!&lt;/p&gt;

&lt;p&gt;If influencers had a track record, it would be safer to trust them, and easier to spot bad actors.&lt;/p&gt;

&lt;p&gt;This would benefit everyone:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Followers would have an objective way to evaluate if an influencer is reputable&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Influencers would have a way to build and demonstrate their reputation&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Influencers would be kept honest and would have a deterrent to making reckless predictions&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Tracking cryptocurrency predictions made on social networks and websites &lt;strong&gt;is not only possible but also quite efficient and reliable&lt;/strong&gt;, as long as those predictions are specific enough:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.investopedia.com/tech/190-cryptocurrency-exchanges-so-how-choose/&quot;&gt;Cryptocurrency market exchanges&lt;/a&gt; provide market data (recent and historical) promptly and free of charge &lt;a href=&quot;https://docs.ftx.com/#get-historical-prices&quot;&gt;via APIs&lt;/a&gt;; this data proves if a prediction became true or not.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Social network posts, such as Twitter tweets or Youtube videos are perfect as prediction evidence: they have a date, an owner, and mostly reasonably un-editable content.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto_social_post.png&quot; alt=&quot;Social Network Posts&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The process of turning these social network posts into structured predictions cannot be efficiently automated today, but it can easily be crowdsourced.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The cost of maintaining this whole process of tracking predictions can be cheap, as long as it’s implemented efficiently.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Here’s an example of how this system would work&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Someone spots a prediction made on the Internet, like the image above.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Upon inspecting that the prediction is specific enough, they input it into the system using some Back Office component.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto_back_office.png&quot; alt=&quot;Back Office&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The system then keeps track of it, by regularly looking at market data and letting time pass.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Eventually, the prediction becomes true or false, and the system notifies about this result, keeping a track record of each individual’s predictions.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/crypto_prediction_result.png&quot; alt=&quot;Prediction Result&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;limitations-of-this-idea&quot;&gt;Limitations of this idea&lt;/h2&gt;

&lt;p&gt;Is this system a silver bullet for answering the question of who to trust? Absolutely not!&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Most advice and predictions out there today &lt;a href=&quot;https://twitter.com/CryptoKaleo/status/1557773251933249536&quot;&gt;are not specific enough to be tracked&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Predictions do not all weigh the same; some predictions are &lt;a href=&quot;https://twitter.com/CryptoKaleo/status/1558313838877057025&quot;&gt;very narrow in timeframe, scope and volume&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;You can game the system to maximise prediction correctness&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;It’s totally valid for a decent influencer to fail 10 predictions in a row&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Some of these problems have solutions, and some do not. But it’s still much better to have some form of accountability than to be completely in the dark.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Warning&lt;/strong&gt;: even if this system was good enough, I still wouldn’t recommend simply relying on some &lt;a href=&quot;https://en.wikipedia.org/wiki/Shamanism&quot;&gt;shaman&lt;/a&gt; on the Internet to tell you how to invest. Do your research!&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;I’ve spent the last 6 months building the engine behind the &lt;strong&gt;&lt;a href=&quot;https://twitter.com/crypto_preds&quot;&gt;Crypto Predictions Tracker&lt;/a&gt;&lt;/strong&gt;, during my free time after work.&lt;/p&gt;

&lt;p&gt;There’s much more to the engine behind the Twitter page that can be seen, and it could be extended to various use cases, and consumed in different ways to maximise its utility. I’m planning to write a technical blog post next on the architecture behind it.&lt;/p&gt;

&lt;p&gt;I hope this utility is useful to you as you navigate your investment strategy, but if it isn’t, at least I hope this summary of the crypto &amp;amp; investment space gives you some answers. If nothing else, my journey in building this tool felt like a story worth sharing.&lt;/p&gt;

&lt;p&gt;Good luck!&lt;/p&gt;
</description>
        <pubDate>Thu, 25 Aug 2022 00:00:00 +0100</pubDate>
        <link>https://marianogappa.github.io/software/2022/08/25/cryptocurrency-influencers-are-preying-on-millennials-who-found-salvation-in-crypto/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2022/08/25/cryptocurrency-influencers-are-preying-on-millennials-who-found-salvation-in-crypto/</guid>
      </item>
    
      <item>
        <title>10 Gotchas for building a universal crypto candlestick iterator in Go</title>
        <description>&lt;h2 id=&quot;tldr&quot;&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;I’ve recently open sourced a universal crypto candlestick iterator library in Go called crypto-candles:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/marianogappa/crypto-candles&quot;&gt;https://github.com/marianogappa/crypto-candles&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It’s being used to power the &lt;strong&gt;&lt;a href=&quot;https://twitter.com/crypto_preds&quot;&gt;Crypto Predictions Tracker&lt;/a&gt;&lt;/strong&gt;: the only unbiased, automated accountability watchdog for crypto predictions on the Internet.&lt;/p&gt;

&lt;p&gt;There is no Go library alternative I’ve found, or I would have used it. There are some exchange SDKs, though.&lt;/p&gt;

&lt;p&gt;In this blogpost, I share all the interesting challenges I found while building this library over the past few months.&lt;/p&gt;

&lt;h2 id=&quot;what-is-a-candlestick&quot;&gt;What is a candlestick?&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://www.investopedia.com/terms/c/candlestick.asp&quot;&gt;Candlesticks&lt;/a&gt;, also known as OHLC (i.e. Open, High, Low, Close), Klines and Bucketed Trades, are a way to display the high, low, open, and closing prices of crypto market pairs (and traditional securities) for a specific period.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://www.investopedia.com/thmb/F9Gcg7_Is-0Pj7jILEMe9IIscm0=/660x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/CandlestickDefinition3-a768ecdaadc2440db427fe8207491819.png&quot; alt=&quot;Candlestick&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.tradingview.com/chart/QVMg9Xmj/?symbol=BINANCE%3ABTCUSDT&quot;&gt;Candlestick charts&lt;/a&gt; are a common sight for crypto investors, and they are used to make buy/sell decisions, either manually or via bots or some other automated mechanisms.&lt;/p&gt;

&lt;p&gt;Crypto exchanges like &lt;a href=&quot;https://www.binance.com&quot;&gt;Binance&lt;/a&gt; or &lt;a href=&quot;https://www.coinbase.com/&quot;&gt;Coinbase&lt;/a&gt; expose APIs with market information for all their supported market pairs (e.g. BTC/USDT) and allow you to consume them for free within fair-use limits.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/candlesticks.png&quot; alt=&quot;Candlestick chart&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;what-is-a-crypto-candlestick-iterator&quot;&gt;What is a crypto candlestick iterator?&lt;/h2&gt;

&lt;p&gt;A Crypto Candlestick Iterator is an &lt;a href=&quot;https://en.wikipedia.org/wiki/Iterator_pattern&quot;&gt;iterator&lt;/a&gt; that you construct for:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;a given provider (e.g. Binance, Coinbase)&lt;/li&gt;
  &lt;li&gt;a given market pair (e.g. BTC/USDT)&lt;/li&gt;
  &lt;li&gt;a given starting timestamp (e.g. “2020-07-04T01:02:03Z”, here represented in ISO8601 format)&lt;/li&gt;
  &lt;li&gt;and a given candlestick interval (e.g. minutely, hourly, daily).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Example in crypto-candles:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;candles&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewMarket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Iterator&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;common&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MarketSource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;common&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;COIN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;Provider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;common&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BINANCE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;BaseAsset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;BTC&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;QuoteAsset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;USDT&quot;&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Hour&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Start time&lt;/span&gt;
		&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Hour&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;                   &lt;span class=&quot;c&quot;&gt;// Candlestick interval&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once constructed, calling &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.Next()&lt;/code&gt; on it returns either the next available candlestick in your specified interval, or an error:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	&lt;span class=&quot;n&quot;&gt;candlestick&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A candlestick looks like this when marshalled to JSON:&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;t&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1641096000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;o&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;47329.47&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;46910.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;l&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;46770.23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;h&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;47415.73&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;o&lt;/code&gt;: Open price&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;c&lt;/code&gt;: Close price&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;l&lt;/code&gt;: Low price&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;h&lt;/code&gt;: High price&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;…of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BTC/USDT&lt;/code&gt; market pair&lt;/p&gt;

&lt;p&gt;…on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BINANCE&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;…at the hour spanning from the timestamp &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;t&lt;/code&gt; and up to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;t + candlestickInterval&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;what-does-universal-candlestick-iterator-mean&quot;&gt;What does “universal” candlestick iterator mean?&lt;/h2&gt;

&lt;p&gt;It means that it supports all major exchanges.&lt;/p&gt;

&lt;p&gt;Usually, you use the API or SDK of the exchange you want to use. If you need to use more than one, it gets tricky.&lt;/p&gt;

&lt;h2 id=&quot;whats-the-use-case-for-a-universal-candlestick-iterator&quot;&gt;What’s the use case for a universal candlestick iterator?&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Data for plotting candlestick charts. If you need 2+ exchanges.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Data for backtesting trading strategies. If you need 2+ exchanges.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Data for being a watchdog for influencing statements &lt;a href=&quot;https://twitter.com/rovercrc/status/1539710164697227267&quot;&gt;like this one&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;And with crypto-candles, you get caching, retrying on errors, patching of data gaps and concurrency-safety for free.&lt;/p&gt;

&lt;h2 id=&quot;the-meaty-part-gotchas&quot;&gt;The meaty part: gotchas!&lt;/h2&gt;

&lt;p&gt;Building this library through the months has been a big challenge, and in this section I’ll list all of the important gotchas I’ve found during this process.&lt;/p&gt;

&lt;h3 id=&quot;gotcha-1-not-all-exchanges-provide-historical-candlesticks&quot;&gt;Gotcha 1: Not all exchanges provide historical candlesticks&lt;/h3&gt;

&lt;p&gt;They all provide current prices. Not all provide historicals. Some do in very tricky ways.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;FTX&lt;/strong&gt; does:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;https://ftx.com/api/markets/BTC/USDT/candles?resolution=60&amp;amp;start_time=&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-04-07 00:00:00&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&amp;amp;end_time=&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-04-07 00:02:00&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt; | jq &lt;span class=&quot;s1&quot;&gt;&apos;.result | .[]&apos;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;startTime&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2020-04-06T23:00:00+00:00&quot;&lt;/span&gt;,
	&lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;: 1586214000000,
	&lt;span class=&quot;s2&quot;&gt;&quot;open&quot;&lt;/span&gt;: 7274,
	&lt;span class=&quot;s2&quot;&gt;&quot;high&quot;&lt;/span&gt;: 7281.5,
	&lt;span class=&quot;s2&quot;&gt;&quot;low&quot;&lt;/span&gt;: 7272,
	&lt;span class=&quot;s2&quot;&gt;&quot;close&quot;&lt;/span&gt;: 7281.5,
	&lt;span class=&quot;s2&quot;&gt;&quot;volume&quot;&lt;/span&gt;: 0
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;startTime&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2020-04-06T23:01:00+00:00&quot;&lt;/span&gt;,
	&lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;: 1586214060000,
	&lt;span class=&quot;s2&quot;&gt;&quot;open&quot;&lt;/span&gt;: 7281.5,
	&lt;span class=&quot;s2&quot;&gt;&quot;high&quot;&lt;/span&gt;: 7281.5,
	&lt;span class=&quot;s2&quot;&gt;&quot;low&quot;&lt;/span&gt;: 7277,
	&lt;span class=&quot;s2&quot;&gt;&quot;close&quot;&lt;/span&gt;: 7280,
	&lt;span class=&quot;s2&quot;&gt;&quot;volume&quot;&lt;/span&gt;: 0
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;startTime&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2020-04-06T23:02:00+00:00&quot;&lt;/span&gt;,
	&lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;: 1586214120000,
	&lt;span class=&quot;s2&quot;&gt;&quot;open&quot;&lt;/span&gt;: 7280,
	&lt;span class=&quot;s2&quot;&gt;&quot;high&quot;&lt;/span&gt;: 7280,
	&lt;span class=&quot;s2&quot;&gt;&quot;low&quot;&lt;/span&gt;: 7271.5,
	&lt;span class=&quot;s2&quot;&gt;&quot;close&quot;&lt;/span&gt;: 7274,
	&lt;span class=&quot;s2&quot;&gt;&quot;volume&quot;&lt;/span&gt;: 0
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But on &lt;strong&gt;Huobi&lt;/strong&gt;, &lt;a href=&quot;https://huobiapi.github.io/docs/spot/v1/en/#get-klines-candles&quot;&gt;the docs&lt;/a&gt; say:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;This API doesn’t support customized period, refer to Websocket K line API to get the emurated period value.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Not sure what that means, but I don’t think Websockets do either.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Kraken&lt;/strong&gt; says they do, but they silently ignore their “since” parameter if you go over a very short threshold to the past. Details in &lt;a href=&quot;https://stackoverflow.com/a/48618456/965724&quot;&gt;this Stack Overflow answer&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You can still get them, if you calculate them yourself, by getting all trades and bucketing them yourself. It’s linear time. But you have no control on what &lt;em&gt;n&lt;/em&gt; is, so don’t.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Phemex&lt;/strong&gt; has only a &lt;a href=&quot;https://github.com/phemex/phemex-api-docs/blob/master/Public-Spot-API-en.md#subscribe-kline&quot;&gt;websocket-based “subscribe kline” endpoint&lt;/a&gt;, but only gets you up to 1000 candlesticks to the past. Then you’re stuck with Kraken-style &lt;a href=&quot;https://github.com/phemex/phemex-api-docs/blob/master/Public-Spot-API-en.md#query-trades-history&quot;&gt;Query Trades History endpoint&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;gotcha-2-rate-limiting&quot;&gt;Gotcha 2: Rate limiting&lt;/h3&gt;

&lt;p&gt;All exchanges must have a rate-limiting strategy to prevent malicious or buggy clients from &lt;a href=&quot;https://en.wikipedia.org/wiki/Denial-of-service_attack&quot;&gt;DDoSing&lt;/a&gt; their APIs. Otherwise you’d kill them!&lt;/p&gt;

&lt;p&gt;In general (not always!), they give you an &lt;a href=&quot;https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#429&quot;&gt;HTTP 429 status code&lt;/a&gt; when they want you to enhance your calm. If you don’t, &lt;strong&gt;they IP-ban&lt;/strong&gt; you temporarily.&lt;/p&gt;

&lt;p&gt;In general, candlestick endpoints are “public market data” and don’t require an API Key. But if you get one, they might be more tolerant with rate-limiting.&lt;/p&gt;

&lt;p&gt;On &lt;strong&gt;Binance&lt;/strong&gt;, &lt;a href=&quot;https://binance-docs.github.io/apidocs/spot/en/#general-api-information&quot;&gt;the docs&lt;/a&gt; say that if you ignore the 429s, you get IP banned for 2 minutes, and up to 3 days for repeat offenders. They send a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Retry-After&lt;/code&gt; header on the 429s with how many seconds you should sleep.&lt;/p&gt;

&lt;p&gt;On &lt;strong&gt;Coinbase&lt;/strong&gt;, &lt;a href=&quot;https://docs.cloud.coinbase.com/sign-in-with-coinbase/docs/rate-limiting&quot;&gt;the docs here&lt;/a&gt; and &lt;a href=&quot;https://help.coinbase.com/en/pro/other-topics/api/faq-on-api&quot;&gt;here&lt;/a&gt; say they allow ~3-6 requests per second.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;FTX&lt;/strong&gt; &lt;a href=&quot;https://help.ftx.com/hc/en-us/articles/360052595091-2020-11-20-Ratelimit-Updates&quot;&gt;docs&lt;/a&gt; make no sense. Don’t worry, you’re fine.&lt;/p&gt;

&lt;p&gt;On &lt;strong&gt;Kucoin&lt;/strong&gt;, the docs lie, so you don’t need a link. You’re gonna get 429’d no matter what you do. Just back-off.&lt;/p&gt;

&lt;p&gt;The other ones are fine, more on that later.&lt;/p&gt;

&lt;p&gt;Ideally, don’t make them 429 you. Do this:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Calculate the truncated current minute of your request: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;time.Now().Add(-1 * time.Minute).Truncate(time.Minute)&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Keep track of the last requested minute, and a counter&lt;/li&gt;
  &lt;li&gt;If the current minute of your request equals the last, increment the counter (and reset it if not)&lt;/li&gt;
  &lt;li&gt;If the counter exceeds the exchange’s limits, sleep!&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Don’t use concurrency&lt;/strong&gt; unless:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Every goroutine talks to a different exchange&lt;/li&gt;
  &lt;li&gt;You have a pool of IPs and a proxy, and every goroutine talks to a separate (exchange, IP) tuple&lt;/li&gt;
  &lt;li&gt;You’re willing to mutex the hell out of your code&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;gotcha-3-some-exchanges-dont-respect-their-rate-limit-documentation&quot;&gt;Gotcha 3: Some exchanges don’t respect their rate limit documentation&lt;/h3&gt;

&lt;p&gt;You’re following the rules? The rules are wrong.&lt;/p&gt;

&lt;p&gt;On &lt;strong&gt;Kucoin&lt;/strong&gt;, &lt;a href=&quot;https://docs.kucoin.com/#request-rate-limit&quot;&gt;the docs&lt;/a&gt; say that they allow an IP to make 10 requests per second. They don’t. There are &lt;a href=&quot;https://www.reddit.com/r/kucoin/comments/q5blef/api_ratelimits_problems/&quot;&gt;many&lt;/a&gt;, &lt;a href=&quot;https://www.reddit.com/r/kucoin/comments/q40ode/whats_the_request_rate_limit/&quot;&gt;Reddit&lt;/a&gt;, &lt;a href=&quot;https://www.reddit.com/r/kucoin/comments/lmdld9/kucoin_api_limits/&quot;&gt;links&lt;/a&gt; out there with people fuming about their aggressive undocumented rate limiting practices.&lt;/p&gt;

&lt;p&gt;On &lt;strong&gt;Bitfinex&lt;/strong&gt;, &lt;a href=&quot;https://docs.bitfinex.com/docs/requirements-and-limitations&quot;&gt;the docs&lt;/a&gt; say they allow 10-90 requests per minute, but I ran this script that made ~140 requests per minute for many minutes and I cannot get it to rate limit me:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;while [ TRUE ]; do echo $(curl &quot;https://api-pub.bitfinex.com/v2/candles/trade:1m:tBTCUSD/hist?limit=3&amp;amp;sort=1&amp;amp;start=1564774820000&quot; | jq .); done
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;gotcha-4-candlestick-data-may-be-incomplete&quot;&gt;Gotcha 4: Candlestick data may be incomplete&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.cloud.coinbase.com/exchange/reference/exchangerestapi_getproductcandles&quot;&gt;Coinbase docs&lt;/a&gt; explicitly say there are gaps in the data. And it’s true. More often in the 1 minute interval.&lt;/p&gt;

&lt;p&gt;Problems it causes:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;You’re plotting a chart. Is it ok to leave a gap in it?&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;You’re sending candlesticks to something. The receiving end hardcodes the timestamp to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;startTimestamp + i * interval&lt;/code&gt;. Bug.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;You’re backtesting a strategy. Your bot receives a candlestick with price 0 (or a gap) and freaks out. Bug.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Possible solution: fill gaps by cloning previously known prices. Doesn’t work if the gap is at the start.&lt;/p&gt;

&lt;h3 id=&quot;gotcha-5-you-wont-get-the-starting-candlestick-time-you-asked-for&quot;&gt;Gotcha 5: You won’t get the starting candlestick time you asked for&lt;/h3&gt;

&lt;p&gt;The final boss! Trickiest gotcha.&lt;/p&gt;

&lt;p&gt;You request candlesticks starting at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2020-07-04T01:02:03Z&lt;/code&gt;. But you won’t get that starting timestamp.&lt;/p&gt;

&lt;p&gt;Exchanges snap your starting time to the data they have, and they &lt;em&gt;mostly&lt;/em&gt; do the same. &lt;em&gt;Mostly&lt;/em&gt;.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;For 1m interval: they will mostly start at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2020-07-04T01:03:00Z&lt;/code&gt; (i.e. the next minute).&lt;/li&gt;
  &lt;li&gt;For 1h interval: they will mostly start at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2020-07-04T02:00:00Z&lt;/code&gt; (i.e. the next hour).&lt;/li&gt;
  &lt;li&gt;For 1d interval: they will mostly start at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2020-07-05T00:00:00Z&lt;/code&gt; (i.e. the next day).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You get the point. Do this:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	&lt;span class=&quot;n&quot;&gt;snapTime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;startTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Truncate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;FTX&lt;/strong&gt; for minutely candlesticks:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;https://ftx.com/api/markets/BTC/USDT/candles?resolution=60&amp;amp;start_time=&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTC &lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04 00:00:33&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&amp;amp;end_time=&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTC &lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04 00:03:33&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt; | jq &lt;span class=&quot;s1&quot;&gt;&apos;.result | .[] | .startTime&apos;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04T00:01:00+00:00&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04T00:02:00+00:00&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04T00:03:00+00:00&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Bitstamp&lt;/strong&gt; is the only one that snaps to the past, here on minutely:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;https://www.bitstamp.net/api/v2/ohlc/btcusd/?limit=3&amp;amp;step=60&amp;amp;start=&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTC &lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04 00:00:33&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; | jq &lt;span class=&quot;s1&quot;&gt;&apos;.data.ohlc | .[] | .timestamp | tonumber | todate&apos;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04T00:00:00Z&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04T00:01:00Z&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04T00:02:00Z&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What about intervals that are not divisors of 24-hour, e.g. 5-hour? They don’t support them!&lt;/p&gt;

&lt;p&gt;And don’t get me started on weekly. Some support weekly. It’s important.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Binance&lt;/strong&gt; &amp;amp; &lt;strong&gt;Bitfinex&lt;/strong&gt; work with the same truncation strategy:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	&lt;span class=&quot;n&quot;&gt;tm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RFC3339&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;2020-07-04T01:02:03Z&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;24&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Hour&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;snap&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Truncate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which produces: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2020-07-06T00:00:00Z&lt;/code&gt;. Let’s see if it’s true:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;https://api.binance.com/api/v3/klines?symbol=BTCUSDT&amp;amp;interval=1w&amp;amp;limit=3&amp;amp;startTime=&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTC &lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04 01:02:03&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s000&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;| jq &lt;span class=&quot;s1&quot;&gt;&apos;.[] | .[0] | . / 1000 | todate&apos;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-06T00:00:00Z&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-13T00:00:00Z&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-20T00:00:00Z&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Kucoin&lt;/strong&gt; snaps to Thursdays, and don’t ask me why!&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;FTX&lt;/strong&gt; is a unique case. They support 1-day, 2-day, …, 30-day. On these, they snap your timestamp to next day (or same if it’s already start of day), and then give you multiples starting on that day. Here’s an example:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;https://ftx.com/api/markets/BTC/USDT/candles?resolution=259200&amp;amp;start_time=&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTC &lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-07-04 01:02:03&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&amp;amp;end_time=&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTC &lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2020-07-10 00:00:00&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%s&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt; | jq &lt;span class=&quot;s1&quot;&gt;&apos;.result | .[] | .startTime&apos;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-05T00:00:00+00:00&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-07T00:00:00+00:00&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;2020-07-10T00:00:00+00:00&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;gotcha-6-order-of-returned-candlesticks-varies-across-exchanges&quot;&gt;Gotcha 6: Order of returned candlesticks varies across exchanges&lt;/h3&gt;

&lt;p&gt;Most exchanges return &lt;em&gt;ascending&lt;/em&gt; order candlesticks. &lt;strong&gt;Coinbase&lt;/strong&gt; and &lt;strong&gt;Kucoin&lt;/strong&gt; return &lt;em&gt;descending&lt;/em&gt;. &lt;strong&gt;Bitfinex&lt;/strong&gt; returns &lt;em&gt;descending&lt;/em&gt; by default, but can be changed.&lt;/p&gt;

&lt;p&gt;Just reverse them. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;O(n)&lt;/code&gt; time, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;O(1)&lt;/code&gt; space:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;candles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;candles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;candles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;candles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;candles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;gotcha-7-exchanges-silently-ignoring-arguments&quot;&gt;Gotcha 7: Exchanges silently ignoring arguments&lt;/h3&gt;

&lt;p&gt;From Gotcha #1: &lt;strong&gt;Kraken&lt;/strong&gt; ignores the “since” parameter.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;FTX&lt;/strong&gt; is dangerous. In &lt;a href=&quot;https://docs.ftx.com/#get-historical-prices&quot;&gt;the FTX request&lt;/a&gt;, you provide a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;start_time&lt;/code&gt; and an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;end_time&lt;/code&gt; for historical prices.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;if &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;end_time&lt;/code&gt; is not specified, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;start_time&lt;/code&gt; is ignored silently and recent data is returned.&lt;/li&gt;
  &lt;li&gt;if the range between &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;start_time&lt;/code&gt; &amp;amp; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;end_time&lt;/code&gt; is too broad, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;start_time&lt;/code&gt; will be pushed forward until the range spans 1500 candlesticks.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;gotcha-8-invalid-market-pairs&quot;&gt;Gotcha 8: Invalid market pairs&lt;/h3&gt;

&lt;p&gt;You can’t request candlesticks for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;INVALID/USDT&lt;/code&gt;. But all exchanges tell you this differently.&lt;/p&gt;

&lt;p&gt;HTTP status codes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Bitstamp&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;404&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Kucoin&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;200&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Binance&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;400&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;FTX&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;404&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Coinbase&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;404&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Bitfinex&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;200&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;HTTP Payloads:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Bitstamp&lt;/strong&gt;: no payload&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Kucoin&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{&quot;code&quot;: &quot;400100&quot;, &quot;msg&quot;: &quot;This pair is not provided at present.&quot;}&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Binance&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{&quot;code&quot;: -1121, &quot;msg&quot;: &quot;Invalid symbol.&quot;}&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;FTX&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{&quot;success&quot;: false, &quot;error&quot;: &quot;No such market: INVALID/USDT &quot;}&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Coinbase&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{&quot;message&quot;: &quot;NotFound&quot;}&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Bitfinex&lt;/strong&gt;: no payload&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Bitfinex&lt;/strong&gt; is the worst. It’s hard to tell it’s an invalid market pair. It could be that there are no new candlesticks, because your starting time is too recent.&lt;/p&gt;

&lt;h3 id=&quot;gotcha-9-requesting-the-most-recent-candlesticks&quot;&gt;Gotcha 9: Requesting the most recent candlesticks&lt;/h3&gt;

&lt;p&gt;Be careful! Exchanges mostly don’t care if you ask for non-historical starting times.&lt;/p&gt;

&lt;p&gt;Here’s &lt;strong&gt;Binance&lt;/strong&gt; returning &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;200 OK&lt;/code&gt; with the 3-minute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BTC/USDT&lt;/code&gt; candlesticks for the year &lt;strong&gt;2286&lt;/strong&gt;!&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;https://api.binance.com/api/v3/klines?symbol=BTCUSDT&amp;amp;interval=3m&amp;amp;limit=60&amp;amp;startTime=9999999999000&quot;&lt;/span&gt; | jq &lt;span class=&quot;s1&quot;&gt;&apos;.&apos;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that if you ask for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;time.Now().Add(-1*time.Hour)&lt;/code&gt;, but for daily candlesticks, your day is not over yet!&lt;/p&gt;

&lt;p&gt;Even if it’s over, how over is it? Race condition! Your exchange hasn’t finalised bucketing the day yet!&lt;/p&gt;

&lt;p&gt;If you plan to cache results, danger zone! Recent candlesticks will change.&lt;/p&gt;

&lt;p&gt;I ran experiments to see in practical terms how much to “lag” to current candlesticks, and put that “patience configuration” in the library.&lt;/p&gt;

&lt;h3 id=&quot;gotcha-10-caching-results&quot;&gt;Gotcha 10: Caching results&lt;/h3&gt;

&lt;p&gt;An iterator has a buffer of results that came from the latest request. That’s all it needs.&lt;/p&gt;

&lt;p&gt;But real-world applications will create multiple iterators. A cache is probably needed there. &lt;a href=&quot;https://en.wikipedia.org/wiki/Pareto_principle&quot;&gt;The 80/20 rule&lt;/a&gt; suggests 80% of created iterators will be for 20% of the options. You can imagine &lt;strong&gt;Binance&lt;/strong&gt;’s &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BTC/USDT&lt;/code&gt; recent hourly candlesticks being popular.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://martinfowler.com/bliki/TwoHardThings.html&quot;&gt;Caching is hard&lt;/a&gt;, but in this case it’s a very sensible architectural choice:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Historical candlesticks should not change (meh, except for Gotcha #9)&lt;/li&gt;
  &lt;li&gt;Each cache hit saves up to ~100 milliseconds in HTTP requests&lt;/li&gt;
  &lt;li&gt;Not making requests minimises rate-limiting issues&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;What about storing cache on filesystem?&lt;/p&gt;

&lt;p&gt;Some exchanges even provide all of their historical data &lt;a href=&quot;https://data.binance.vision/?prefix=data/spot/daily/klines/&quot;&gt;as files&lt;/a&gt;. Great, ~0 requests! But:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Only a few exchanges provide it&lt;/li&gt;
  &lt;li&gt;Cron to download new files, which will break&lt;/li&gt;
  &lt;li&gt;Parsing different file formats for different exchanges&lt;/li&gt;
  &lt;li&gt;Maybe 4-fallback level architecure (i.e. iterator buffer, in-memory cache, filesystem, HTTP request)&lt;/li&gt;
  &lt;li&gt;New challenges (e.g. out-of-disk, permissions, rotating, wholes in data)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;How about just an in-memory &lt;a href=&quot;https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)&quot;&gt;LRU cache&lt;/a&gt;?&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;LRU plays well with 80/20 request distribution&lt;/li&gt;
  &lt;li&gt;Has fixed-size memory (configurable)&lt;/li&gt;
  &lt;li&gt;Inefficient if you restart the process, but a non-invalidating cache scares me; let’s refresh it on restarts&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;I started tinkering with the idea of building this more than a year ago in &lt;a href=&quot;https://github.com/marianogappa/signal-checker/commit/ce6d9faddee7ff6e672d734b6eeb86abb63a5bd3&quot;&gt;this commit&lt;/a&gt; of a different repo, and I still feel like I don’t fully get it.&lt;/p&gt;

&lt;p&gt;Building this has been hard, but very fun too, and rewarding. It’s &lt;a href=&quot;https://en.wikipedia.org/wiki/MIT_License&quot;&gt;MIT licensed&lt;/a&gt; so feel free to use it, profit from it, lose money with my bugs, file issues, contribute improvements, etc. &lt;a href=&quot;https://pkg.go.dev/github.com/marianogappa/crypto-candles&quot;&gt;Docs are here&lt;/a&gt;, but go to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;candles&lt;/code&gt; folder to see most of it.&lt;/p&gt;

&lt;p&gt;I also hope that the &lt;strong&gt;&lt;a href=&quot;https://twitter.com/crypto_preds&quot;&gt;Crypto Predictions Tracker&lt;/a&gt;&lt;/strong&gt; becomes popular, so that influencers get some accountability for their predictions. This is good: it will keep them honest, and improve their reputation.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/KISS_principle&quot;&gt;K.I.S.S.&lt;/a&gt;!&lt;/p&gt;
</description>
        <pubDate>Wed, 27 Jul 2022 00:00:00 +0100</pubDate>
        <link>https://marianogappa.github.io/software/2022/07/27/10-gotchas-for-building-a-universal-crypto-candlestick-iterator-in-go/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2022/07/27/10-gotchas-for-building-a-universal-crypto-candlestick-iterator-in-go/</guid>
      </item>
    
      <item>
        <title>Running Golang on the browser with WebAssembly and TinyGo</title>
        <description>&lt;h2 id=&quot;tldr&quot;&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;This is the story of how I managed to expose my Golang chess API project &lt;a href=&quot;https://github.com/marianogappa/cheesse&quot;&gt;cheesse&lt;/a&gt; as a &lt;a href=&quot;https://webassembly.org/&quot;&gt;WebAssembly&lt;/a&gt; binary, compiled using &lt;a href=&quot;https://tinygo.org/&quot;&gt;TinyGo&lt;/a&gt;, so JavaScript could use it without needing a server.&lt;/p&gt;

&lt;p&gt;The blogpost is optimised for helping others going through a similar exercise, rather than for readability, so expect a little too much of “if this, do this”. Sorry.&lt;/p&gt;

&lt;h2 id=&quot;what-are-all-those-technologies&quot;&gt;What are all those technologies?&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;WebAssembly&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Assembly language of the Web, apparently. All major browsers support it, and the Go compiler supports js/wasm as an OS/ARCH target, so one can write Go code that runs on a webpage, rather than on a server.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;TinyGo&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;It’s a Go compiler optimised for the WebAssembly target (and also for microcontrollers). The key advantage over the official Go compiler is that it generates &lt;em&gt;tiny&lt;/em&gt; binaries. &lt;a href=&quot;https://github.com/golang/go/wiki/WebAssembly#reducing-the-size-of-wasm-files&quot;&gt;Even the Go wiki&lt;/a&gt; recommends using TinyGo.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Cheesse&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Chess API that tells you, e.g.:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;given chess board: what are the possible moves?&lt;/li&gt;
  &lt;li&gt;given a chess board and an action: what does the game look like after?&lt;/li&gt;
  &lt;li&gt;given a chess match in some notation: how does the chess board evolve?&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;whats-the-goal&quot;&gt;What’s the goal?&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;The &lt;em&gt;cheesse&lt;/em&gt; API compiles to a wasm binary, exposing the API to JavaScript without needing a server.&lt;/li&gt;
  &lt;li&gt;It is not necessary to maintain a separate version of the code to compile to this target.&lt;/li&gt;
  &lt;li&gt;The generated wasm binary has a reasonable size for use on the Web.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;exposing-api-to-javascript&quot;&gt;Exposing API to JavaScript&lt;/h2&gt;

&lt;p&gt;Consider one of &lt;em&gt;cheesse&lt;/em&gt;’s basic endpoints:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;ParseGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OutputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You give it a chess game and it spits out all relevant info about it, or an error if input is wrong.&lt;/p&gt;

&lt;p&gt;This is how you expose a function onto the JavaScript global scope:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// This should be in a &quot;main_js.go&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Global&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;ParseGame&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FuncOf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ParseGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Code must not finish&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you don’t do that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;select{}&lt;/code&gt;, or something to that effect, you’ll find this error in the Developer console of your browser:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Error: Go program has already exited
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;mapping-values-from-js-to-go-and-vice-versa&quot;&gt;Mapping values from JS to Go and vice-versa&lt;/h2&gt;

&lt;p&gt;This is the implementation of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ParseGame&lt;/code&gt; function defined above:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ParseGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;og&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ParseGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertToInputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ValueOf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}{&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;outputGame&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertOutputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;og&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Basically just mapping the API’s inputs and outputs to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;js/syscall&lt;/code&gt;’s interfaces.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ParseGame&lt;/code&gt; follows &lt;a href=&quot;https://golang.org/pkg/syscall/js/#FuncOf&quot;&gt;js.FuncOf()&lt;/a&gt;’s interface:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;args&lt;/code&gt; are the arguments supplied to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ParseGame&lt;/code&gt; from JavaScript.&lt;/p&gt;

&lt;p&gt;Here’s a simplified implementation of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;convertToInputGame&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertToInputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InputGame&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;DefaultGame&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jsBool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;defaultGame&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;FENString&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jsString&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fenString&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;jsBool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsUndefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsNull&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;  &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;jsString&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsUndefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsNull&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;convertOutputGame&lt;/code&gt;, it’s trickier. Here’s a very simplified &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OutputGame&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OutputGame&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;FENString&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;         &lt;span class=&quot;s&quot;&gt;`json:&quot;fenString&quot;`&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Actions&lt;/span&gt;   &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OutputAction&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;`json:&quot;actions&quot;`&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OutputAction&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;FromSquare&lt;/span&gt;      &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;`json:&quot;fromSquare&quot;`&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ToSquare&lt;/span&gt;        &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;`json:&quot;toSquare&quot;`&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;How do we map a struct with a slice of structs to something that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;js.ValueOf&lt;/code&gt; can receive? For this, first review &lt;a href=&quot;https://golang.org/pkg/syscall/js/#ValueOf&quot;&gt;the docs&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;func ValueOf(x interface{}) Value

ValueOf returns x as a JavaScript value:

Go                    | JavaScript 
----------------------| -----------
js.Value              | [its value]
js.Func               | function   
nil                   | null       
bool                  | boolean    
integers and floats   | number     
string                | string     
[]interface{}         | new array  
map[string]interface{}| new object 

Panics if x is not one of the expected types.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Go struct =&amp;gt; JS object, so top-layer we must send a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;map[string]interface{}&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The trick is: the map’s values (i.e. the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;interface{}&lt;/code&gt; part) follow the same rules from those docs. That’s how we achieve the nesting.&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertOutputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;og&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OutputGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}{&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;fenString&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;og&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FENString&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;actions&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertOutputActions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;og&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertOutputActions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OutputAction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{},&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertOutputAction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;is&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;convertOutputAction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OutputAction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}{&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;fromSquare&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FromPieceSquare&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;toSquare&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToSquare&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;ok-compile-time&quot;&gt;Ok, compile time!&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;✔ &lt;span class=&quot;nv&quot;&gt;$ GOOS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;js &lt;span class=&quot;nv&quot;&gt;GOARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;wasm go build &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; poc/main.wasm
&lt;span class=&quot;c&quot;&gt;# github.com/marianogappa/cheesse&lt;/span&gt;
./main_js.go:39:6: main redeclared &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;this block
	previous declaration at ./main.go:17:6
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Oh, right. We have two &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main()&lt;/code&gt;. We can use build constraints.&lt;/p&gt;

&lt;p&gt;Put this on the first line of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main.go&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// +build !js

package main
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this on the first line of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main_js.go&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// +build js,wasm

package main
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Don’t forget to leave a &lt;strong&gt;newline&lt;/strong&gt; between the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;//&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;package main&lt;/code&gt;. That’s &lt;a href=&quot;https://golang.org/pkg/go/build/#hdr-Build_Constraints&quot;&gt;not optional&lt;/a&gt; and fails silently.&lt;/p&gt;

&lt;p&gt;Also, don’t do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;+build !js,wasm&lt;/code&gt;. That doesn’t work either. There’s only &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wasm&lt;/code&gt; anyway, right?&lt;/p&gt;

&lt;h2 id=&quot;ok-compile-time-2&quot;&gt;Ok, compile time! #2&lt;/h2&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;✔ $ GOOS=js GOARCH=wasm go build -o poc/main.wasm
✔ $
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;🎉&lt;/p&gt;

&lt;p&gt;Follow &lt;a href=&quot;https://github.com/golang/go/wiki/WebAssembly#getting-started&quot;&gt;these instructions&lt;/a&gt; on how to load the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main.wasm&lt;/code&gt; into an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.html&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;If you try to open the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.html&lt;/code&gt; directly on your browser you’ll get this error on the browser’s Developer Console:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Fetch API cannot load file:///.../poc/main.wasm.
URL scheme must be &quot;http&quot; or &quot;https&quot; for CORS request.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You need to serve the files.&lt;/p&gt;

&lt;h2 id=&quot;serving-the-files&quot;&gt;Serving the files&lt;/h2&gt;

&lt;p&gt;Your favourite one-liner server (is it Python’s &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SimpleHTTPServer&lt;/code&gt; for all of us?), might give you this error:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;TypeError: Response has unsupported MIME type
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You need a server that knows about WebAssembly’s MIME type.&lt;/p&gt;

&lt;p&gt;The easy way:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# install goexec: go get -u github.com/shurcooL/goexec
$ goexec &apos;http.ListenAndServe(`:8080`, http.FileServer(http.Dir(`.`)))&apos;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you really want to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SimpleHTTPServer&lt;/code&gt; there’s a solution that I validated to work &lt;a href=&quot;https://curiousprog.com/2018/10/08/serving-webassembly-files-with-a-development-web-server/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;did-it-work&quot;&gt;Did it work?&lt;/h2&gt;

&lt;p&gt;Yes! 🎉&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/webassembly-tinygo-cheesse.gif&quot; alt=&quot;Working Proof of Concept&quot; /&gt;&lt;/p&gt;

&lt;p&gt;But there’s a catch:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ll &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; main.wasm
&lt;span class=&quot;nt&quot;&gt;-rwxr-xr-x&lt;/span&gt;  1 marianol  staff   7.6M 28 Mar 20:45 main.wasm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I know the Web is bloated, but 7.6MB is not gonna fly.&lt;/p&gt;

&lt;h2 id=&quot;enter-tinygo&quot;&gt;Enter TinyGo&lt;/h2&gt;

&lt;p&gt;Drop-in replacement for the Go compiler, right?&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ tinygo build -o poc/main.wasm -target wasm .
error: requires go version 1.11, 1.12, or 1.13, got go1.14
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ok, that’s not that bad. Go 1.14 is gonna be supported &lt;a href=&quot;https://github.com/tinygo-org/tinygo/pull/901&quot;&gt;soon&lt;/a&gt;, but for now we’ll have to downgrade:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ brew install go@1.13
...
$ echo &apos;export PATH=&quot;/usr/local/opt/go@1.13/bin:$PATH&quot;&apos; &amp;gt;&amp;gt; ~/.bash_profile
...
$ go version
go version go1.13.9 darwin/amd64
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tinygo-round-2&quot;&gt;TinyGo, Round 2!&lt;/h2&gt;

&lt;p&gt;Drop-in replacement for the Go compiler, right?&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tinygo build &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; poc/main.wasm &lt;span class=&quot;nt&quot;&gt;-target&lt;/span&gt; wasm &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# encoding/asn1&lt;/span&gt;
usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:537:47: v.Type&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;.NumMethod undefined &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;reflect.Type has no field or method NumMethod&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:549:14: DeepEqual not declared by package reflect
usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:558:14: DeepEqual not declared by package reflect
usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:479:93: t.Field&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;startingField&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;.Tag.Get undefined &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;string has no field or method Get&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
usr/local/Cellar/go@1.13/1.13.9/libexec/src/encoding/asn1/marshal.go:483:103: t.Field&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;i + startingField&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;.Tag.Get undefined &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;string has no field or method Get&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Oh, God, what’s all this?&lt;/p&gt;

&lt;p&gt;Ok, the thing with TinyGo is that there are many stdlib packages that are not yet supported, so if you must use them then you can’t use TinyGo, unfortunately.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://tinygo.org/lang-support/stdlib/&quot;&gt;https://tinygo.org/lang-support/stdlib/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Some key unsupported packages: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;encoding/json&lt;/code&gt; &amp;amp; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;net/http&lt;/code&gt; (I assume &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;encoding/asn1&lt;/code&gt; is a dependency of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;net/http&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;I was using both. Since I don’t need them for the JS part, the solution is to use a TinyGo-specific build constraint instead of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;// +build !js&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// +build !tinygo&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And vice-versa for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main_js.go&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;tinygo-round-3&quot;&gt;TinyGo, Round 3!&lt;/h2&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ tinygo build -o poc/main.wasm -target wasm .
# github.com/marianogappa/cheesse
main_js.go:102:7: j.IsUndefined undefined (type js.Value has no field or method IsUndefined)
main_js.go:102:26: j.IsNull undefined (type js.Value has no field or method IsNull)
main_js.go:95:7: j.IsUndefined undefined (type js.Value has no field or method IsUndefined)
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unsupported &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;js/syscall&lt;/code&gt; methods?&lt;/p&gt;

&lt;p&gt;Nah, this one is not on TinyGo. We’ve downgraded Go to 1.13.9, so those methods don’t exist anymore.&lt;/p&gt;

&lt;p&gt;Replace all:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsUndefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tinygo-round-4&quot;&gt;TinyGo, Round 4!&lt;/h2&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ tinygo build -o poc/main.wasm -target wasm .
# github.com/marianogappa/cheesse/api
/usr/local/Cellar/tinygo/0.12.0/src/sync/pool.go:14:14 unsupported instruction during init evaluation:
  %23 = inttoptr i32 %22 to %runtime._interface (i8*, i8*)*, !dbg !1864
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Huh?&lt;/p&gt;

&lt;p&gt;Ok, that’s confusing, but it’s something to do with an instruction that runs during an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init()&lt;/code&gt; that indirectly ends up in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sync/pool&lt;/code&gt;, that must be unsupported or something.&lt;/p&gt;

&lt;p&gt;I don’t use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init()&lt;/code&gt;, and &lt;a href=&quot;https://github.com/leighmcculloch/gochecknoinits&quot;&gt;neither should you&lt;/a&gt;. But if you have a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;var&lt;/code&gt; in the global scope (i.e. a global variable) that calls something, then the Go compiler will put that in an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init()&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;You shouldn’t have globals either, but we make some exceptions, and in my case it was like a million error literals like this one:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;errBlackCastle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;impossible for black to castle since king has moved&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It turns out &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fmt.Errorf&lt;/code&gt; ends up calling &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sync/pool&lt;/code&gt;. A brilliant workaround for this one is to replace &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fmt.Errorf&lt;/code&gt; with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;errors.New&lt;/code&gt;. This only works if you have nothing to interpolate, but since it’s a global, you probably don’t.&lt;/p&gt;

&lt;p&gt;If you have other globals that call things, keep the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;var&lt;/code&gt;, but initialise the value in your &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main()&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;tinygo-round-5&quot;&gt;TinyGo: Round 5!&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tinygo build &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; poc/main.wasm &lt;span class=&quot;nt&quot;&gt;-target&lt;/span&gt; wasm &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
inlinable &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;call &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;with debug info must have a &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;dbg location
  call void @runtime.nilPanic&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; undef, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; null&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
inlinable &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;call &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;with debug info must have a &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;dbg location
  %352 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; call fastcc i1 @&lt;span class=&quot;s2&quot;&gt;&quot;github.com/marianogappa/cheesse/api.boolMatcher&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;i32 %351, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; %pack.int217, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; %341, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; undef&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
inlinable &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;call &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;with debug info must have a &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;dbg location
  %353 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; call fastcc i1 @&lt;span class=&quot;s2&quot;&gt;&quot;github.com/marianogappa/cheesse/api.intMatcher&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;i32 %351, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; %pack.int217, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; %341, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; undef&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
inlinable &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;call &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;with debug info must have a &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;dbg location
  %354 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; call fastcc i1 @&lt;span class=&quot;s2&quot;&gt;&quot;github.com/marianogappa/cheesse/api.pieceTypeMatcher&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;i32 %351, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; %pack.int217, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; %341, i8&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; undef&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
error: optimizations caused a verification failure
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;WAT.
Ok, I don’t know. But if you get this, the workaround is to add the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-no-debug&lt;/code&gt; flag to the compile line.&lt;/p&gt;

&lt;h2 id=&quot;tinygo-round-6&quot;&gt;TinyGo, Round 6!&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tinygo build &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; poc/main.wasm &lt;span class=&quot;nt&quot;&gt;-no-debug&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-target&lt;/span&gt; wasm &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OMG, YES! 🎉🎉🎉 Did it work???&lt;/p&gt;

&lt;p&gt;Nope. If you get an error in the Developer Console on your browser, perhaps this one:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;TypeError: import object field &apos;wasi_unstable&apos; is not an Object
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You need to take into account that every compiler you use, and every version of that compiler might have a different companion &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wasm_exec.js&lt;/code&gt;. For TinyGo, do this:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;tinygo &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;TINYGOROOT&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;/targets/wasm_exec.js &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tinygo-round-7&quot;&gt;TinyGo, Round 7!&lt;/h2&gt;

&lt;p&gt;You might do absolutely everything right, get it compiled and then go to your browser’s Developer Console and see this:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;panic: syscall/js: Value.Call: property _makeFuncWrapper is not a function, got undefined [wasm_exec.js:201:19](http://localhost:8000/wasm_exec.js)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That one is this issue:
&lt;a href=&quot;https://github.com/tinygo-org/tinygo/issues/716&quot;&gt;https://github.com/tinygo-org/tinygo/issues/716&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It might be solved by the time you read this, but the workaround at the time of this writing is to switch to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dev&lt;/code&gt; version of TinyGo, which is pretty bleeding edge but seems to work well.&lt;/p&gt;

&lt;p&gt;Follow the &lt;a href=&quot;https://tinygo.org/getting-started/macos/&quot;&gt;Source Install instructions&lt;/a&gt; and change branch before installing.&lt;/p&gt;

&lt;p&gt;Something like:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;brew &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;llvm
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /tmp
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;GO111MODULE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;go get &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; github.com/tinygo-org/tinygo
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$GOPATH&lt;/span&gt;/src/github.com/tinygo-org/tinygo
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git checkout dev
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;go &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tinygo-round-8&quot;&gt;TinyGo, Round 8!&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tinygo build &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; poc/main.wasm &lt;span class=&quot;nt&quot;&gt;-no-debug&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-target&lt;/span&gt; wasm &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Before testing on the browser, remember that you’ve changed the version of TinyGo, so you must copy &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wasm_exec.js&lt;/code&gt; again, only this time the file is in a different place because you’ve built from source:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$GOPATH&lt;/span&gt;/src/github.com/tinygo-org/tinygo/targets/wasm_exec.js &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Did it work???&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/webassembly-tinygo-cheesse.gif&quot; alt=&quot;Working Proof of Concept&quot; /&gt;&lt;/p&gt;

&lt;p&gt;OMG, YES! 🎉🎉🎉&lt;/p&gt;

&lt;h2 id=&quot;one-last-check&quot;&gt;One last check&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ll &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; main.wasm
&lt;span class=&quot;nt&quot;&gt;-rwxr-xr-x&lt;/span&gt;  1 marianol  staff   392K 29 Mar 00:21 main.wasm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;392 KB! That’s an amazing improvement from 7.6MB! 🎉🎉🎉&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Writing Go code for the browser is a reality today. But it’s no picnic. Ideally, we’d write whatever we want, run the Go compiler and get a 1kb npm package or something, right? Well, we’ll get there. Still a better love story than writing JavaScript, aye.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://marianogappa.github.io/cheesse-examples/&quot;&gt;auto-play proof of concept&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/marianogappa/cheesse&quot;&gt;cheesse open source project&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;acknowledgements&quot;&gt;Acknowledgements&lt;/h2&gt;

&lt;p&gt;I didn’t come up with most of the solutions to the issues outlined in this blogpost. This was only possible thanks to the kind and patient help I received from TinyGo’s author &lt;a href=&quot;https://twitter.com/aykevl&quot;&gt;Ayke van Laethem&lt;/a&gt; and contributors &lt;a href=&quot;https://twitter.com/jaddr2line&quot;&gt;Jaden Weiss&lt;/a&gt; and &lt;a href=&quot;https://twitter.com/JohanBrandhorst&quot;&gt;Johan Brandhorst&lt;/a&gt; for hours on end at the #tinygo channel on &lt;a href=&quot;https://invite.slack.golangbridge.org/&quot;&gt;GopherSlack&lt;/a&gt;.
Also, thanks to &lt;a href=&quot;https://twitter.com/_myitcv&quot;&gt;Paul Jolly&lt;/a&gt; for pointing me in the right direction while getting started with WebAssembly.&lt;/p&gt;

</description>
        <pubDate>Wed, 01 Apr 2020 00:00:00 +0100</pubDate>
        <link>https://marianogappa.github.io/software/2020/04/01/webassembly-tinygo-cheesse/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2020/04/01/webassembly-tinygo-cheesse/</guid>
      </item>
    
      <item>
        <title>A chess story</title>
        <description>&lt;p&gt;On the last week of October of 2015, whilst working as a software engineer for the film industry in Auckland, New Zealand, my company announced that we were going to host a full-day “hackathon”. A hackathon is an event in which a large number of people meet to engage in collaborative computer programming.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-hackathon.png&quot; alt=&quot;Chess Story: Hackathon&quot; /&gt;&lt;/p&gt;

&lt;p&gt;My favourite hackathon idea was to come up with a game similar to chess, but with a large board and no turns, that is, a real-time chess World game! I was incredibly excited, so I gathered my dream team of engineers for an impromptu meeting where I pitched the project. Unfortunately, no one liked the idea. The most senior engineer on the team rightfully pointed out that such a project would take months, and we only had 24 hours. I was disappointed, but nowhere near giving up!&lt;/p&gt;

&lt;p&gt;On November 2nd, 2015, I started a timid open source project code-named “ostinato”. Ostinato is an italian noun that plays with the adjective “obstinate”, meaning “stubbornly refusing to change one’s opinion or chosen course of action, despite attempts to persuade one to do so”, which is exactly what this project was all about. At the time, the project was an attempt to build a generic engine for board games:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-initial-commit.png&quot; alt=&quot;Chess Story: Initial commit&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It turned out that making a computer engine for chess was not quite a walk in the park. Over the next 5 months I spent most of my free time working on it; notably the whole Easter long weekend:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-easter.png&quot; alt=&quot;Chess Story: Easter&quot; /&gt;&lt;/p&gt;

&lt;p&gt;By the time the bulk of the development was finished, ostinato was quite a unique project. Sure, there were faster, smarter, more beautiful chess sites available on the Internet, but ostinato was one of the few free and open source tools online that would allow people to input chess matches from a book or a magazine and playing them back on screen, or converting them to different notations.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-converter.png&quot; alt=&quot;Chess Story: Converter&quot; /&gt;&lt;/p&gt;

&lt;p&gt;From a technical standpoint, it is still the only publicly available chess engine I know that works both as a server and standalone within the browser. On March 27th, 2019, I realised that the top Google result for converting chess notations is the ostinato library!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-google.png&quot; alt=&quot;Chess Story: Google&quot; /&gt;&lt;/p&gt;

&lt;p&gt;On September 12th, 2017, I received an email from a 79-year-old man from San Pedro, California whose name was Ken Pauley. In it there was a polite request for fixing a few issues with the conversion from Descriptive to Algebraic Notation. Excited to see traction on a near-abandoned project, I eagerly replied and tried to work out some of the issues pointed out in the email thread.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-ken-email.png&quot; alt=&quot;Chess Story: Ken&apos;s email&quot; /&gt;&lt;/p&gt;

&lt;p&gt;To my surprise, the interactions between Ken and me never stopped. At the time of this writing, we’ve shared 161 email threads in the last 3 years, and have formed quite the long-distance and inter-generational friendship. Some perks of this newfound friendship have included receiving a few treats of Hawaian provenance!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-treats.png&quot; alt=&quot;Chess Story: Treats&quot; /&gt;&lt;/p&gt;

&lt;p&gt;On March 6th, 2019, Ken floated the idea of converting Irving Chernev’s 1962 classic Practical Chess Endings to Algebraic notation. Then on June 20th, 2019, I was asked to be a co-author, to which I agreed.&lt;/p&gt;

&lt;p&gt;Because there is no digitised version of the existing book (although there is an image-only scanned version on Google Books), Ken had to do the complete digitising effort himself, which has been an arduous process.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-arduous.jpg&quot; alt=&quot;Chess Story: Arduous&quot; /&gt;&lt;/p&gt;

&lt;p&gt;However, thanks to the chess engine available and the long hours sitting at the computer, Ken was able to find and fix countless errors in the original publication. In turn, I was able to produce a website counterpart to the book where one can browse through the games by looking at an actual board and watching the endings unfold.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/chess-story-website.png&quot; alt=&quot;Chess Story: Website&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Despite the many lost weekends and the long nights figuring out obscure technical issues, this has been a unique and exciting 5-year experience, and I’m very proud of sharing the unlikely story of how an American aerospace engineer in his 80s and an Argentine software engineer in his 30s with a common passion found each other on the Internet and published a chess book together; a story worth sharing.&lt;/p&gt;
</description>
        <pubDate>Fri, 03 Jan 2020 00:00:00 +0000</pubDate>
        <link>https://marianogappa.github.io/software/2020/01/03/chess-story/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2020/01/03/chess-story/</guid>
      </item>
    
      <item>
        <title>Let&apos;s build a SQL parser in Go!</title>
        <description>&lt;h2 id=&quot;tldr&quot;&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;This article aims to be the simplest introduction to constructing an &lt;a href=&quot;https://en.wikipedia.org/wiki/LL_parser&quot;&gt;LL(1) parser&lt;/a&gt; in Go, in this case for parsing SQL queries. It assumes minimal programming competence (functions, structs, ifs and for-loops).&lt;/p&gt;

&lt;p&gt;Here’s the complete parser repository if you want to skip to results:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/marianogappa/sqlparser&quot;&gt;github.com/marianogappa/sqlparser&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;simplification-disclaimer&quot;&gt;Simplification disclaimer&lt;/h2&gt;

&lt;p&gt;To make things simple we’re gonna descope sub-selects, functions, complex nested expressions and other features that all SQL flavours support. Those features get really involved quickly with the strategy we’re gonna use.&lt;/p&gt;

&lt;h2 id=&quot;1-minute-theory-lesson&quot;&gt;1-minute theory lesson&lt;/h2&gt;

&lt;p&gt;A parser has two parts:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;the Lexical Analysis: a.k.a. the “&lt;a href=&quot;https://en.wikipedia.org/wiki/Lexical_analysis#Tokenization&quot;&gt;Tokeniser&lt;/a&gt;”&lt;/li&gt;
  &lt;li&gt;the Syntactic Analysis: the creation of the &lt;a href=&quot;https://en.wikipedia.org/wiki/Abstract_syntax_tree&quot;&gt;AST&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;lexical-analysis&quot;&gt;Lexical Analysis&lt;/h3&gt;

&lt;p&gt;Let’s define it by example. “Tokenising” the following query:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;users.csv&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Means extracting the “tokens” that form this query. The result of the tokeniser would be something like:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;SELECT&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;FROM&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&apos;users.csv&apos;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;syntactic-analysis&quot;&gt;Syntactic Analysis&lt;/h3&gt;

&lt;p&gt;This part is where we actually look at the tokens, make sure they make sense and interpret them to construct some product &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;struct&lt;/code&gt; that represents the query in a way that is convenient for the application that is gonna use it (e.g. for executing the query, colour highlighting it). After this step, we’d end up with something like:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Select&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;TableName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;users.csv&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Fields&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are a lot of ways in that parsing can fail, so it would be convenient to do the two steps at the same time and stop as soon as something goes wrong.&lt;/p&gt;

&lt;h2 id=&quot;strategy&quot;&gt;Strategy&lt;/h2&gt;

&lt;p&gt;We’ll define a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;parser&lt;/code&gt; that looks like this:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;             &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;// The query to parse&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;               &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;           &lt;span class=&quot;c&quot;&gt;// Where we are in the query&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;           &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;// The &quot;query struct&quot; we&apos;ll build&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;step&lt;/span&gt;            &lt;span class=&quot;n&quot;&gt;step&lt;/span&gt;          &lt;span class=&quot;c&quot;&gt;// What&apos;s this? Read on...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// Main function that returns the &quot;query struct&quot; or an error&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// A &quot;look-ahead&quot; function that returns the next token to parse&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peek&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// same as peek(), but advancing our &quot;i&quot; index&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Intuitively, what we would do first is to “peek() the first token”. In a basic SQL grammar, there are only a few valid initial tokens: SELECT, UPDATE, DELETE, etc; anything else is an error already. The code would look something like:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToUpper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peek&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;SELECT&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;SELECT&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// start building the &quot;query struct&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// TODO continue with SELECT query parsing...&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;UPDATE&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// TODO handle UPDATE&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// TODO other cases...&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;invalid query type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And we can basically fill in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TODO&lt;/code&gt;s and profit! However, the diligent reader will see that the code for parsing the whole &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SELECT&lt;/code&gt; query can get messy really quickly, and we have many types of queries to parse. We’re gonna need some structure.&lt;/p&gt;

&lt;h2 id=&quot;finite-state-machines&quot;&gt;Finite-state Machines&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Finite-state_machine&quot;&gt;FSMs&lt;/a&gt; are a super interesting topic, but we’re not here to get a CS degree. Let’s just focus on what we need.&lt;/p&gt;

&lt;p&gt;At any given point (instead of “point” let’s call it “node”) in our parsing journey, only a few tokens are valid, and upon finding these tokens we advance to new nodes where different tokens are valid, and so on until we finish parsing our query. We can visualise these node relationships as a directed graph:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/sql_parser_graph.png&quot; alt=&quot;SQL Parser Graph&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The node transitions can be defined with a simpler table, though:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/sql_parser_table.png&quot; alt=&quot;SQL Parser Table&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can directly translate this table to a really large switch statement. We’ll use that sneaky &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;parser.step&lt;/code&gt; property we defined before:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;step&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stepType&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// initial step&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;nextToken&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peek&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;step&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stepType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextToken&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UPDATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;UPDATE&quot;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;step&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stepUpdateTable&lt;/span&gt;

      &lt;span class=&quot;c&quot;&gt;// TODO cases of other query types&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stepUpdateSet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stepUpdateField&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stepUpdateComma&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And there we go! Note that some steps might conditionally cycle back to previous ones, like a comma on the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SELECT&lt;/code&gt; field definition. This strategy scales well for basic parsers. As the grammar grows complex, though, the number of states will increase dramatically, so it can get tedious to write. I recommend testing as you code; more on that below.&lt;/p&gt;

&lt;h2 id=&quot;peek-implementation&quot;&gt;Peek() implementation&lt;/h2&gt;

&lt;p&gt;Remember that we need to implement both &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;peek()&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pop()&lt;/code&gt;. Since they do almost the same, let’s use an auxiliary function to keep things &lt;a href=&quot;https://en.wikipedia.org/wiki/Don%27t_repeat_yourself&quot;&gt;DRY&lt;/a&gt;. Also, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pop()&lt;/code&gt; should further advance the index to avoid peeking whitespace.&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peek&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;peeked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peekWithLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peeked&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;peeked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peekWithLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;popWhitespace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peeked&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;popWhitespace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&apos; &apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here’s a list of tokens that we might want to peek:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reservedWords&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;(&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&amp;gt;=&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&amp;lt;=&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;!=&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;=&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&amp;lt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;SELECT&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;INSERT INTO&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;VALUES&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;UPDATE&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;DELETE FROM&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;WHERE&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;FROM&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;SET&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In addition to those, we might come across quoted strings or plain identifiers (e.g. field names). Here’s a hopefully complete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;peekWithLength()&lt;/code&gt; implementation:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;peekWithLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rWord&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reservedWords&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;token&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rWord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;upToken&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToUpper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upToken&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rWord&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upToken&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;upToken&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&apos;\&apos;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;&apos;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Quoted string&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peekQuotedStringWithLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;peekIdentifierWithLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The remaining functions are trivial and left as an exercise to the reader. If you’re curious, the link at the TL;DR section contains the full source code implementation. I intentionally won’t link it again here to add a little indirection.&lt;/p&gt;

&lt;h2 id=&quot;final-validation&quot;&gt;Final validation&lt;/h2&gt;

&lt;p&gt;The parser might find the end of the string before arriving at a complete query definition. It’s probably a good idea to implement a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;parser.validate()&lt;/code&gt; function that looks at the generated “query” struct, and returns an error if it’s incomplete or otherwise wrong.&lt;/p&gt;

&lt;h2 id=&quot;testing&quot;&gt;Testing&lt;/h2&gt;

&lt;p&gt;Go’s table-driven testing pattern lends itself beautifully for our case:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;testCase&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;     &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;// description of the test&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SQL&lt;/span&gt;      &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;// input sql e.g. &quot;SELECT a FROM &apos;b&apos;&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Expected&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;// expected resulting &quot;query&quot; struct&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;      &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;          &lt;span class=&quot;c&quot;&gt;// expected error result&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Example tests:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;testCase&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;s&quot;&gt;&quot;empty query fails&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;Expected&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{},&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;query type cannot be empty&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;s&quot;&gt;&quot;SELECT without FROM fails&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;s&quot;&gt;&quot;SELECT&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;Expected&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;table name cannot be empty&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test the test cases like this:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;testing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Error should have been %v&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Error should have been nil but was %v&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Equal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Unexpected error&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Equal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Expected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;&quot;Query didn&apos;t match expectation&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m using &lt;a href=&quot;https://github.com/stretchr/testify&quot;&gt;testify&lt;/a&gt; because it provides a diff output when the query structs don’t match.&lt;/p&gt;

&lt;h2 id=&quot;going-deeper&quot;&gt;Going deeper&lt;/h2&gt;

&lt;p&gt;This experiment is well-suited for:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Learning LL(1) parser algorithms&lt;/li&gt;
  &lt;li&gt;Custom parsing simple grammars with zero dependencies&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;However, this approach can get tedious and it’s somewhat limiting. Think about how to parse arbitrarily complex compound expressions (e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sqrt(a) = (1 * (2 + 3))&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;For a more powerful parsing model, look into &lt;a href=&quot;https://en.wikipedia.org/wiki/Parser_combinator&quot;&gt;parser combinators&lt;/a&gt;. &lt;a href=&quot;https://godoc.org/golang.org/x/tools/cmd/goyacc&quot;&gt;goyacc&lt;/a&gt; is a popular Go implementation.&lt;/p&gt;

&lt;p&gt;I recommend &lt;a href=&quot;https://www.youtube.com/watch?v=HxaD_trXwRE&quot;&gt;this very interesting talk&lt;/a&gt; by Rob Pike on Lexical Scanning.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.cs.binghamton.edu/~zdu/parsdemo/recintro.html&quot;&gt;Recursive descent parsing&lt;/a&gt; is another parsing approach.&lt;/p&gt;

&lt;h2 id=&quot;why-i-wrote-this&quot;&gt;Why I wrote this&lt;/h2&gt;

&lt;p&gt;Recently, I’ve decided to centralise my data into a repository of CSVs. As a bonus, it’d give me a chance to learn &lt;a href=&quot;https://reactjs.org/&quot;&gt;React&lt;/a&gt; better by creating a UI for &lt;a href=&quot;https://en.wikipedia.org/wiki/Create,_read,_update_and_delete&quot;&gt;CRUD&lt;/a&gt;ing the data. When I had to decide on an interface for communicating CRUD operations between frontend and backend, I felt SQL was a natural language for it (and I already know it well).&lt;/p&gt;

&lt;p&gt;It seems that, although there are many libraries for reading CSV files with SQL, there aren’t many that support write operations (particularly &lt;a href=&quot;https://en.wikipedia.org/wiki/Data_definition_language&quot;&gt;DDL statements&lt;/a&gt;). A colleague recommended me to upload the files into an in-memory &lt;a href=&quot;https://www.sqlite.org/index.html&quot;&gt;SQLite database&lt;/a&gt;, run the SQL and then export to CSV; a fine idea since performance wasn’t at all a concern for me. In the end, I thought to myself: didn’t you always want to write a SQL parser? How hard can it be?&lt;/p&gt;

&lt;p&gt;Turns out writing a (basic) parser is very simple! But I bet it can appear daunting without a good tutorial that is as simple as can be.&lt;/p&gt;

&lt;p&gt;I hope this can be that tutorial for you. &lt;a href=&quot;https://en.wikipedia.org/wiki/KISS_principle&quot;&gt;KISS!&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Wed, 05 Jun 2019 00:00:00 +0100</pubDate>
        <link>https://marianogappa.github.io/software/2019/06/05/lets-build-a-sql-parser-in-go/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2019/06/05/lets-build-a-sql-parser-in-go/</guid>
      </item>
    
      <item>
        <title>We saved $50k/y with a tiny Go microservice coded in a Hackathon</title>
        <description>&lt;p&gt;NOTE: my original blogpost was published &lt;a href=&quot;https://movio.co/en/blog/saving-money-with-Hackathon-project/&quot;&gt;in the Movio blog&lt;/a&gt;. I’ve had to steal it because it went offline for a while, the link sometimes 404s, and they’ve broken some links. I don’t want it to be lost. The following content is unchanged from the original.&lt;/p&gt;

&lt;p&gt;In the past few weeks we’ve rolled out a Go microservice called “KIB” to production, which reduced a huge portion of the infrastructure necessary for &lt;a href=&quot;https://movio.co/en/movio-cinema/&quot;&gt;Movio Cinema&lt;/a&gt;’s core tools: Group Builder and Campaign Execution. In doing this, we saved considerable AWS bills, after-hours and office-hours support bills, significantly simplified our architecture and made our product 80% faster on average. We wrote KIB on a Hackathon.&lt;/p&gt;

&lt;p&gt;Despite the fact that the domain-specific components of this post don’t apply to every dev team, the success of applying the &lt;a href=&quot;https://go-proverbs.github.io/&quot;&gt;guiding principles&lt;/a&gt; of simplicity and pragmatism driving our decision-making process felt like a story worth sharing.&lt;/p&gt;

&lt;h2 id=&quot;group-builder&quot;&gt;Group Builder&lt;/h2&gt;

&lt;p&gt;Movio Cinema’s core functionality is to send targeted marketing campaigns to a cinema chain’s loyalty members. If you’re a member of a big cinema chain’s loyalty program, wherever you are in the world, chances are the emails you’re getting from it come from us.&lt;/p&gt;

&lt;p&gt;Group Builder facilitates the segmentation of loyalty members by the construction of groups of filters of varying complexity over the cinema’s loyalty member base.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/kib_group_builder.png&quot; alt=&quot;Group Builder screenshot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://movio.co/en/blog/category/case-studies/&quot;&gt;Marketing teams around the world&lt;/a&gt; build the perfect audiences for their marketing campaigns using this tool.&lt;/p&gt;

&lt;h2 id=&quot;the-group-builder-algorithm&quot;&gt;The Group Builder algorithm&lt;/h2&gt;

&lt;p&gt;By using this algorithm, an arbitrarily complex set of filters can be solved with a single SQL query. Note that it’s domain-agnostic; you can use this strategy for filtering any set of elements.&lt;/p&gt;

&lt;h3 id=&quot;constraints&quot;&gt;Constraints&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;A Group Builder group can have any number of filters.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Filters can be grouped together in an arbitrary number of sub-groups.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Strictly for UI/UX reasons, sub-groups can be nested only once (i.e. up to sub-sub-groups).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Filters and groups operate against each other using &lt;a href=&quot;https://en.wikipedia.org/wiki/Algebra_of_sets&quot;&gt;Algebra of Sets&lt;/a&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Each filter can either include or exclude set elements, set elements being loyalty members. The UI shows filters as green when they include members, and red when it excludes members.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here’s the SQL strategy&lt;/p&gt;

&lt;p&gt;This would be the final query for the Group Builder UI image above; note that the 3 filter subqueries represent the 3 filters shown in the image:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;loyaltyMemberID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;MAX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;MAX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;MAX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f3&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
                       &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loyaltyMemberID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;…&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Gender&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
                       &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loyaltyMemberID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;…&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Age&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
                       &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loyaltyMemberID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;…&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Censor&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;loyaltyMemberID&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;HAVING&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;f1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;means&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;“&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Include&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;”&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;f2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;means&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;“&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exclude&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;”&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;OR&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;f3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Parens&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;equate&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;subgroups&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UI&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Each sub-query in the UNION section selects the set of loyalty members after applying each filter in the group. The result set of the UNION (before the GROUP BY) will have one row per member per filter. The GROUP BY together with the AGGREGATE FUNCTIONs in the main SELECT section provide a very simple way to replicate the set algebra specified in the Group Builder UI, which you can see cleanly separated in the HAVING section.&lt;/p&gt;

&lt;h2 id=&quot;the-limits-of-mysql&quot;&gt;The limits of MySQL&lt;/h2&gt;

&lt;p&gt;The Group Builder algorithm worked really well in the beginning, but after some customers reached more than 5 million members (and 100 million sales transactions) the queries simply became way too slow to be able to provide timely feedback.&lt;/p&gt;

&lt;p&gt;We needed an option that was fast but didn’t require re-architecting our whole product. That option was &lt;a href=&quot;https://en.wikipedia.org/wiki/InfiniDB&quot;&gt;InfiniDB&lt;/a&gt;. This was 2014.&lt;/p&gt;

&lt;h2 id=&quot;infinidb-a-magic-drop-in-replacement&quot;&gt;InfiniDB: a magic drop-in replacement&lt;/h2&gt;

&lt;p&gt;InfiniDB was a MySQL almost-drop-in replacement that stored data in &lt;a href=&quot;https://en.wikipedia.org/wiki/Column-oriented_DBMS&quot;&gt;columnar format&lt;/a&gt;. As such, and given our queries were rarely involving many fields, our InfiniDB implementation was a big success. We didn’t stop using MySQL; instead we replicated data to InfiniDB in near real-time.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/kib_infinidb_diagram.png&quot; alt=&quot;InfiniDB diagram&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Super-slow groups were fast again! We rolled out our InfiniDB implementation to all big customers and saved the day.&lt;/p&gt;

&lt;h2 id=&quot;the-cons-of-our-implementation-of-infinidb&quot;&gt;The cons of our implementation of InfiniDB&lt;/h2&gt;

&lt;p&gt;Despite the success of our solution, it wasn’t without significant costs:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The InfiniDB instances &lt;a href=&quot;https://github.com/infinidb/infinidb/issues/21&quot;&gt;required a lot of memory and CPU&lt;/a&gt; to function properly, so we had to put them on &lt;a href=&quot;https://aws.amazon.com/ec2/instance-types/i3/&quot;&gt;i3.2xlarge&lt;/a&gt; EC2 instances. This was &lt;a href=&quot;https://www.ec2instances.info/?cost_duration=annually&amp;amp;selected=i3.2xlarge&quot;&gt;very expensive&lt;/a&gt; (~$7k per annum), considering we didn’t charge extra for InfiniDB-powered Movio Cinema consoles.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;InfiniDB didn’t have a master-slave scheme for replication (except for &lt;a href=&quot;https://dba.stackexchange.com/questions/174133/infinidb-replication-and-failover&quot;&gt;this&lt;/a&gt;), so we had to build our own custom one. Unfortunately, table name-swapping sometimes got some tables corrupted and we had to re-bootstrap the whole schema to come back up online, a process that could take several hours.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;We had a &lt;a href=&quot;https://github.com/infinidb/infinidb/issues/3&quot;&gt;recurring bug&lt;/a&gt; where some complex count queries would just return 0 results on InfiniDB, but the same query on MySQL wouldn’t. It was never resolved.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Even though InfiniDB was much faster than MySQL, we still saw some slow running groups for every big customer every week throughout 2017.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The company behind InfiniDB sadly &lt;a href=&quot;http://infinidb.co/forum/important-announcement-infinidb&quot;&gt;had to shutdown&lt;/a&gt; and was eventually &lt;a href=&quot;https://mariadb.com/about-us/newsroom/press-releases/open-source-leader-mariadb-rockets-analytics-market&quot;&gt;incorporated into MariaDB&lt;/a&gt; (now &lt;a href=&quot;https://mariadb.com/products/technology/columnstore&quot;&gt;MariaDB ColumnStore&lt;/a&gt;); this meant no updates nor bugfixes.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;InfiniDB had no substantial community, so it was really hard to troubleshoot any issues. There were only &lt;a href=&quot;https://stackoverflow.com/search?q=infinidb&quot;&gt;120 questions&lt;/a&gt; on StackOverflow at the time of this writing.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;research-time&quot;&gt;Research time&lt;/h2&gt;

&lt;p&gt;During the winter of 2017 we had an upcoming &lt;a href=&quot;https://movio.co/en/blog/Hackathon-August-2017/&quot;&gt;Hackathon&lt;/a&gt;, so three of us decided to do a little research on how to create an alternative solution for Group Builder.&lt;/p&gt;

&lt;p&gt;We found that, even in slow-running groups, most of the filters were relatively simple and fast queries, and retrieving the resulting set of members was incredibly fast as well (~one million per second). The slowness was mostly in the final aggregation step, which could produce billions of intermediate rows on groups with many filters.&lt;/p&gt;

&lt;p&gt;However, a few filters were slow no matter what. Even on fully indexed query execution plans they still had to scan over half a billion rows.&lt;/p&gt;

&lt;p&gt;How could we circumvent these two issues with a simple solution achievable in a day?&lt;/p&gt;

&lt;h2 id=&quot;hackathon-idea-the-kib-project&quot;&gt;Hackathon idea: the KIB project&lt;/h2&gt;

&lt;p&gt;Our solution was:&lt;/p&gt;

&lt;p&gt;1) Reviewing all slow filters for quick wins (e.g. adding/changing indexes, reworking queries)&lt;/p&gt;

&lt;p&gt;2) Running every filter as a separate query against MySQL concurrently, and doing the aggregation programmatically using sparse bitsets&lt;/p&gt;

&lt;p&gt;3) Caching filter results for a number of minutes to minimise the time recalculating long-running queries, given the repetitive usage pattern shown by our customers&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/kib_kib_diagram.png&quot; alt=&quot;KIB diagram&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After the Hackathon, we quickly added two planned features that covered outstanding problematic cases:&lt;/p&gt;

&lt;p&gt;1) Refreshing caches automatically, to make most frequently used filters and slow-running ones very quick at all times.&lt;/p&gt;

&lt;p&gt;2) Pre-caching on startup based on usage history.&lt;/p&gt;

&lt;p&gt;We packed these features into a tiny Go microservice called KIB and shipped it onto a c4.xlarge EC2 instance (&amp;lt;$3k per annum). While before we had one InfiniDB instance on a i3.2xlarge for each customer, in this case we put all customers on the same single c4.xlarge instance.&lt;/p&gt;

&lt;p&gt;We did add a second instance for fault tolerance, and it was a fortunate decision, because that very week our EC2 instance died. Thanks to our &lt;a href=&quot;https://movio.co/en/blog/6-months-kubernetes-production/&quot;&gt;Kubernetes cluster implementation&lt;/a&gt;, the KIB instance quickly restarted on the second healthy node and no customers were impacted. In contrast, when our InfiniDB nodes died, re-bootstrapping would sometimes take hours. Note, however, that this was not an intrinsic problem of InfiniDB itself, but of our custom replication implementation of it.&lt;/p&gt;

&lt;h2 id=&quot;why-go&quot;&gt;Why Go?&lt;/h2&gt;

&lt;p&gt;The long answer to that question is described in &lt;a href=&quot;https://marianogappa.github.io/software/2017/01/25/making-the-move-from-scala-to-go-and-why-were-not-going-back/&quot;&gt;this blogpost&lt;/a&gt;. In short, we’ve been coding in Go for about a year, and it has noticeably reduced our estimations and workload, made our code much simpler, which in turn has indirectly improved our software quality, and in general has made our work more rewarding.&lt;/p&gt;

&lt;p&gt;Here are the key bits of the KIB Go code with only a few details elided:&lt;/p&gt;

&lt;p&gt;An endpoint request represents a Group Builder group to be run, and the group is represented as a tree of SQL queries. It looks somewhat like this:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;N&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SQLNode&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;`json:&quot;node&quot;`&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SQLNode&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;SQL&lt;/span&gt;        &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;    &lt;span class=&quot;s&quot;&gt;`json:&quot;sql&quot;`&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Operator&lt;/span&gt;   &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;    &lt;span class=&quot;s&quot;&gt;`json:&quot;operator&quot;`&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Nodes&lt;/span&gt;      &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SQLNode&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;`json:&quot;nodes&quot;`&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is the function that takes the request and resolves every SQL in the tree to a bitset:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;toBitsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bitsetWr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bitsetWr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;treeRoot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// runs all SQL concurrently&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// waits for all goroutines to finish&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is the inner function that deals with the tree structure; running “solve” on every node:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SQLNode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Nodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// if leaf&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;op&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Operator&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;solve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// runs SQL; fills bitset&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nodes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Nodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// if group&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Nodes&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this is the inner function that runs the SQL (or loads from cache) concurrently:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// returns immediately&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cacheMaybe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// runs SQL or uses cache&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bitset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are about 50 more lines for solving the algebra and 25 more for the basic caching, but these three snippets are a representative example of what the KIB code looks like.&lt;/p&gt;

&lt;p&gt;The snippets show some intermediate concepts: tree traversal, green threads, bitset operations and caching. While not that uncommon, what I’ve rarely seen in practice is an implementation of all these things solving a real business problem within a day’s work. We don’t think we would have been able to pull this off in any other language. I’ll explain why we think so in the conclusion.&lt;/p&gt;

&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;

&lt;p&gt;The results of our project were extremely gratifying.&lt;/p&gt;

&lt;p&gt;In financial terms, we saved $31.000 yearly in AWS bills and $4.000 yearly in after-hours support.
In-office support &amp;amp; maintenance probably costed more than the previous ones combined in the last year, but these are not easily quantifiable in dollar value.
Note that our InfiniDB-based solution has undergone yearly rewrites (we’ve had to rewrite our InfiniDB solution in 2015 and again in 2016 since our original 2014 implementation).
By my calculation, we will save more than $50,000 this year and a similar amount every year going forward.&lt;/p&gt;

&lt;p&gt;In terms of speed, here’s a week-on-week table of results for 9 of our biggest customers (we’ve replaced the actual names with their countries of origin):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/kib_results.png&quot; alt=&quot;Results&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For some customers, this upgrade meant not waiting for Group Builder anymore, as it was the case for this USA customer:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://marianogappa.github.io/images/kib_usa_customer_elapsed_times.png&quot; alt=&quot;Results&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Globally, it was an 81% average improvement in group run times; an average constructed from every single Group Builder group ran on those weeks, not from a sample. That really exceeded our own expectations.&lt;/p&gt;

&lt;p&gt;For us devs, replacing our complex custom replication implementation of InfiniDB that kept us up at night every other week with such a tiny and simple Go microservice we built on a Hackathon is the greatest gift.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;Throughout the Hackathon, we spent the day researching, designing and coding, and no more than half an hour debugging. We didn’t have dependency issues. We didn’t have issues understanding each other’s code, because it looked exactly the same and just as simple. We fully understood the tools we were using, because we have been using the same bare bone building blocks for a year. We didn’t struggle with debugging, because the only bugs we had were silly mistakes that were either found early by the IDE’s linter or clearly explained by the compiler with error messages written for humans. All of this was possible thanks to the Go language.&lt;/p&gt;

&lt;p&gt;KIB is in production today on all major customers, and it’s barely using a few hundred MB of RAM per customer and sharing 4 vCPUs among all of them. Even though we aggressively parallelised SQL query execution and bitset operations, we had no issues at all related to this: no “too many connections” to MySQL, no bugs related to concurrency, etc; not even while writing it. We did have one pointer-related bug and one silly tree traversal edge case; we’re human.&lt;/p&gt;

&lt;p&gt;What’s the lesson learned here? My lesson learned is the power and value of simplicity. Even within the simplicity of Go, we went with the simplest (not the easiest) possible subset of it: we didn’t use channels, interfaces, panics, named returns, iotas, mutexes (we did have one WaitGroup for the one set of goroutines). We only used goroutines and pointers where necessary.&lt;/p&gt;

&lt;p&gt;Thanks for reading this blogpost. KISS!&lt;/p&gt;
</description>
        <pubDate>Mon, 02 Apr 2018 00:00:00 +0100</pubDate>
        <link>https://marianogappa.github.io/software/2018/04/02/we-saved-50ky-with-a-tiny-go-%C2%B5service-coded-in-a-hackathon/</link>
        <guid isPermaLink="true">https://marianogappa.github.io/software/2018/04/02/we-saved-50ky-with-a-tiny-go-%C2%B5service-coded-in-a-hackathon/</guid>
      </item>
    
  </channel>
</rss>
